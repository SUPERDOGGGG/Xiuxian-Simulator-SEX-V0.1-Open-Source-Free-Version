<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ä¿®ä»™æ¨¡æ‹Ÿå™¨ Â· è‹å¤œé›¨ç‰ˆV0.1 </title>
    <style>
        :root{--bg:#0f1116;--panel:#151923;--muted:#9aa3af;--text:#e8ecf1;--accent:#ff69b4;--accent2:#ff7f50;--danger:#ff6b6b;--ok:#a2ff7a;--gap:12px;--r:14px;--shadow:0 8px 24px rgba(0,0,0,.35)}
        *{box-sizing:border-box}body{margin:0;background:radial-gradient(1200px 800px at 80% -10%,rgba(255,105,180,.08),transparent 55%),radial-gradient(900px 600px at -10% 80%,rgba(255,127,80,.07),transparent 50%),var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Helvetica,Arial}
        .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh;gap:var(--gap);padding:14px}
        header,footer{display:flex;align-items:center;gap:var(--gap);background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);padding:10px 12px;backdrop-filter:blur(4px)}
        header{justify-content:space-between}
        .hud{display:flex;gap:var(--gap);align-items:center}
        .block{display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:12px;box-shadow:var(--shadow)}
        .name{font-weight:700}.realm{color:var(--accent)}
        .bar{position:relative;height:12px;background:#1b2030;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}.bar>span{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--a),var(--b))}.danger{--a:#ff8a8a;--b:#ff6b6b}.qi{--a:#ff69b4;--b:#ff1493}.exp{--a:#ffd27a;--b:#ffb74a}.prog{--a:#ff7f50;--b:#ff4500}.degen{--a:#8b0000;--b:#ff0000}
        .layout{display:grid;grid-template-columns:1.05fr .95fr;gap:var(--gap)}
        .panel{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);box-shadow:var(--shadow)}
        .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px;border-bottom:1px dashed rgba(255,255,255,.08)}
        .narrative{display:grid;grid-template-rows:auto 1fr auto;min-height:440px}
        .n-text{padding:14px 16px;overflow:auto;max-height:52vh}
        .choices{display:grid;gap:8px;padding:12px;border-top:1px dashed rgba(255,255,255,.08);background:rgba(0,0,0,.15);border-radius:0 0 var(--r) var(--r)}
        .choice,.btn{appearance:none;border:none;cursor:pointer;padding:8px 10px;border-radius:10px;background:#1a1f2c;border:1px solid rgba(255,255,255,.12);color:var(--text);text-align:left}
        .choice:hover,.btn:hover{border-color:rgba(255,255,255,.24)}
        .pill{padding:6px 10px;border-radius:999px;background:#1a1f2c;border:1px solid rgba(255,255,255,.08);color:var(--muted)}
        .tabs{display:grid;grid-template-rows:auto 1fr}
        .tab-bar{display:flex;gap:8px;padding:10px;border-bottom:1px dashed rgba(255,255,255,.08)}
        .tab-btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#191e2a;color:var(--text)}.tab-btn.active{background:#202636;outline:2px solid rgba(255,105,180,.25)}
        .tab-page{display:none;padding:10px;overflow:auto;max-height:52vh}.tab-page.active{display:block}
        .list{display:grid;gap:6px}.item{display:flex;justify-content:space-between;align-items:center;background:#1a1f2c;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px 10px}
        .toasts{position:fixed;right:16px;top:16px;display:grid;gap:8px;z-index:60}.toast{background:#181d2a;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:10px;box-shadow:var(--shadow)}
        /* Modals */.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}.modal.show{display:flex}
        .dialog{width:min(1020px,96vw);background:#151923;border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:var(--shadow)}.dialog header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08)}.dialog .body{padding:12px 14px}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .attr-panel .dialog{width:min(820px,96vw)}
        .field{display:flex;flex-direction:column;gap:6px}.field input,.field select,.field textarea{background:#1a1f2c;border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:8px;padding:8px}
        /* Battle */.battle-modal .dialog{width:min(1040px,96vw)}.timeline{display:flex;gap:6px;overflow-x:auto;padding:8px;background:#1a1f2c;border:1px solid rgba(255,255,255,.08);border-radius:10px}.chip{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#171c29}.chip.me{outline:2px solid rgba(255,127,80,.25)}.skill-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
        /* Dialogue */.dialogue .dialog{width:min(860px,96vw)}.dlg-log{max-height:260px;overflow:auto;background:#1a1f2c;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}.dlg-choices{display:grid;gap:8px;margin-top:8px}
        /* World Map */.worldmap .dialog{width:min(1100px,96vw)}.map-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}.map-cell{background:#171c29;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;cursor:pointer}.map-cell.current{outline:2px solid rgba(255,105,180,.35)}
        /* Equip */.equip .dialog{width:min(900px,96vw)}.equip-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.slot{display:flex;justify-content:space-between;align-items:center;background:#1a1f2c;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px}
        /* Lust Panel */.lust-panel .dialog{width:min(800px,96vw)}.lust-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.lust-slot{background:#1a1f2c;border:1px solid rgba(255,105,180,.2);border-radius:10px;padding:8px}
        /* Debug */.debug .dialog{width:min(600px,96vw)}.debug-grid{display:grid;gap:8px}
        @media (max-width:980px){.layout{grid-template-columns:1fr}.bar{width:160px}.grid2{grid-template-columns:1fr}}
        
    </style>
</head>
<body>
    <div class="app">
      <header>
        <div class="hud">
          <div class="block"><span class="name" id="name">è‹å¤œé›¨</span><span class="muted">|</span><span class="realm" id="realm">ç»ƒæ°”ä¸€å±‚</span></div>
          <div class="block"><span class="bar-label">HP</span><div class="bar danger" style="width:200px"><span id="hp-bar"></span></div><span id="hp-text" class="pill">0/0</span></div>
          <div class="block"><span class="bar-label">çµåŠ›</span><div class="bar qi" style="width:200px"><span id="qi-bar"></span></div><span id="qi-text" class="pill">0/0</span></div>
          <div class="block"><span id="lv" class="bar-label">Lv.1</span><div class="bar exp" style="width:160px"><span id="exp-bar"></span></div><span id="exp-text" class="pill">0/20</span></div>
          <div class="block" title="è‰³é‡è“„åŠ¿è¿›åº¦"><span class="bar-label">è‰³é‡</span><div class="bar prog" style="width:140px"><span id="rngp-bar"></span></div><span id="rngp-text" class="pill">0%</span></div>
          <div class="block" title="å •è½åº¦"><span class="bar-label">å •è½</span><div class="bar degen" style="width:140px"><span id="degen-bar"></span></div><span id="degen-text" class="pill">0%</span></div>
        </div>
        <div class="hud">
          <div class="block">
            <span class="bar-label">å­˜æ¡£æ§½</span>
            <select id="slot"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
            <button class="btn" id="btn-save">ä¿å­˜</button>
            <button class="btn" id="btn-load">è¯»å–</button>
            <button class="btn" id="btn-export">å¯¼å‡ºJSON</button>
            <label class="btn" for="file-import">å¯¼å…¥JSON</label>
            <input id="file-import" type="file" accept="application/json" hidden />
          </div>
          <div class="block">
            <span class="bar-label">æ—¶é—´</span>
            <select id="time-speed"><option value="manual" selected>æ‰‹åŠ¨</option><option value="slow">æ…¢é€Ÿ</option><option value="normal">æ­£å¸¸</option><option value="fast">å¿«é€Ÿ</option></select>
            <button class="btn" id="btn-next-hour">+1 æ—¶è¾°</button>
            <button class="btn" id="btn-next-day">+1 å¤©</button>
          </div>
          <button class="btn" id="btn-worldmap">å¤§åœ°å›¾ğŸ—ºï¸</button>
          <button class="btn" id="btn-shops">å•†åº—</button>
        </div>
      </header>
      <main class="layout">
        <section class="panel narrative">
          <div class="toolbar">
            <span class="pill">æ—¥æœŸï¼š<b id="date-pill">å…ƒå¹´ æ­£æœˆ åˆä¸€</b></span>
            <span class="pill">å¤©æ°”ï¼š<b id="weather-pill">æ™´</b></span>
            <span class="pill">åœ°ç‚¹ï¼š<b id="loc-pill">â€”</b></span>
            <span class="pill" id="main-hint">ä¸»çº¿ï¼šâ€”</span>
          </div>
          <div id="narrative" class="n-text"></div>
          <div id="choices" class="choices"></div>
        </section>
        <aside class="panel tabs">
          <div class="tab-bar">
            <button class="tab-btn active" data-tab="bag">èƒŒåŒ…ğŸ“¦</button>
            <button class="tab-btn" data-tab="tech">åŠŸæ³•ğŸ“˜</button>
            <button class="tab-btn" data-tab="traits">ç‰¹è´¨</button>
            <button class="tab-btn" data-tab="equips">è£…å¤‡æ </button>
            <button class="tab-btn" data-tab="skills">æŠ€èƒ½</button>
            <button class="tab-btn" data-tab="lust">è‰²æ¬²é¢æ¿â¤</button>
            <button class="tab-btn" data-tab="btn-attrs">å±æ€§</button>
            <button class="tab-btn" data-tab="status">çŠ¶æ€</button>
            <button class="tab-btn" data-tab="quest">ä»»åŠ¡</button>
            <button class="tab-btn" data-tab="people">äººç‰©</button>
            <button class="tab-btn" data-tab="best">æ•Œäºº</button>
            <button class="tab-btn" data-tab="map">åœ°ç‚¹</button>
          </div>
         <div class="tab-page active" id="tab-bag"><div id="bag-list" class="list"></div></div>
          <div class="tab-page" id="tab-tech"><div id="tech-list" class="list"></div></div>
          <div class="tab-page" id="tab-traits"><div id="trait-list" class="list"></div></div>
          <div class="tab-page" id="tab-equips"><div id="equip-list" class="list"></div></div>
          <div class="tab-page" id="tab-skills"><div id="skill-list" class="list"></div></div>
          <div class="tab-page" id="tab-lust">
          <div id="lust-list" class="list"></div></div>
          <div class="tab-page" id="tab-btn-attrs"><div id="attr-list" class="list"></div></div>
          <div class="tab-page" id="tab-status"><div id="status-list" class="list"></div></div>
          <div class="tab-page" id="tab-quest"><div id="quest-list" class="list"></div></div>
          <div class="tab-page" id="tab-people"><div id="people-list" class="list"></div></div>
          <div class="tab-page" id="tab-best"><div id="best-list" class="list"></div></div>
         <div class="tab-page" id="tab-map"><div id="map-list" class="list"></div></div>
        </aside>
      </main>
      <footer>
        <div class="hud">
          <span class="pill" id="time-pill">ç¬¬1æ—¥ å¯æ—¶</span>
          <span class="pill">çµçŸ³ï¼š<b id="stones">0</b></span>
        </div>
        <div class="hud" id="action-bar">
          <button class="btn" data-act="meditate">ä¿®ç‚¼</button>
          <button class="btn" data-act="explore">æ¢ç´¢/ç‹©çŒ</button>
          <button class="btn" data-act="work">æ‰“å·¥</button>
          <button class="btn" data-act="commission">æ¥å§”æ‰˜</button>
          <button class="btn" data-act="talk">ä¸é™„è¿‘çš„äººäº¤è°ˆ</button>
          <button class="btn" data-act="rest">ä¼‘æ¯</button>
          <button class="btn" data-act="seduce">è°ƒæƒ…/å‹¾å¼•â¤</button>
          <button class="btn" data-act="pleasure">è‡ªæ…°æ³„æ¬²â¤</button>
          <button class="btn" data-act="degen">å •è½è¡ŒåŠ¨â¤</button>
          <button class="btn" data-act="escape" style="display:none">é€ƒè·‘</button>
        </div>
      </footer>
    </div>
    <div id="toasts" class="toasts"></div>

    <!-- åˆ›å»ºè§’è‰² -->
    <div id="newchar" class="modal show">
      <div class="dialog">
        <header><strong>åˆ›å»ºè§’è‰²</strong><button class="btn" id="nc-close">Ã—</button></header>
        <div class="body">
          <div class="grid2">
            <div class="field"><label>å§“å</label><input id="nc-name" value="è‹å¤œé›¨"></div>
            <div class="field"><label>æ€§åˆ«</label><select id="nc-gender"><option selected>å¥³</option><option>ç”·</option></select></div>
            <div class="field"><label>æ€§å–å‘</label><select id="nc-orient"><option>å¼‚æ€§</option><option>åŒæ€§</option><option>åŒæ€§</option></select></div>
            <div class="field"><label>å¹´é¾„ï¼ˆâ‰¥14ï¼‰</label><input id="nc-age" type="number" min="14" value="14"></div>
            <div class="field"><label>å‡ºèº«</label><select id="nc-origin"><option>æ•£ä¿®</option><option>å®—é—¨å¤–é—¨</option><option>å®¶æ—å¼Ÿå­</option><option>é’æ¥¼å‡ºèº«</option></select></div>
            <div class="field"><label>åˆå§‹å©šå§»</label><select id="nc-marriage"><option>æœªå©š</option><option>å·²å©š</option><option>ä¸§å¶</option></select></div>
            <div class="field"><label>æ˜¯å¦å¯å­•</label><select id="nc-fertile"><option value="yes">æ˜¯</option><option value="no">å¦</option></select></div>
            <div class="field"><label>é­…åŠ›å€¼</label><input id="nc-charm" type="number" min="0" max="100" value="50"></div>
            <div class="field"><label>æ¬²å€¼åˆå§‹</label><input id="nc-lust" type="number" min="0" max="100" value="20"></div>
            <div class="field"><label>å •è½åº¦åˆå§‹</label><input id="nc-degen" type="number" min="0" max="100" value="0"></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center"><button class="btn" id="nc-ok">å¼€å§‹æ—…ç¨‹</button><span class="pill">æ­¤ç•Œå¥³å­åœ°ä½ä½ä¸‹ï¼Œå¸¸è¢«è§†ä½œç©ç‰©ï¼Œæ˜“é­è°ƒæˆã€ä¾µçŠ¯ã€å •è½ã€‚</span></div>
        </div>
      </div>
    </div>

    <!-- ç‰©å“è¯¦æƒ… -->
    <div id="item-modal" class="modal"><div class="dialog"><header><strong id="item-title">ç‰©å“</strong><button class="btn" id="item-close">Ã—</button></header><div class="body"><div id="item-desc" style="white-space:pre-wrap"></div><div style="margin-top:10px"><button class="btn" id="item-use">ä½¿ç”¨</button></div></div></div></div>

    <!-- æˆ˜æ–— -->
    <div id="battle" class="modal battle-modal"><div class="dialog"><header><strong>æˆ˜æ–—</strong><div class="pill">åœ°ç‚¹ï¼š<b id="battle-loc">â€”</b>ï½œå›åˆï¼š<b id="round-num">1</b></div><button class="btn" id="battle-close" disabled>è¿›è¡Œä¸­â€¦</button></header><div class="body"><div id="timeline" class="timeline"></div><div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap"><span class="pill">æˆ‘æ–¹ HP <b id="me-hp"></b> / çµåŠ› <b id="me-qi"></b></span><span class="pill">æ•Œæ–¹ <b id="en-name"></b> Â· HP <b id="en-hp"></b></span></div><div id="battle-log" class="n-text" style="max-height:240px;margin-top:8px"></div><div id="battle-skills" class="skill-row"></div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" id="btn-defend">é˜²å¾¡</button><button class="btn" id="btn-flee">é€ƒè·‘</button><button class="btn" id="btn-seduce-battle">è¯±æƒ‘æ•Œäºº</button><button class="btn" id="btn-rape-battle">ä¾µçŠ¯æ•Œäºº</button></div></div></div></div>

    <!-- å¯¹è¯ -->
    <div id="dialogue" class="modal dialogue"><div class="dialog"><header><strong id="dlg-npc-name">å¯¹è¯</strong><button class="btn" id="dlg-close">Ã—</button></header><div class="body"><div id="dlg-log" class="dlg-log"></div><div id="dlg-choices" class="dlg-choices"></div></div></div></div>

    <!-- å¤§åœ°å›¾ -->
    <div id="worldmap" class="modal worldmap"><div class="dialog"><header><strong>å¤§åœ°å›¾</strong><button class="btn" id="wm-close">Ã—</button></header><div class="body"><div id="wm-grid" class="map-grid"></div></div></div></div>

    <!-- è£…å¤‡æ  -->
    <div id="equip-modal" class="modal equip">
  <div class="dialog">
    <header>
      <strong>è£…å¤‡æ </strong>
      <button class="btn" id="equip-close">Ã—</button>
    </header>
    <div class="body">
      <div class="equip-grid">
        <!-- è¿™é‡Œæ·»åŠ æ–°çš„è£…å¤‡æ§½ä½ -->
        <div>
          <div class="slot">ä¸»æ­¦å™¨ï¼š<b id="eq-weapon">æ— </b></div>
          <div class="slot">æŠ¤ç”²ï¼š<b id="eq-armor">æ— </b></div>
          <div class="slot">é¥°å“1ï¼š<b id="eq-acc1">æ— </b></div>
          <div class="slot">é¥°å“2ï¼š<b id="eq-acc2">æ— </b></div>
          <div class="slot">é¥°å“3ï¼š<b id="eq-acc3">æ— </b></div>
          <div class="slot">è¶³éƒ¨ï¼š<b id="eq-feet">æ— </b></div>
          <div class="slot">å†…è¡£ï¼š<b id="eq-underwear">æ— </b></div>
          <div class="slot">å†…è£¤ï¼š<b id="eq-panty">æ— </b></div>
          <div class="slot">ä¹³ç¯ï¼š<b id="eq-nipple">æ— </b></div>
          <div class="slot">è…°é¥°ï¼š<b id="eq-waist">æ— </b></div>
          <div class="slot">è„šé“¾ï¼š<b id="eq-ankle">æ— </b></div>
        </div>
        <div>
          <div class="list" id="equipables"></div>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- è‰²æ¬²é¢æ¿ -->
    <div id="lust-modal" class="modal lust-panel"><div class="dialog"><header><strong>è‰²æ¬²é¢æ¿</strong><button class="btn" id="lust-close">Ã—</button></header><div class="body"><div class="lust-grid"><div class="lust-slot">é­…åŠ›ï¼š<b id="lust-charm">0</b></div><div class="lust-slot">æ¬²å€¼ï¼š<b id="lust-value">0/100</b></div><div class="lust-slot">æ•æ„Ÿåº¦ï¼š<b id="lust-sens">ä¸­</b></div><div class="lust-slot">ç»éªŒæ¬¡æ•°ï¼š<b id="lust-exp">0</b></div><div class="lust-slot">ä¼´ä¾£æ•°ï¼š<b id="lust-partners">0</b></div><div class="lust-slot">å­•è‚²çŠ¶æ€ï¼š<b id="lust-preg">æ— </b></div><div class="lust-slot">å •è½åº¦ï¼š<b id="lust-degen">0%</b></div></div></div></div></div>

    <!-- å±æ€§é¢æ¿ -->
<div id="attr-modal" class="modal attr-panel">
  <div class="dialog">
    <header>
      <strong>è§’è‰²å±æ€§</strong>
      <button class="btn" id="attr-close" data-close="#attr-modal">Ã—</button>
    </header>
    <div class="body">
      <div id="attr-content" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
    </div>
  </div>
</div>


    <!-- è°ƒè¯•é¢æ¿ -->
    <div id="debug-modal" class="modal debug"><div class="dialog"><header><strong>è°ƒè¯•é¢æ¿</strong><button class="btn" id="debug-close">Ã—</button></header><div class="body"><div class="debug-grid"><div class="field"><label>HP</label><input id="debug-hp" type="number"></div><div class="field"><label>çµåŠ›</label><input id="debug-qi" type="number"></div><div class="field"><label>ç»éªŒ</label><input id="debug-exp" type="number"></div><div class="field"><label>é­…åŠ›</label><input id="debug-charm" type="number"></div><div class="field"><label>æ¬²å€¼</label><input id="debug-lust" type="number"></div><div class="field"><label>å •è½åº¦</label><input id="debug-degen" type="number"></div><button class="btn" id="debug-apply">åº”ç”¨</button><button class="btn" id="debug-leave">ç¦»å¼€åœºæ™¯</button></div></div></div></div>



<script>
// ====== å·¥å…· ======
const RNG={seed:Math.floor(Math.random()*1e9),next(){this.seed=(this.seed*1664525+1013904223)>>>0;return this.seed/2**32},roll(p){return this.next()<p}};const $=(s,r=document)=>r.querySelector(s);const el=id=>document.getElementById(id);
const numCN=d=>{const m=['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å'];if(d<=10)return m[d];if(d<20)return 'å'+m[d-10];const a=Math.floor(d/10),b=d%10;return m[a]+'å'+(b?m[b]:'')};
function setBar(node,ratio){node.style.width=(Math.max(0,Math.min(1,ratio))*100).toFixed(1)+'%'}
function rndInt(a,b){return a+Math.floor(RNG.next()*(b-a+1))}
function toast(t){const n=document.createElement('div');n.className='toast';n.textContent=t;el('toasts').append(n);setTimeout(()=>{n.style.opacity='0';n.style.transform='translateY(-6px)'},2400);setTimeout(()=>n.remove(),3000)}
function randPick(arr){return arr[Math.floor(RNG.next()*arr.length)]}

// ====== æ—¥å†/å¤©æ°” ======
const Weather=['æ™´','å¤šäº‘','å°é›¨','å¤§é£','é›¾','æ·«é›¨','è‰³é˜³','é˜´éœ¾','æš´é£é›¨','é›¾éœ­'];
const Calendar={year:1,month:1,day:1,toText(){return `${this.year}å¹´ ${this.month}æœˆ ${this.day<10?'åˆ'+numCN(this.day):this.day+'æ—¥'}`},nextDay(){this.day++;if(this.day>30){this.day=1;this.month++;if(this.month>12){this.month=1;this.year++;}}updateDate();weather.roll();mensesTick();pregnancyTick();degenTick();if(GS.flags.captured)capturedLife();}};
const weather={cur:'æ™´',roll(){const r=RNG.next();this.cur=r<.4?'æ™´':r<.6?'å¤šäº‘':r<.75?'å°é›¨':r<.85?'å¤§é£':r<.92?'é›¾':r<.96?'æ·«é›¨':r<.98?'è‰³é˜³':r<.99?'é˜´éœ¾':'æš´é£é›¨';el('weather-pill').textContent=this.cur}};

// ====== ç‰©å“å†Œï¼ˆæ‰©å±•è‰²æƒ…ç‰©å“ï¼Œå¢åŠ å •è½ç›¸å…³ï¼‰ ======
const ITEMBOOK={
  'å›æ°”ä¸¹':{type:'consum',desc:'å›å¤çµåŠ› 6 ç‚¹ã€‚',use(gs){gs.player.qi=Math.min(gs.player.qi_max,gs.player.qi+6);return true;}},
  'å…»è¡€ä¸¸':{type:'consum',gender:'å¥³',desc:'ç¼“è§£ç»æœŸä¸é€‚ï¼Œå°å¹…å›å¤HP+2ã€‚',use(gs){if(gs.player.gender!=='å¥³')return false;gs.player.hp=Math.min(gs.player.hp_max,gs.player.hp+2);gs.player.menses.comfort+=2;return true;}},
  'æš–èº«èŒ¶':{type:'consum',gender:'å¥³',desc:'æå‡å½“æ—¥ç»æœŸèˆ’é€‚åº¦+3ã€‚',use(gs){if(gs.player.gender!=='å¥³')return false;gs.player.menses.comfort+=3;return true;}},
  'è¡Œè„šä»¤':{type:'quest',desc:'å…è®¸è·¨å·è¿œè¡Œï¼ˆè§£é”è¿œè¡Œäº‹ä»¶ä¸éƒ¨åˆ†å•†åº—ï¼‰ã€‚',use(gs){gs.flags.travel=true;return true;}},
  'è¾Ÿè°·ä¸¹':{type:'consum',desc:'ä¸‰æ—¥å†…ä¸å—é¥¥é¥¿å½±å“ï¼ˆæ¼”ç¤ºï¼šHP+2ï¼ŒçµåŠ›+2ï¼‰ã€‚',use(gs){gs.player.hp=Math.min(gs.player.hp_max,gs.player.hp+2);gs.player.qi=Math.min(gs.player.qi_max,gs.player.qi+2);gs.flags.biguan=3;return true;}},
  'å®‰èƒç¬¦':{type:'consum',gender:'å¥³',desc:'é™ä½æµäº§é£é™©ï¼šæ€€å­•å®‰å…¨+10ã€‚',use(gs){if(gs.player.gender!=='å¥³')return false;gs.player.pregnancy.safety+=10;return true;}},
  'åªšè¯æ•£':{type:'consum',desc:'æå‡æ¬²å€¼+20ï¼Œæ˜“è§¦å‘è‰³é‡ï¼Œå •è½+5ã€‚',use(gs){gs.player.lust=Math.min(100,gs.player.lust+20);gs.player.degen=Math.min(100,gs.player.degen+5);return true;}},
  'æ˜¥å®«å›¾':{type:'book',desc:'ç ”ä¹ åé­…åŠ›+2ï¼Œæ¬²å€¼+10ï¼Œå •è½+8ã€‚',use(gs){gs.player.charm+=2;gs.player.lust+=10;gs.player.degen+=8;return true;}},
  'ç‰åŠ¿':{type:'toy',gender:'å¥³',desc:'è‡ªæ…°ç”¨ï¼Œæ³„æ¬²-15ï¼Œæ•æ„Ÿåº¦+1ï¼Œå •è½+3ã€‚',use(gs){if(gs.player.gender!=='å¥³')return false;gs.player.lust=Math.max(0,gs.player.lust-15);gs.player.sensitivity+=1;gs.player.degen+=3;return true;}},
  'å •è½ä¸¹':{type:'consum',desc:'ç›´æ¥å¢åŠ å •è½åº¦+15ï¼Œå¼•å‘éšæœºå •è½äº‹ä»¶ã€‚',use(gs){gs.player.degen=Math.min(100,gs.player.degen+15);triggerDegenEvent();return true;}},
  'æ¸©ç‰ä½©':{type:'acc',desc:'é¥°å“ï¼šé­…åŠ›+1ï¼ˆå¥½æ„Ÿäº‹ä»¶ç•¥æ˜“æˆåŠŸï¼‰ã€‚',equip:'acc',onEquip(gs){gs.player.charm+=1},onUnequip(gs){gs.player.charm=Math.max(0,gs.player.charm-1)}},
  'æœ¨å‰‘':{type:'weapon',desc:'ä¸»æ­¦å™¨ï¼šåŸºç¡€ä¼¤å®³+1ã€‚',equip:'weapon',onEquip(gs){gs.flags.atkPlus=(gs.flags.atkPlus||0)+1},onUnequip(gs){gs.flags.atkPlus=Math.max(0,(gs.flags.atkPlus||0)-1)}},
  'çš®ç”²':{type:'armor',desc:'æŠ¤ç”²ï¼šæœ€å¤§ç”Ÿå‘½+4ã€‚',equip:'armor',onEquip(gs){gs.player.hp_max+=4;gs.player.hp+=4},onUnequip(gs){gs.player.hp_max=Math.max(1,gs.player.hp_max-4);gs.player.hp=Math.min(GS.player.hp,gs.player.hp_max)}},
  'ä¸è¢':{type:'armor',gender:'å¥³',desc:'è½»è–„ä¸è¢ï¼Œé­…åŠ›+3ï¼Œä½†é˜²å¾¡-1ï¼Œå •è½+2ã€‚',equip:'armor',onEquip(gs){gs.player.charm+=3;gs.player.hp_max-=1;gs.player.degen+=2},onUnequip(gs){gs.player.charm-=3;gs.player.hp_max+=1;gs.player.degen-=2}},
  'æ·«çº¹è´´':{type:'acc',desc:'è´´äºå°è…¹ï¼Œæ¬²å€¼æ’å¢ï¼Œå •è½+10ã€‚',equip:'acc',onEquip(gs){gs.player.lust+=5;gs.player.degen+=10},onUnequip(gs){gs.player.lust-=5;gs.player.degen-=10}},
  'è¯…å’’é¡¹é“¾': {type:'acc',desc:'é­…åŠ›+5ï¼Œä½†æ¯æ—¥hp-2ï¼Œå •è½+10ï¼Œè´Ÿé¢æ•ˆæœï¼šæ˜“è¢«éœ¸å‡Œäº‹ä»¶è§¦å‘ç‡+20%ã€‚',equip:'acc',onEquip(gs){gs.player.charm+=5;gs.player.degen+=10;gs.flags.bully_rate = (gs.flags.bully_rate||0)+0.2;},onUnequip(gs){gs.player.charm-=5;gs.player.degen-=10;gs.flags.bully_rate-=0.2;}},
  'å¥´éš¶é”é“¾': {type:'toy',desc:'ä½¿ç”¨åå •è½+20ï¼Œæ•æ„Ÿåº¦+5ï¼Œè´Ÿé¢æ•ˆæœï¼šé€ƒè·‘æˆåŠŸç‡-10%ï¼Œæ˜“è¢«ä¿˜è™ã€‚',use(gs){gs.player.degen+=20;gs.player.sensitivity+=5;gs.flags.escape_rate = (gs.flags.escape_rate||0)-0.1;return true;}},
  'æ·«å…½åµ': {type:'consum',desc:'åæœåå •è½+15ï¼Œå­•è‚²æ·«å…½å­å—£ï¼Œè´Ÿé¢æ•ˆæœï¼šhp_max-5ï¼Œæ°¸ä¹…çŠ¶æ€â€˜å…½å­•ä½“è´¨â€™ã€‚',use(gs){gs.player.degen+=15;gs.player.hp_max-=5;gs.player.pregnancy.pregnant=true;gs.player.pregnancy.day=1;gs.statuses.push('å…½å­•ä½“è´¨');return true;}},
  'è¡€è‚‰é­': {type:'weapon',desc:'æ”»å‡»+5ï¼Œä½†ä½¿ç”¨åhp-3ï¼Œå •è½+5ï¼Œè´Ÿé¢æ•ˆæœï¼šæˆ˜æ–—ä¸­éšæœºè‡ªä¼¤ã€‚',equip:'weapon',onEquip(gs){gs.flags.atkPlus=(gs.flags.atkPlus||0)+5;gs.player.degen+=5;},onUnequip(gs){gs.flags.atkPlus-=5;gs.player.degen-=5;}},
  'æ¬²ç«ç„šèº«ä¸¹': {type:'consum',desc:'æ¬²å€¼+30ï¼Œå •è½+10ï¼Œè´Ÿé¢æ•ˆæœï¼šéšæœºè§¦å‘å…¬å¼€è‡ªæ…°äº‹ä»¶ã€‚',use(gs){gs.player.lust+=30;gs.player.degen+=10;if(RNG.roll(0.5))say('ä¸¹è¯å‘ä½œï¼Œä½ å…¬å¼€è‡ªæ…°ï¼Œè·¯äººå›´è§‚ï¼Œé˜´æˆ·æ»´æ±ã€‚');return true;}},
  'ååº­èŠ±ç¯': {type:'toy',gender:'å¥³',desc:'ååº­æ•æ„Ÿ+5ï¼Œå •è½+15ï¼Œè´Ÿé¢æ•ˆæœï¼šé€ƒè·‘å‡ ç‡-15%ã€‚',use(gs){if(gs.player.gender!=='å¥³')return false;gs.player.sensitivity+=5;gs.player.degen+=15;gs.flags.escape_rate -=0.15;return true;}},
  'çµé­‚è…èš€å‰‘': {type:'weapon',desc:'æ”»å‡»+8ï¼Œä½†æ¯æ—¥å •è½+3ï¼Œè´Ÿé¢æ•ˆæœï¼šæˆ˜æ–—å¤±è´¥è¢«ä¿˜è™ç‡+20%ã€‚',equip:'weapon',onEquip(gs){gs.flags.atkPlus+=8;},onUnequip(gs){gs.flags.atkPlus-=8;}},
  'æ·«çº¹æˆ˜ç”²': {
  type: 'armor',
  desc: 'åˆ»æœ‰ç‰¹æ®ŠèŠ±çº¹çš„æˆ˜ç”²ï¼Œé˜²å¾¡+25ï¼Œé­…åŠ›+20ï¼Œæ•æ„Ÿ+15ï¼Œå •è½+10ã€‚',
  equip: 'armor',
  onEquip(gs) {
    gs.player.def = (gs.player.def || 0) + 25;
    gs.player.charm += 20;
    gs.player.sensitivity += 15;
    gs.player.degen += 10;
  },
  onUnequip(gs) {
    gs.player.def -= 25;
    gs.player.charm -= 20;
    gs.player.sensitivity -= 15;
    gs.player.degen -= 10;
  }
},
  'é­…é­”é¡¹åœˆ': {
    type: 'acc',
    slot: 'acc1',
    price: 6000,
    stats: {
      charm: 25,
      sensitivity: 20,
      degen: 12,
      lust: 15
    },
    effects: ['æ¯å°æ—¶å¢åŠ å •è½å€¼','è‡ªåŠ¨å¸æ”¶æ·«æ°”è½¬åŒ–ä¸ºèƒ½é‡'],
    desc: 'æ¥è‡ªé­…é­”çš„é“å…·'
  },

};

// ====== åˆå§‹çŠ¶æ€ ======
const GS={
  player:{name:'è‹å¤œé›¨',gender:'å¥³',orient:'å¼‚æ€§',age:14,realm:'ç»ƒæ°”ä¸€å±‚',hp:30,hp_max:30,qi:20,qi_max:20,level:1,exp:0,exp_to_next:20,faction:'æ•£ä¿®',mood:'å¹³é™',married:false,spouse:null,children:[],
    traits:['æ¸…å¿ƒå¯¡æ¬²','å¤©ç”Ÿåªšéª¨'],skills:[{id:'strike',name:'ç¢äº‘æ‹³',qi:0,dmg:[3,6],spd:6,desc:'åŸºæœ¬æ‹³æ³•ã€‚'},{id:'fire',name:'ç«çƒæœ¯',qi:4,dmg:[7,12],spd:5,desc:'å‡èšçµç«æ·å‡ºã€‚'},{id:'aqua',name:'æ°´å¹•æŠ¤èº«',qi:3,dmg:[0,0],spd:7,desc:'è·å¾—æŠ¤ä½“ä¹‹åŠ›ã€‚',buff:{shield:6}},{id:'seduce',name:'åªšçœ¼æœ¯',qi:2,dmg:[0,0],spd:8,desc:'è¯±æƒ‘æ•Œäººï¼Œé™ä½æ•Œé€Ÿ-1ã€‚'}],
    menses:{enabled:true,cycle:28,day:1,comfort:0,bleeding:false},pregnancy:{enabled:true,pregnant:false,day:0,safety:0},
    charm:50,lust:20,lustMax: 100,sensitivity:0,lustGainRate: 1,sex_exp:0,partners:0,degen:0, degenMax: 100, // å •è½åº¦ä¸Šé™
    degenGainRate: 1, // å •è½è·å¾—å€ç‡
    degenResist: 0, // å •è½æŠ—æ€§
    degenStages: [],
    // çŠ¶æ€æ ‡è®°
    isLustful: false, // æ¬²æœ›çˆ†å‘
    isCorrupted: false, // å •è½çˆ†å‘ 
  },
  time:'å¯æ—¶',day:1,loc:'æ¸…é£é•‡Â·å®¢æ ˆ',sub_loc:'',stones:18,
  inventory:{'ç²—å¸ƒè¡£':1,'å›æ°”ä¸¹':3,'å…»è¡€ä¸¸':1,'æš–èº«èŒ¶':1,'åªšè¯æ•£':2,'æ˜¥å®«å›¾':1,'ç‰åŠ¿':1,'ä¸è¢':1,'æ¸©ç‰ä½©':1,'è¡Œè„šä»¤':1,'æœ¨å‰‘':1,'çš®ç”²':1,'å •è½ä¸¹':1,'æ·«çº¹è´´':1},
  equips:{weapon:null,armor:'ç²—å¸ƒè¡£',acc:null},
  techniques:['ã€Šåçº³æœ¯ã€‹','ã€Šå‡æ¯è¯€ã€‹','ã€Šåªšéª¨è¯€ã€‹','ã€Šå •é­‚ç»ã€‹'],traits:['æ¸…å¿ƒå¯¡æ¬²','å¤©ç”Ÿåªšéª¨','åˆå •å€¾å‘'],statuses:[],
  relations:[
    {id:'xi',name:'å¸­æ™šå®',gender:'å¥³',age:16,favor:12,trust:6,loc:'æ¸…é£é•‡Â·å¤§è¡—',looks:'çœ‰ç›®å¦‚ç”»ï¼Œç¥æƒ…æ¸©å©‰ï¼ŒæŸ³è…°çº¤ç»†ï¼Œé¦™è‡€åœ†æ¶¦ï¼Œç‰ä¹³å¾®é¢¤ï¼Œéªšç©´éšç°æ˜¥å…‰ã€‚'},
    {id:'su',name:'è‹è½»èˆŸ',gender:'ç”·',age:21,favor:8,trust:10,loc:'ç‰è¡¡å®—Â·å±±é—¨',looks:'æ¸…ä¿Šå¯¡è¨€ï¼Œç›®å…‰æ²‰ç¨³ï¼Œå¤§å±Œéšç°è£¤è£†ã€‚'},
    {id:'ji',name:'çºªéœæœˆ',gender:'å¥³',age:15,favor:5,trust:12,loc:'æ¸…é£é•‡Â·è¯é“º',looks:'ä¸€èº«è¯é¦™ï¼Œç¬‘æ„å¦‚æ˜¥ï¼Œçº¢å”‡å¾®å¯ï¼Œç¾è‡€è½»æ‘†ï¼Œé˜´ç©´æ¹¿æ¶¦ï¼Œåªšçœ¼æµè½¬ã€‚'},
    {id:'lin',name:'æ—ç–å½±',gender:'å¥³',age:14,favor:18,trust:9,loc:'åŒ—å²­éƒŠå¤–',looks:'è‹±æ°”å‡Œå‰ï¼Œé£å§¿æ˜è‰³ï¼Œé¦™è‡€ç¿˜èµ·ï¼Œå°ç©´ç´§è‡´ï¼Œç‰ä¹³ä¸°æ»¡ï¼Œç²‰å«©ååº­ã€‚'},
    {id:'jiang',name:'æ±Ÿæ™“',gender:'å¥³',age:17,favor:10,trust:5,loc:'æ¸…é£é•‡Â·é’æ¥¼',looks:'å¨‡åªšå…¥éª¨ï¼Œçº¢å”‡æ¬²æ»´ï¼Œéªšç©´å¤šæ±ï¼Œç¾è‡€æ‘‡æ›³ï¼Œé˜´æˆ·éšç°èœœæ¶²ã€‚'},
    {id:'yun',name:'äº‘æµ…',gender:'ç”·',age:19,favor:15,trust:8,loc:'é›¾éšæ‘Â·æ—é—´',looks:'ä¿Šæœ—æ½‡æ´’ï¼Œé˜³å…·ç²—é•¿ï¼Œç›®å…‰ç‚™çƒ­ã€‚'},
    {id:'mei',name:'æ¢…å©‰å„¿',gender:'å¥³',age:13,favor:7,trust:4,loc:'çµè¯è°·Â·æºªè¾¹',looks:'å¨‡å°ç²ç‘ï¼Œç²‰å«©è‚Œè‚¤ï¼Œå°ç©´ç²‰çº¢ï¼Œç¾è‡€æŸ”è½¯ã€‚'}
  ],
  bestiary:[
    {id:'wolf',name:'é‡ç‹¼',tier:1,hp:18,atk:[2,5],spd:6,drops:[['å…½çš®',0.6,1],['å…½éª¨',0.3,1]]},
    {id:'bandit',name:'å±±åŒª',tier:1,hp:22,atk:[3,6],spd:5,drops:[['ç¢é“¶',0.8,5]]},
    {id:'snake',name:'çµè›‡',tier:1,hp:16,atk:[2,6],spd:8,drops:[['è›‡èƒ†',0.35,1]]},
    {id:'ghost',name:'æ¸¸é­‚',tier:2,hp:28,atk:[4,8],spd:7,drops:[['é˜´é­‚ç ',0.25,1]]},
    {id:'rapist',name:'æ·«è´¼',tier:1,hp:20,atk:[3,7],spd:6,drops:[['åªšè¯æ•£',0.4,1]]},
    {id:'beast',name:'æ·«å…½',tier:2,hp:25,atk:[4,9],spd:5,drops:[['å…½ç²¾',0.5,1]]},
    {id:'cultist',name:'é‚ªä¿®',tier:3,hp:32,atk:[5,10],spd:7,drops:[['å •è½ä¸¹',0.3,1]]}
  ],
  map:['æ¸…é£é•‡Â·å®¢æ ˆ','æ¸…é£é•‡Â·å¤§è¡—','æ¸…é£é•‡Â·è¯é“º','æ¸…é£é•‡Â·é’æ¥¼','åŒ—å²­éƒŠå¤–','åŒ—å²­å¯†æ—','ç‰è¡¡å®—Â·å±±é—¨','ç‰è¡¡å®—Â·å¤–é—¨','ç‰è¡¡å®—Â·è—ç»é˜','çµè¯è°·','é›¾å²šæ¹–ç•”','å¤äº•ç§˜çªŸ','å•†è·¯é©¿ç«™','çº¢å°˜å··','å¹½å†¥æ´çªŸ','å •è½æ¸Š','è¡€æœˆæ—','åªšç‹æ‘','æ·«é­”å¡”'],
  quests:[],flags:{rngp:0,travel:false,biguan:0,outerCount:0,captured:false,captured_loc:'',captured_sub_loc:''}
};

// ====== æ¸²æŸ“ ======
function refresh(){el('name').textContent=GS.player.name;el('realm').textContent=GS.player.realm;setBar(el('hp-bar'),GS.player.hp/GS.player.hp_max);setBar(el('qi-bar'),GS.player.qi/GS.player.qi_max);setBar(el('exp-bar'),GS.player.exp/GS.player.exp_to_next);setBar(el('rngp-bar'),GS.flags.rngp/100);setBar(el('degen-bar'),GS.player.degen/100);el('hp-text').textContent=`${GS.player.hp}/${GS.player.hp_max}`;el('qi-text').textContent=`${GS.player.qi}/${GS.player.qi_max}`;el('exp-text').textContent=`${GS.player.exp}/${GS.player.exp_to_next}`;el('rngp-text').textContent=`${GS.flags.rngp|0}%`;el('degen-text').textContent=`${GS.player.degen}%`;el('time-pill').textContent=`ç¬¬${GS.day}æ—¥ ${GS.time}`;el('loc-pill').textContent=GS.loc;el('stones').textContent=GS.stones;updateLists();updatePeople();updateBest();updateTraits();updateMap();updateQuests();updateLust();}
function itemRow(l,r){const d=document.createElement('div');d.className='item';const a=document.createElement('span');a.textContent=l;const b=document.createElement('span');b.className='pill';b.textContent=r;d.append(a,b);return d}
function updateLists(){const bag=el('bag-list');bag.innerHTML='';Object.entries(GS.inventory).forEach(([k,v])=>{const it=ITEMBOOK[k];const row=itemRow(k,`x${v}`);row.style.cursor='pointer';row.onclick=()=>openItem(k);bag.append(row)});const tech=el('tech-list');tech.innerHTML='';GS.techniques.forEach(t=>tech.append(itemRow(t,'')));const st=el('status-list');st.innerHTML='';GS.statuses.forEach(s=>st.append(itemRow(s,'')))}
function updatePeople(){const box=el('people-list');box.innerHTML='';GS.relations.forEach(p=>{const r=itemRow(`${p.name}ï¼ˆ${p.gender}/${p.age}ï¼‰Â·å¥½æ„Ÿ ${p.favor}ï½œä¿¡ä»» ${p.trust}`,p.loc);r.style.cursor='pointer';r.onclick=()=>openDialogue(p);box.append(r)})}
function updateBest(){const box=el('best-list');box.innerHTML='';GS.bestiary.forEach(b=>box.append(itemRow(`${b.name}Â·é˜¶${b.tier}`,`HP${b.hp}/é€Ÿ${b.spd}`)))}
function updateTraits(){const box=el('trait-list');box.innerHTML='';[...new Set([...(GS.traits||[]),...(GS.player.traits||[])])].forEach(t=>box.append(itemRow(t,'')))}
function updateMap(){const box=el('map-list');box.innerHTML='';GS.map.forEach(loc=>{const r=itemRow(loc,loc===GS.loc?'å½“å‰':'');r.style.cursor='pointer';r.onclick=()=>{goTo(loc)};box.append(r)})}
function updateQuests(){const box=el('quest-list');box.innerHTML='';GS.quests.forEach(q=>box.append(itemRow(`${q.name}ï¼ˆ${q.stageName}ï¼‰`,q.desc||'')));el('main-hint').textContent=GS.quests[0]?`ä¸»çº¿ï¼š${GS.quests[0].name}Â·${GS.quests[0].stageName}`:'ä¸»çº¿ï¼šâ€”'}
function updateLust() {
  const p = GS.player;
  const box = document.getElementById('lust-list');
  if (!box) return;
  box.innerHTML = `
    <div class="item"><span>é­…åŠ›</span><span class="pill">${p.charm}</span></div>
    <div class="item"><span>æ¬²å€¼</span><span class="pill">${p.lust}/100</span></div>
    <div class="item"><span>æ•æ„Ÿåº¦</span><span class="pill">${['ä½','ä¸­','é«˜','æé«˜'][Math.min(3,Math.floor(p.sensitivity/10))]}</span></div>
    <div class="item"><span>ç»éªŒæ¬¡æ•°</span><span class="pill">${p.sex_exp}</span></div>
    <div class="item"><span>ä¼´ä¾£æ•°</span><span class="pill">${p.partners}</span></div>
    <div class="item"><span>å­•è‚²çŠ¶æ€</span><span class="pill">${p.pregnancy.pregnant?'å­•è‚²ä¸­':'æ— '}</span></div>
    <div class="item"><span>å •è½åº¦</span><span class="pill">${p.degen}%</span></div>
  `;
}
// 1. è£…å¤‡æ tabå†…å®¹æ¸²æŸ“
function updateEquipsTab() {
  const box = document.getElementById('equip-list');
  if (!box) return;
  const equips = GS.equips || {};
  box.innerHTML = `
    <div class="item"><span>ä¸»æ­¦å™¨</span><span class="pill">${equips.weapon || 'æ— '}</span></div>
    <div class="item"><span>æŠ¤ç”²</span><span class="pill">${equips.armor || 'æ— '}</span></div>
    <div class="item"><span>é¥°å“</span><span class="pill">${equips.acc || 'æ— '}</span></div>
  `;
}

// 2. æŠ€èƒ½tabå†…å®¹æ¸²æŸ“
function updateSkillsTab() {
  const box = document.getElementById('skill-list');
  if (!box) return;
  box.innerHTML = '';
  (GS.player.skills || []).forEach(sk => {
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `<span>${sk.name}</span><span class="pill">è€—çµ${sk.qi} é€Ÿ${sk.spd}</span>`;
    box.append(row);
  });
}

// 3. å±æ€§tabå†…å®¹æ¸²æŸ“ï¼ˆç®€ç‰ˆï¼Œè¯¦ç»†å±æ€§ä»å¯ç”¨å¼¹çª—ï¼‰
function updateAttrsTab() {
  const box = document.getElementById('attr-list');
  if (!box) return;
  const p = GS.player;
  box.innerHTML = `
    <div class="item"><span>å§“å</span><span class="pill">${p.name}</span></div>
    <div class="item"><span>å¢ƒç•Œ</span><span class="pill">${p.realm}</span></div>
    <div class="item"><span>ç­‰çº§</span><span class="pill">Lv.${p.level}ï¼ˆ${p.exp}/${p.exp_to_next}ï¼‰</span></div>
    <div class="item"><span>ç”Ÿå‘½</span><span class="pill">${p.hp}/${p.hp_max}</span></div>
    <div class="item"><span>çµåŠ›</span><span class="pill">${p.qi}/${p.qi_max}</span></div>
    <div class="item"><span>é­…åŠ›</span><span class="pill">${p.charm}</span></div>
    <div class="item"><span>æ¬²å€¼</span><span class="pill">${p.lust}/100</span></div>
    <div class="item"><span>å •è½åº¦</span><span class="pill">${p.degen}%</span></div>
    <div class="item"><span>ä¼´ä¾£æ•°</span><span class="pill">${p.partners||0}</span></div>
  `;
}

// 4. tabåˆ‡æ¢æ—¶è‡ªåŠ¨åˆ·æ–°å†…å®¹
document.querySelector('[data-tab="equips"]').addEventListener('click', updateEquipsTab);
document.querySelector('[data-tab="skills"]').addEventListener('click', updateSkillsTab);
document.querySelector('[data-tab="btn-attrs"]').addEventListener('click', updateAttrsTab);

// 5. å¯åŠ¨æ—¶ä¹Ÿå¯åˆ·æ–°ä¸€æ¬¡
updateEquipsTab();
updateSkillsTab();
updateAttrsTab();
// ====== æ—¥å¸¸åŠ¨ä½œ ======
$('#action-bar').addEventListener('click',e=>{if(!e.target.dataset.act)return;const a=e.target.dataset.act;switch(a){case'meditate':actMeditate();break;case'explore':actExplore();break;case'work':actWork();break;case'commission':actCommission();break;case'talk':openDialogue(randPick(GS.relations.filter(p=>p.loc.includes(GS.loc.split('Â·')[0]))));break;case'rest':actRest();break;case'seduce':actSeduce();break;case'pleasure':actPleasure();break;case'degen':actDegen();break;case'escape':actEscape();break;}})

function actMeditate(){if(spendQi(3)){say('ä½ ç«¯åæ‰“åï¼Œçµæ¯ç»µå»¶ï¼Œå‘¨èº«æš–æµæ¶ŒåŠ¨ï¼Œä¼¼æœ‰æ¬²ç«éšç°ï¼Œå •è½å¾®å¢ã€‚');gainExp(5);incRngp(6);GS.player.degen+=1;}else say('çµåŠ›ä¸è¶³ï¼Œåçº³æœªæœã€‚');tickTime()}
function actExplore(){say('ä½ å¼€å§‹æ¢ç´¢å››å‘¨ï¼Œå¶è§å¥³å­è¡£è¡«ä¸æ•´ï¼Œé¦™è‡€æ‘‡æ›³ï¼Œå •è½ä¹‹å¿ƒè ¢åŠ¨â€¦â€¦');const enc=pickEncounter();enc.run();incRngp(10);tickTime();}
function actWork(){GS.stones+=rndInt(1,4);say('ä½ åœ¨å®¢æ ˆ/é©¿ç«™æ‰“çŸ­å·¥ï¼Œå¥³æŒæŸœåªšçœ¼å¦‚ä¸ï¼Œä¸°ä¹³å¾®é¢¤ï¼Œç”·å®¢æ ˆä¸»å¤§å±Œé¡¶èµ·è£¤è£†ï¼Œä½ å¿ƒç”Ÿå •è½æ¬²ã€‚');incRngp(5);GS.player.degen+=2;tickTime();}
function actCommission(){ensureSect();setChoices([{id:201,text:'é‡‡è¯ï¼ˆçµè¯è°·ï¼‰'},{id:202,text:'æ¸…å‰¿ï¼ˆåŒ—å²­éƒŠå¤–ï¼‰'},{id:203,text:'æŠ¤é€ï¼ˆå•†è·¯é©¿ç«™ï¼‰'},{id:204,text:'ä¾å¯å§”æ‰˜ï¼ˆé’æ¥¼ï¼‰'},{id:205,text:'å •è½ä»»åŠ¡ï¼ˆå¹½å†¥æ´çªŸï¼‰'}]);say('ä½ æŸ¥çœ‹äº†ä»Šæ—¥å¯æ¥çš„å§”æ‰˜ï¼Œå¥³å­åœ°ä½ä½ä¸‹ï¼Œå¤šæœ‰ä¾å¯ã€å •è½ä¹‹éœ€ã€‚');}
function actRest(){heal(4);GS.player.qi=Math.min(GS.player.qi_max,GS.player.qi+2);say('ä½ å°æ†©ç‰‡åˆ»ï¼Œæ°”è¡€ä¸çµæ¯ç¨å¤ï¼Œæ¢¦ä¸­è§ç¾äººç‰ä½“æ¨ªé™ˆï¼Œå°ç©´æ¹¿æ¶¦ï¼Œå •è½æ¢¦é­‡ç¼ èº«ã€‚');tickTime();}
function actSeduce(){const npc=randPick(GS.relations.filter(p=>p.gender==='ç”·'&&p.loc===GS.loc));if(npc){GS.player.lust+=5;npc.favor+=Math.floor(GS.player.charm/20);say(`ä½ å¯¹${npc.name}æŠ›åªšçœ¼ï¼Œå¥¹ä¿è„¸å¾®çº¢ï¼Œç¾è‡€è½»æ‰­ï¼Œéªšç©´å¾®æ¹¿ï¼Œå •è½åº¦ä¸Šå‡ã€‚`);GS.player.degen+=3;}else say('é™„è¿‘æ— ç”·å­å¯å‹¾å¼•ã€‚');incRngp(8);tickTime();}
function actPleasure(){GS.player.lust=Math.max(0,GS.player.lust-15);GS.player.sensitivity+=1;GS.player.sex_exp+=1;say('ä½ ç‹¬è‡ªæ³„æ¬²ï¼Œæ‰‹æ¢é˜´ç©´ï¼Œå–˜æ¯è¿è¿ï¼Œé¦™è‡€é¢¤åŠ¨ï¼Œæ¬²ç«æ¸æ¶ˆï¼Œå •è½åŠ æ·±ã€‚');incRngp(12);GS.player.degen+=5;tickTime();}
function actDegen(){GS.player.degen=Math.min(100,GS.player.degen+10);say('ä½ ä¸»åŠ¨å¯»æ±‚å •è½ï¼Œè¡—å¤´è‡ªæ‘¸éªšç©´ï¼Œè·¯äººå›´è§‚ï¼Œé¦™è‡€æ‘‡æ›³ï¼Œé˜´æˆ·èœœæ±å–·æº…ã€‚');triggerDegenEvent();tickTime();}
function actEscape(){if(GS.flags.captured){let escapeChance = 0.3 - (GS.player.degen / 500);if(RNG.roll(escapeChance)){GS.flags.captured = false;GS.loc = 'æ¸…é£é•‡Â·å®¢æ ˆ';GS.sub_loc = '';say('ä½ æˆåŠŸé€ƒè„±ä¿˜è™ï¼Œå›åˆ°å®‰å…¨å¤„ã€‚');}else{say('é€ƒè·‘å¤±è´¥ï¼Œè¢«æŠ“å›ï¼Œé­å—æ›´æƒ¨çƒˆæƒ©ç½šï¼Œå¤§å±Œè½®ç•ªæ’å…¥éªšç©´ï¼Œç¾è‡€æ‰‡è‚¿ï¼Œå •è½æš´å¢ï¼Œé˜´æˆ·æ’•è£‚å‡ºè¡€ï¼Œæ°¸ç•™ä¼¤ç—•ã€‚');GS.player.degen+=30;GS.player.hp-=15;GS.player.lust+=40;GS.player.sensitivity+=5;GS.statuses.push('é˜´æˆ·æ°¸ä¹…ä¼¤ç—•');}}tickTime();}

// ====== è‰³é‡è“„åŠ¿ ======
function incRngp(x){GS.flags.rngp=Math.min(100,GS.flags.rngp+(x||0));if(GS.flags.rngp>=100){GS.flags.rngp=0;specialFortune();}}
function specialFortune(){const txt=['ä½ æ‹¾å¾—ä¸€æšæ¸©çƒ­çš„ç‰ç®€ï¼Œä¸Šåˆ»â€œåªšéª¨è¯€â€ï¼Œç ”ä¹ åæ¬²å€¼+10ï¼Œå •è½+5ã€‚','ä¸€åªçµé›€åœ¨çª—å‰å©å–™ï¼Œè½ä¸‹ä¸€æšåªšè¯æ•£ï¼Œæœç”¨åéªšç©´æ¹¿æ¶¦ï¼Œå •è½åŠ æ·±ã€‚','å¤äº•æ—å†·é›¾ç¿»æ¶Œï¼Œä½ å¶é‡ä¸€ç”·å­ï¼Œå¤§å±Œæ’å…¥é˜´ç©´ï¼Œè½®ç•ªæŠ½æ’ï¼Œç¾è‡€é¢¤åŠ¨ï¼Œé«˜æ½®è¿è¿ï¼Œå •è½æš´å¢ã€‚','é›¾éšæ‘æ—é—´ï¼Œä½ è¢«ç¾¤ç‹¼å›´æ”»ï¼Œå…½æ ¹ç‹ æ’ååº­ï¼Œéªšç©´å–·æ±ï¼Œé¦™è‡€è¢«çˆªç—•æŠ“æ»¡ï¼Œå •è½ä¹‹å¿ƒè§‰é†’ã€‚','è¡€æœˆæ—ä¸­ï¼Œé‚ªä¿®æ–½æ³•ï¼Œä½ é˜´æˆ·é•¿æ·«çº¹ï¼Œæ¬²ç«ç„šèº«ï¼Œå •è½åº¦é£™å‡ã€‚'];say('ã€è‰³é‡è§¦å‘ã€‘'+randPick(txt));addItem('åªšè¯æ•£',1);gainExp(8);GS.player.lust+=10;GS.player.degen+=rndInt(5,15);}

// ====== å™äº‹/é€‰é¡¹ ======
const narrative=el('narrative'),choices=el('choices');
function say(t){narrative.innerHTML+=`<div>${t}</div>`;narrative.scrollTop=narrative.scrollHeight}
function setChoices(arr){choices.innerHTML='';(arr||[]).forEach((c,i)=>{const b=document.createElement('button');b.className='choice';b.innerHTML=`<b>${i+1}.</b> ${c.text}`;b.onclick=()=>resolveChoice(c.id);choices.append(b)});}

// ====== æ—¶é—´æµé€ ======
const HOURS=['å¯æ—¶','è¾°æ—¶','å·³æ—¶','åˆæ—¶','æœªæ—¶','ç”³æ—¶','é…‰æ—¶','æˆŒæ—¶','äº¥æ—¶','å­æ—¶','ä¸‘æ—¶','å¯…æ—¶'];
function tickTime(h=1){for(let i=0;i<h;i++){const idx=(HOURS.indexOf(GS.time)+1+HOURS.length)%HOURS.length;GS.time=HOURS[idx];if(GS.time==='å­æ—¶'){GS.day++;Calendar.nextDay();}tryRandomEvent();GS.player.lust+=rndInt(1,3);GS.player.degen+=rndInt(0,2);}timePassCheck();refresh()}
function tryRandomEvent(){if(!RNG.roll(.4))return;const e=pickEncounter(true);toast(e.tip||'å‘ç”Ÿäº†ä¸€ä»¶è‰³äº‹');e.run()}
if(GS.flags.bully_rate > RNG.next()){
  const bullyE = {id:'bully_extra',run:()=>{
    say('é¢å¤–éœ¸å‡Œäº‹ä»¶è§¦å‘ï¼Œä½ è¢«è·¯äººç¾¤å›´è°ƒæˆï¼Œç¾è‡€è¢«æï¼Œéªšç©´éšç°æ˜¥å…‰ï¼Œæ–‡è‰ºé£æƒ…å¦‚å”è¯—â€œäº‘æƒ³è¡£è£³èŠ±æƒ³å®¹â€ï¼Œå´é€æ­¥å •è½ï¼Œå†…å¿ƒæ‚”æ¨ã€æ€å¦‚æ­¤ä½œè´±ã€‘ã€‚');
    GS.player.degen +=5;
    if(RNG.roll(0.3)){
      say('éœ¸å‡ŒåŠ å‰§ï¼Œä½ è¢«æ‹–å…¥æš—å··ï¼Œé˜³å…·æ‘©æ“¦é˜´æˆ·ï¼Œç¾è‡€æ‹å“ï¼Œæ±æ¶²æ»´è½ï¼Œæ•æ„Ÿ+1ï¼Œå •è½+5ã€‚');
      GS.player.sensitivity +=1;
      GS.player.degen +=5;
    }else if(RNG.roll(0.6)){
      say('è¿›ä¸€æ­¥å •è½ï¼Œç¾¤äººè½®å¥¸ï¼Œå¤§å±Œæ’å…¥éªšç©´ï¼ŒæŠ½æ’é—´èœœæ±å››æº…ï¼Œç¾è‡€æ‰‡è‚¿ï¼Œå¥¶å­æé’ï¼Œè¡€æ¶²æ··æ±ï¼Œé«˜æ½®å¤±ç¦ï¼Œæ€§ç»éªŒ+1ï¼Œå •è½+10ã€‚');
      GS.player.sex_exp +=1;
      GS.player.degen +=10;
    }else{
      say('çŒå¥‡è™å¾…ï¼Œä½ è¢«ç»‘è€»è¾±æŸ±ï¼Œé­æ‰“å¥¶å­è¡€ç—•æ–‘æ–‘ï¼Œé˜´é“å¡æ»¡é’ˆåˆºï¼Œç—›å«æ±‚é¥¶ï¼Œè‡ªæ®‹åˆ’åˆ€ç¾è‡€è¡€æ·‹ï¼Œæƒ¨æ— äººé“é«˜æ½®ä¸æ­¢ï¼Œæ°¸ä¹…ä¼¤ç—•â€˜é­å°å¥¶å­â€™ï¼Œå •è½+15ï¼Œéšæœºæ”¯çº¿å¼€å¯ã€‚');
      GS.player.degen +=15;
      GS.statuses.push('é­å°å¥¶å­');
      setChoices([{id:801,text:'æ±‚é¥¶è·ªèˆ”æ¢ä¼‘æ¯'},{id:802,text:'åæŠ—æˆ˜æ–—ï¼ˆatk>15ï¼‰'},{id:803,text:'è‡ªæ…°å¸å¼•æ›´å¤šäººï¼ˆdegen>50ï¼‰'},{id:804,text:'ç­¾å¥´éš¶å¥‘çº¦'}]);
    }
  }};
  bullyE.run();
}
// ====== é­é‡æ±  ======
const ENCOUNTERS=[
  {id:'rumor',weight:3,cond:()=>true,tip:'ä½ å¬åˆ°å…³äºç§˜å¢ƒçš„ä¼ é—»ã€‚',run:()=>say('åŠé—´ä¼ è¨€"è½æ˜Ÿç§˜å¢ƒ"å°†å¯ï¼Œå†…æœ‰æ— æ•°ç¾å§¬ä¾å¯ï¼Œå •è½ä¹‹æºã€‚')},
  {id:'healer',weight:1,cond:()=>GS.player.hp<GS.player.hp_max,tip:'é‡åˆ°å¥½å¿ƒéƒä¸­ã€‚',run:()=>{toast('éƒä¸­ä¸ºä½ æŠŠè„‰ï¼Œç›®å…‰åœ¨ä½ é¦™è‡€ä¸Šæµè¿ï¼Œæ‰‹æŒ‡æ¢å…¥éªšç©´ï¼Œå •è½å¢ã€‚');heal(2);GS.player.degen+=3;}},
  {id:'merchant',weight:2,cond:()=>GS.loc.includes('å¤§è¡—')||GS.loc.includes('é©¿ç«™'),tip:'å¶é‡è¡Œå•†ã€‚',run:()=>{const earn=rndInt(1,3);GS.stones+=earn;say('ä½ å¸®å•†è´©æ¬è´§ï¼Œå¾—çµçŸ³'+earn+'ï¼Œä»–è¶æœºæ‘¸ä½ ç¾è‡€ä¸€æŠŠï¼Œä½ ä¿è„¸å¾®çº¢ï¼Œå°ç©´æ¹¿æ¶¦ï¼Œå •è½åŠ æ·±ã€‚');GS.player.degen+=4;}},
  {id:'bandit',weight:1.6,cond:()=>GS.loc.includes('éƒŠå¤–')||GS.loc.includes('å¯†æ—'),tip:'å‰æ–¹æœ‰ä¼å‡»è¿¹è±¡ã€‚',run:()=>battle('bandit')},
  {id:'wolf',weight:1.3,cond:()=>GS.loc.includes('å¯†æ—'),tip:'æ—é—´ä¼ æ¥ä½åšã€‚',run:()=>battle('wolf')},
  {id:'snake',weight:1.0,cond:()=>GS.loc.includes('æ¹–')||GS.loc.includes('è°·')||GS.loc.includes('å¯†æ—'),tip:'è‰ä¸›çª¸çª£ä½œå“ã€‚',run:()=>battle('snake')},
  {id:'ghost',weight:0.5,cond:()=>weather.cur==='é›¾'&&GS.loc.includes('å¤äº•'),tip:'å†·é›¾å¼¥æ¼«ã€‚',run:()=>battle('ghost')},
  {id:'sect-invite',weight:0.7,cond:()=>!hasQuest('ç‰è¡¡å®—å…¥é—¨')&&GS.loc.includes('æ¸…é£é•‡'),tip:'ä¸€å°è½æ¬¾"ç‰è¡¡å®—"çš„ä¿¡ã€‚',run:()=>startQuest_Sect()},
  {id:'harass',weight:3.0,cond:()=>GS.player.gender==='å¥³',tip:'è·¯é‡ç™»å¾’å­ã€‚',run:()=>{say('ä¸€ç”·å­ä¸Šå‰è°ƒæˆï¼Œä½ é¦™è‡€è¢«æï¼Œéªšç©´ä¸€ç´§ï¼Œæ¬²å€¼+5ï¼Œå •è½+6ã€‚');GS.player.lust+=5;GS.player.degen+=6;}},
  {id:'brothel',weight:2.2,cond:()=>GS.loc.includes('é’æ¥¼'),tip:'é’æ¥¼é¦™é£æ‰‘é¼»ã€‚',run:()=>{say('ä½ è§ä¸€å¥³å­è¡£è¡«åŠè§£ï¼Œç‰ä¹³å¾®éœ²ï¼Œç¾è‡€æ‘‡æ›³ï¼Œé‚€ä½ å…¥å†…å…±æ¬¢ï¼Œä½ å •è½ä¹‹å¿ƒæ¶ŒåŠ¨ã€‚');GS.player.lust+=10;GS.player.degen+=7;}},
  {id:'rape',weight:1.2,cond:()=>GS.player.gender==='å¥³'&&GS.player.lust>50,tip:'æš—å··æœ‰äººå½±æ™ƒåŠ¨ã€‚',run:()=>{say('ä½ è¢«æ·«è´¼æ‹–å…¥å··ä¸­ï¼Œå¤§å±Œæ’å…¥éªšç©´ï¼Œè½®ç•ªæŠ½æ’ï¼Œç¾è‡€é¢¤åŠ¨ï¼Œé˜´æˆ·èœœæ±å››æº…ï¼Œé«˜æ½®è¿­èµ·ï¼Œæ€§ç»éªŒ+1ï¼Œå •è½æš´å¢ã€‚');GS.player.sex_exp+=1;GS.player.sensitivity+=2;GS.player.hp-=5;GS.player.lust=0;GS.player.degen+=15;}},
  {id:'beast_rape',weight:1.0,cond:()=>GS.loc.includes('æ—')||GS.loc.includes('çªŸ'),tip:'å…½å¼å›è¡ã€‚',run:()=>{say('ä½ è¢«æ·«å…½æ‰‘å€’ï¼Œå…½æ ¹ç‹ æ’ååº­ï¼Œéªšç©´å–·æ±ï¼Œé¦™è‡€è¢«çˆªç—•æŠ“æ»¡ï¼Œå •è½æ·±æ¸Šä¸€æ­¥ã€‚');GS.player.hp-=8;GS.player.degen+=12;GS.player.sensitivity+=3;}},
  {id:'cult_ritual',weight:0.8,cond:()=>GS.loc.includes('æ¸Š')||GS.loc.includes('å¡”'),tip:'é‚ªæ°”å¼¥æ¼«ã€‚',run:()=>{say('é‚ªä¿®å›´ä½ä½ ï¼Œè½®ç•ªä¾µçŠ¯ï¼Œé˜³å…·æ’å…¥é˜´ç©´ï¼Œç²¾æ¶²çŒæ»¡å­å®«ï¼Œä½ æµªå«ä¸æ­¢ï¼Œå •è½åº¦é£™å‡ã€‚');GS.player.sex_exp+=2;GS.player.degen+=20;GS.player.lust=0;}},
  {id:'public_humil',weight:1.5,cond:()=>GS.player.degen>30,tip:'è¡—å¤´å¼‚åŠ¨ã€‚',run:()=>{say('ä½ ä¸ç”±è‡ªä¸»åœ¨è¡—å¤´è‡ªæ‘¸ï¼Œè·¯äººå›´è§‚ï¼Œé¦™è‡€æ‘‡æ›³ï¼Œé˜´æˆ·æš´éœ²ï¼Œå •è½äº‹ä»¶è§¦å‘ã€‚');GS.player.degen+=10;GS.player.sensitivity+=2;}},
  {id:'slave_trade',weight:0.6,cond:()=>GS.player.degen>50&&GS.loc.includes('å··'),tip:'æš—å¸‚å–§å“—ã€‚',run:()=>{say('ä½ è¢«è´©å­æŠ“ä½ï¼Œæ‹å–å°ä¸Šè£¸ä½“å±•éœ²ï¼Œéªšç©´è¢«æŒ‡æ¢ï¼Œç¾è‡€è¢«æ‹ï¼Œä¹°ä¸»å¤§å±Œæ’å…¥ï¼Œå •è½å½»åº•ã€‚');GS.player.degen+=25;GS.player.partners+=1;}}
];
function pickEncounter(fromAll){const pool=ENCOUNTERS.filter(e=>e.cond());const tot=pool.reduce((s,e)=>s+e.weight,0);let r=RNG.next()*tot;for(const e of pool){r-=e.weight;if(r<=0){if(fromAll&&e.tip)toast(e.tip);return e}}return pool[0]}

// ====== å…³ç³»/å¯¹è¯ ======
function orientMatch(p){const o=GS.player.orient,g=GS.player.gender,pg=p.gender;if(o==='æ— æ€§')return false;if(o==='åŒæ€§')return true;if(o==='å¼‚æ€§')return g!==pg;if(o==='åŒæ€§')return g===pg;return true}
const LINES={greet:['ä½ å¥½ï¼Œå°å¨˜å­èº«æ®µçœŸå¦™ã€‚','åœ¨ä¸‹ä¹…ä»°ï¼Œéªšç©´å¯ç´§ï¼Ÿ','è¿™ä½è´±å©¢å¯è¦ä¾å¯ï¼Ÿ','å°éªšè´§ï¼Œå •è½äº†å¤šå°‘ï¼Ÿ'],small:['è¿‘æ—¥é£ç´§ï¼Œå¥³å­å‡ºè¡Œæ˜“è¢«è½®å¥¸ã€‚','å¬è¯´åŒ—å²­æœ‰æ·«å…½å‡ºæ²¡ã€‚','æ¸…é£é•‡èŠ±é­é˜´ç©´å¤šæ±ã€‚','å •è½ä¹‹è·¯ï¼Œä¸€æ­¥æ­¥èµ°ã€‚'],rom:['æœˆè‰²æ­£å¥½ï¼Œæ„¿æ“ä½ éªšç©´ã€‚','æ„¿ä¸ä½ å¹¶è‚©ï¼Œé˜³å…·æ’å…¥é˜´æˆ·ã€‚','å¿ƒæœ‰çµçŠ€ï¼Œç¾è‡€ç¿˜èµ·ç­‰å¤§å±Œã€‚','å •è½å§ï¼Œéªšè´§ã€‚']}
function openDialogue(npc){if(!npc){toast('é™„è¿‘æ— äººå¯è°ˆ');return}el('dlg-npc-name').textContent=npc.name;const log=el('dlg-log');const ch=el('dlg-choices');log.innerHTML=`<div class="pill">ä½ç½®ï¼š${npc.loc}</div><div class="pill">${npc.looks||''}</div>`;function add(t){const d=document.createElement('div');d.textContent=t;log.append(d);log.scrollTop=log.scrollHeight}
const ops=[{t:'æ‰“æ‹›å‘¼',run:()=>{add(npc.name+'ï¼š'+randPick(LINES.greet));npc.favor+=1;refresh()}},{t:'é—²èŠ',run:()=>{add(npc.name+'ï¼š'+randPick(LINES.small));if(RNG.roll(.4))npc.favor+=1;refresh()}},{t:'è¡¨è¾¾å–„æ„ï¼ˆé€ç¤¼ï¼šåªšè¯æ•£ï¼‰',run:()=>{if((GS.inventory['åªšè¯æ•£']||0)>0){GS.inventory['åªšè¯æ•£']--;npc.favor+=5;add('ä½ èµ å‡ºåªšè¯æ•£ï¼Œå¥¹æœç”¨åéªšç©´æ¹¿æ¶¦ï¼Œåªšçœ¼æµè½¬ã€‚');GS.player.charm+=1;refresh()}else add('ä½ èº«ä¸Šæ²¡æœ‰åªšè¯æ•£ã€‚')}},{t:'åˆ‡ç£‹ï¼ˆå¢ä¿¡ä»»ï¼‰',run:()=>{npc.trust+=rndInt(1,3);add('ä½ ä»¬ç•¥ä½œåˆ‡ç£‹ï¼Œå¥¹è¡£è¡«å‡Œä¹±ï¼Œç‰ä¹³å¤–éœ²ã€‚');refresh()}},{t:'é‚€è¯·çº¦ä¼š',show:()=>orientMatch(npc)&&npc.favor>=30,run:()=>{npc.favor+=2;add('ä½ ä»¬å…±èµç¯å½±ï¼Œå¥¹ä¿è„¸çº¢æ¶¦ï¼Œç¾è‡€è½»æ‘†ï¼Œå°ç©´å¾®æ¹¿ã€‚');refresh()}},{t:'ç»“ä¸ºé“ä¾£',show:()=>GS.player.age>=14&&!GS.player.married&&orientMatch(npc)&&npc.favor>=60,run:()=>{GS.player.married=true;GS.player.spouse={id:npc.id,name:npc.name,favor:npc.favor,age:npc.age,gender:npc.gender};add('ä½ ä»¬äº’æ¢ä¿¡ç‰©ï¼Œç»“ä¸ºé“ä¾£ï¼Œå½“å¤œå¤§å±Œæ’å…¥é˜´ç©´ï¼ŒæŠ½æ’ä¸æ­¢ï¼Œé«˜æ½®è¿è¿ã€‚');refresh()}},{t:'äº²å¯†ç›¸ä¼´ï¼ˆå¯èƒ½æ€€å­•ï¼‰',show:()=>GS.player.married&&GS.player.spouse?.id===npc.id,run:()=>{add('ä½ ä»¬ç›¸åè€Œçœ ï¼Œå¥¹é¦™è‡€ç¿˜èµ·ï¼Œéªšç©´ç´§è£¹é˜³å…·ï¼Œèœœæ±æ¨ªæµï¼Œè½®ç•ªäº¤åˆã€‚');tryConceive(npc);gainExp(2);GS.player.sex_exp+=1;GS.player.lust=0;GS.player.degen+=rndInt(5,10);refresh()}},{t:'å¼ºè¿«ä¾å¯',show:()=>npc.gender==='å¥³'&&npc.favor<20,run:()=>{add(`${npc.name}è¢«ä½ æŒ‰å€’ï¼Œç¾è‡€é«˜ç¿˜ï¼Œå¤§å±Œç‹ æ’é˜´ç©´ï¼Œå¥¹å“­å–Šä¸æ­¢ï¼Œéªšç©´ç´§ç¼©ï¼Œæ€§ç»éªŒ+1ã€‚`);npc.favor-=10;GS.player.sex_exp+=1;GS.player.sensitivity+=1;GS.player.degen+=8;refresh()}},{t:'å •è½è¯±å¯¼',show:()=>GS.player.degen>40&&npc.gender==='å¥³',run:()=>{add(`ä½ å¼•è¯±${npc.name}å •è½ï¼Œå…±æœåªšè¯ï¼Œé˜´ç©´äº’ç£¨ï¼Œé¦™è‡€ç›¸æ’ï¼Œæµªå«ä¸æ­¢ã€‚`);npc.favor+=3;GS.player.degen+=6;refresh()}}];
ch.innerHTML='';ops.filter(o=>!o.show||o.show()).forEach(o=>{const b=document.createElement('button');b.className='choice';b.textContent=o.t;b.onclick=()=>{o.run();render()};ch.append(b)});showModal('dialogue',true)}

// ====== ç”Ÿç†/æ€€å­•/å •è½ ======
function setupRepro(){const p=GS.player;p.menses.enabled=true;p.pregnancy.enabled=(p.fertile!=='no')}
function mensesTick(){const p=GS.player;if(!p.menses.enabled||p.pregnancy.pregnant)return;p.menses.day=(p.menses.day%p.menses.cycle)+1;p.menses.bleeding=(p.menses.day<=5);if(p.menses.bleeding){p.menses.comfort=Math.max(0,p.menses.comfort-1);if(p.menses.comfort<=0)p.hp=Math.max(1,p.hp-1);}else p.menses.comfort=0;if(p.menses.bleeding&&p.gender==='å¥³')say('ä½ ç»è¡€æ·‹æ¼“ï¼Œå°ç©´éšç—›ï¼Œæ¬²å€¼+5ã€‚');p.lust+=5;}
function fertile(){const p=GS.player;return p.menses.enabled&&!p.pregnancy.pregnant&&p.menses.day>=12&&p.menses.day<=16}
function tryConceive(npc){const female=GS.player;if(!female||!female.pregnancy.enabled||female.pregnancy.pregnant)return false;let base=fertile()?0.3:0.08;base+=(GS.player.charm||0)*0.01;if(RNG.roll(base)){female.pregnancy.pregnant=true;female.pregnancy.day=1;toast('ä¼¼æœ‰èº«å­•å¾å…†ï¼Œè…¹ä¸­æš–æµæ¶ŒåŠ¨');say('ä½ æ„Ÿåˆ°æ°”æœºå¾®å˜ï¼Œéªšç©´å†…ä¼¼æœ‰ç§å­è½åœ°ã€‚');return true}return false}
function pregnancyTick(){const p=GS.player;if(!p.pregnancy.enabled||!p.pregnancy.pregnant)return;p.pregnancy.day++;if(p.pregnancy.day%30===0)heal(1);if(p.pregnancy.day>=240){const name=randomName();GS.player.children.push({name,age:0});p.pregnancy.pregnant=false;p.pregnancy.day=0;toast('åˆ†å¨©é¡ºåˆ©ï¼Œæ¯å­å¹³å®‰');say('ä½ äº§ä¸‹ä¸€åå©´å„¿ï¼š'+name+'ï¼Œé˜´ç©´æ’•è£‚ï¼Œèœœæ±è¡€æ°´æ··æµã€‚')}}
function degenTick(){if(GS.player.degen>50&&RNG.roll(0.2)){say('å •è½ä¹‹å¿ƒæ¶ŒåŠ¨ï¼Œä½ ä¸ç”±è‡ªæ‘¸éªšç©´ï¼Œèœœæ±å–·æº…ã€‚');GS.player.lust+=10;}if(GS.player.degen>80&&RNG.roll(0.1)){triggerDegenEvent();}}
function triggerDegenEvent(){const events=['ä½ å •è½åŠ æ·±ï¼Œè¡—å¤´è·ªèˆ”è·¯äººå¤§å±Œï¼Œç²¾æ¶²æ»¡é¢ã€‚','å¹½å†¥æ´çªŸä¸­ï¼Œä½ è‡ªæ„¿è¢«é‚ªå…½è½®å¥¸ï¼Œååº­çŒæ»¡å…½ç²¾ã€‚','æ·«é­”å¡”å†…ï¼Œä½ æ±‚é‚ªä¿®çº¹èº«æ·«çº¹ï¼Œå°ç©´æ°¸æ¹¿ã€‚','è¡€æœˆæ—ï¼Œä½ å…¬å¼€è‡ªæ…°ï¼Œå¼•ç¾¤ç‹¼ä¾µçŠ¯ï¼Œå •è½å·…å³°ã€‚'];say(randPick(events));GS.player.degen+=rndInt(5,10);GS.player.sensitivity+=2;GS.player.sex_exp+=1;}

// ====== æ•°å€¼æˆé•¿ ======
function heal(v) {
    GS.player.hp = Math.min(GS.player.hp_max, GS.player.hp + v);
    if (v > 0) {
        const healMessages = [
            'ä½ å‘¨èº«æ°”è¡€æ¶ŒåŠ¨ï¼Œä¼¤å£æ¸åˆï¼Œè‚Œè‚¤æ¢å¤å…‰æ»‘å¦‚ç‰ï¼Œé¦™è‡€å¾®é¢¤ï¼Œå†…å¿ƒç‹¬ç™½ã€è¿™è‚¡æš–æµå¦‚æ˜¥é£æ‹‚æŸ³ï¼Œè®©æœ¬å®«çš„éªšç©´éšéšä½œç—’ï¼ŒçœŸæ˜¯åå·®ï¼Œè¡¨é¢çº¯æ´å†…å¿ƒå´æ¸´æœ›å¤§å±Œæ’å…¥ã€‘ã€‚',
            'æ„ˆç–—ä¹‹åŠ›æµè½¬å…¨èº«ï¼Œä¼¤ç—•æ¶ˆé€€ï¼Œç‰ä½“ç„•å‘å…‰æ³½ï¼Œç¾è‡€è½»æ‘‡ï¼Œå†…å¿ƒå‘¢å–ƒã€æš–æ„å¦‚æƒ…éƒçˆ±æŠšï¼Œæœ¬å®«çº¯æ´å¤–è¡¨ä¸‹ï¼Œç«Ÿæ¸´æœ›è¢«ç²—é²ä¾µçŠ¯ï¼Œéªšç©´æ¹¿æ¶¦éš¾è€ã€‘ã€‚',
            'æ°”è¡€å¤è‹ï¼Œåˆ›å£æ„ˆåˆï¼Œè‚Œè‚¤ç»†è…»å¦‚åˆï¼Œç¿˜è‡€é¢¤åŠ¨ï¼Œå†…å¿ƒè‡ªè¯­ã€è¿™æ²»æ„ˆä¼¼æ¸©æŸ”æ‹¥æŠ±ï¼Œå´æ¿€å‘æœ¬å®«æ·«æ¬²ï¼Œåå·®å©Šèˆ¬æƒ³è¢«å¤§å±ŒçŒ›æ…ã€‘ã€‚',
            'ç”Ÿå‘½åŠ›æ¶Œç°ï¼Œä¼¤ç—›æ¶ˆæ•£ï¼Œèº«èº¯å…‰æ»‘è¯±äººï¼Œè‡€éƒ¨å¾®åŠ¨ï¼Œå†…å¿ƒä½åŸã€å¦‚æ²æ˜¥é£çš„æ„ˆåˆï¼Œè®©æœ¬å®«å†…å¿ƒéªšåŠ¨ï¼Œè¡¨é¢è´æ´å´æ¸´æ±‚è½®å¥¸ç¾è¾±ã€‘ã€‚'
        ];
        say(randPick(healMessages));
        if (RNG.roll(0.2) && GS.player.charm > 50) {
            const charmBonusMessages = [
                'æ„ˆåˆä¸­é­…åŠ›åŠ æˆï¼Œç‰ä¹³æ›´ä¸°æ»¡ï¼Œç²‰çº¢ä¹³å¤´æŒºç«‹ï¼Œå¾®è¡¨æƒ…ä¿è„¸çº¢æ¶¦ï¼Œç¥æ€å¨‡åªšã€‚',
                'é­…åŠ›æå‡ï¼Œä¹³æˆ¿é¥±æ»¡æ™ƒåŠ¨ï¼Œä¹³æ™•ç²‰å«©ç¿˜èµ·ï¼Œè„¸åºç¾çº¢ï¼Œçœ¼ç¥å¦©åªšåŠ¨äººã€‚',
                'é¢å¤–é­…åŠ›å¢é•¿ï¼Œèƒ¸è„¯ä¸°ç›ˆæ‘‡æ›³ï¼Œä¹³å¤´ç¡¬æŒºè¯±äººï¼Œè¡¨æƒ…å¾®å¦™çº¢æ™•ï¼Œç¥æƒ…å¨‡ç¾æ¬²æ»´ã€‚',
                'æ„ˆç–—åŠ æŒé­…åŠ›ï¼Œç‰å³°ä¸°æ¶¦é¢¤åŠ¨ï¼Œç²‰å¤´åšæŒºï¼Œä¿è„¸æ³›çº¢ï¼Œå§¿æ€åªšæ€æ¯•ç°ã€‚'
            ];
            say(randPick(charmBonusMessages));
            GS.player.charm += 1;
        } else if (RNG.roll(0.1) && GS.player.degen > 30) {
            const degenFailMessages = [
                'å •è½å½±å“æ„ˆåˆï¼Œé˜´æˆ·æ¹¿æ¶¦èœœæ±æ»´è½ï¼Œç¾è‡€æ‘‡æ›³ï¼Œéšæœºå¤±è´¥hp-2ã€‚',
                'æ·«æ¬²å¹²æ‰°æ²»æ„ˆï¼Œéªšç©´åˆ†æ³Œæ·«æ¶²ï¼Œç¿˜è‡€æ‰­åŠ¨ï¼Œæ„å¤–æ‰£è¡€2ç‚¹ï¼Œæ¬²ç«æ›´ç››ã€‚',
                'å •è½å€¼é«˜å¯¼è‡´åå™¬ï¼Œä¸‹ä½“æ¹¿æ»‘æ±æ°´æµæ·Œï¼Œè‡€éƒ¨æ™ƒè¡ï¼Œhpæ„å¤–å‡2ã€‚',
                'è´Ÿé¢å½±å“å‘ä½œï¼Œç§å¤„æ½®æ¹¿æ»´è½ï¼Œç‰è‡€æ‘†åŠ¨ï¼Œæ„ˆåˆå¤±è´¥æŸå¤±2è¡€ã€‚'
            ];
            say(randPick(degenFailMessages));
            GS.player.hp -= 2;
            GS.player.lust += 5;
        }
    }
    refresh();
}

function spendQi(v) {
    if (GS.player.qi >= v) {
        GS.player.qi -= v;
        const spendMessages = [
            'çµåŠ›å¦‚æ±Ÿæ²³å†³å ¤ï¼Œå‘¨èº«ç©ºè™šï¼Œéªšç©´ä¸€ç´§ï¼Œå†…å¿ƒæ‚”æ¨ã€æœ¬å®«æ€å¦‚æ­¤æµªè´¹ï¼Œä¼¼é‚£æ·«å¦‡èˆ¬æ¬²ç«ç„šèº«ã€‘ã€‚',
            'çœŸå…ƒè€—æŸå¦‚æ´ªæ°´å¥”æµï¼Œèº«ä½“è™šå¼±ï¼Œä¸‹ä½“æ”¶ç¼©ï¼Œå†…å¿ƒè‡ªè´£ã€æµªè´¹çµåŠ›å¦‚è‡ªç”˜å •è½ï¼Œæœ¬å®«ç«Ÿå¦‚è¡å¦‡èˆ¬é¥¥æ¸´ã€‘ã€‚',
            'é½åŠ›æµå¤±ï¼Œå‘¨èº«ç–²æƒ«ï¼Œé˜´é“ç´§ç¼©ï¼Œæ‚”æ¨ä½è¯­ã€è¿™æ¶ˆè€—ä¼¼çºµæ¬²è¿‡åº¦ï¼Œè®©æœ¬å®«å†…å¿ƒæ·«ä¹±ä¸å ªã€‘ã€‚',
            'çµæ°”å¤–æ³„å¦‚å†³å£å¤§åï¼Œç©ºè™šæ„Ÿè¢­æ¥ï¼Œéªšç©´æŠ½åŠ¨ï¼Œå†…å¿ƒæ‡Šæ¼ã€æœ¬å®«æ€è¿™èˆ¬æŒ¥éœï¼ŒçŠ¹å¦‚æ·«å¥³æ±‚æ¬¢ã€‘ã€‚'
        ];
        say(randPick(spendMessages));
        if (RNG.roll(0.3) && GS.player.degen > 40) {
            const degenSuccessMessages = [
                'å •è½éšæœºæˆåŠŸï¼Œæ¬²å€¼+10ï¼Œæ•æ„Ÿ+1ï¼ŒåŠ¨ä½œå¾®é¢¤ï¼Œç¥æ€è¿·ç¦»ã€‚',
                'æ·«æ¬²åŠ å‰§ï¼Œlustå¢10ï¼Œæ•æ„Ÿåº¦å‡1ï¼Œèº«èº¯é¢¤æŠ–ï¼Œçœ¼ç¥æœ¦èƒ§è¿·ä¹±ã€‚',
                'è´Ÿé¢éšæœºè§¦å‘ï¼Œæ¬²æœ›é£™å‡10ç‚¹ï¼Œæ•æ„ŸåŠ 1ï¼Œè‚¢ä½“è½»é¢¤ï¼Œè¡¨æƒ…ææƒšã€‚',
                'å •è½å½±å“æ˜¾ç°ï¼Œlust+10ï¼Œsensitivity+1ï¼Œèº«ä½“æŠ–åŠ¨ï¼Œç¥æƒ…å¤±ç¥ã€‚'
            ];
            say(randPick(degenSuccessMessages));
            GS.player.lust += 10;
            GS.player.sensitivity += 1;
            return true;
        } else if (RNG.roll(0.15)) {
            const failMessages = [
                'èŠ±è´¹å¤±è´¥ï¼ŒçµåŠ›åå¼¹ï¼Œhp-3ï¼Œé¦™è‡€ç–¼ç—›å¦‚é­æ‰“ã€‚',
                'çœŸå…ƒåå™¬ï¼ŒæŸå¤±3è¡€ï¼Œç¾è‡€ç«è¾£å¦‚è¢«æŠ½æ‰“ï¼Œç—›æ¥šéš¾å¿ã€‚',
                'æ¶ˆè€—å‡ºé”™ï¼Œé½åŠ›é€†æµï¼Œhpæ‰£3ï¼Œç¿˜è‡€ç¼ç—›ä¼¼é­æŒã€‚',
                'å¤±è´¥åå¼¹ï¼Œç”Ÿå‘½å‡3ï¼Œè‡€éƒ¨å‰§ç—›å¦‚é­é­åˆ‘ã€‚'
            ];
            say(randPick(failMessages));
            GS.player.hp -= 3;
            return false;
        }
        refresh();
        return true;
    }
    return false;
}

function gainExp(v) {
    GS.player.exp += v;
    const expMessages = [
        'ç»éªŒå¦‚æ½®æ°´æ¶Œå…¥ï¼Œä½ å¢ƒç•Œéšéšæ¾åŠ¨ï¼Œé•¿å‘é£˜è¡ï¼Œç‰ä½“ç”Ÿè¾‰ï¼Œç¾è‡€ç¿˜èµ·ï¼Œç©¿ç€é±¼ç½‘ä¸è¢œçš„åŒè…¿è¯±äººï¼Œå†…å¿ƒç‹¬ç™½ã€è¿™å¢é•¿å¦‚å”è¯—æ˜¥é£å¾—æ„ï¼Œå´è®©æœ¬å®«éªšç©´æ¹¿æ¶¦ï¼Œåå·®å©Šèˆ¬æ¸´æœ›è½®å¥¸ã€‘ã€‚',
        'ä¿®ä¸ºæš´å¢å¦‚æ±Ÿæ²³å…¥æµ·ï¼Œå¢ƒç•ŒåŠ¨æ‘‡ï¼Œç§€å‘é£æ‰¬ï¼Œèº«èº¯å…‰èŠ’å››å°„ï¼Œç¿˜è‡€é«˜æŒºï¼Œä¸è¢œç¾è…¿æ’©äººï¼Œå†…å¿ƒä½åŸã€ç»éªŒå¦‚è¯—è¯åä¸½ï¼Œå´æ¿€å‘æœ¬å®«æ·«å¿ƒï¼Œè¡¨é¢çº¯æ´å†…å¿ƒæ±‚è¾±ã€‘ã€‚',
        'expæ¶Œå…¥å¦‚æµªæ½®ï¼Œå±‚æ¬¡æ¾åŠ¨ï¼Œé•¿å‘èˆåŠ¨ï¼Œè‚Œè‚¤é—ªè€€ï¼Œè‡€éƒ¨æŒºç¿˜ï¼ŒåŒè…¿ä¸è¢œè¯±æƒ‘ï¼Œå†…å¿ƒè‡ªè¯­ã€è¿™è¿›æ­¥ä¼¼å®‹è¯ä¼˜é›…ï¼Œæœ¬å®«å´æ¹¿äº†ä¸‹ä½“ï¼Œåå·®èˆ¬æ¸´æ±‚ç¾¤äº¤ã€‘ã€‚',
        'ç»éªŒæ³¨å…¥å¦‚æ´ªæµï¼Œå¢ƒç•Œå¾®é¢¤ï¼Œå‘ä¸é£˜é€¸ï¼Œç‰ä½“å‘å…‰ï¼Œç¾è‡€ä¸Šæ‰¬ï¼Œé±¼ç½‘è…¿éƒ¨è¿·äººï¼Œå†…å¿ƒå‘¢å–ƒã€å¢é•¿å¦‚æ˜¥é£å¾—æ„é©¬è¹„ç–¾ï¼Œå´è®©éªšç©´ç—’éš¾è€ï¼Œçº¯å¥³æ·«å¿ƒã€‘ã€‚'
    ];
    say(randPick(expMessages));
    while (GS.player.exp >= GS.player.exp_to_next) {
        GS.player.exp -= GS.player.exp_to_next;
        GS.player.level++;
        GS.player.exp_to_next = Math.floor(GS.player.exp_to_next * 1.4) + 5;
        GS.player.realm = realm(GS.player.level);
        GS.player.hp_max += 5;
        GS.player.qi_max += 3;
        GS.player.hp = GS.player.hp_max;
        GS.player.qi = GS.player.qi_max;
        GS.player.charm += 1;
        const levelUpMessages = [
            'å¢ƒç•Œçªç ´ï¼š' + GS.player.realm + ',é­…åŠ›å¢',
            'å±‚æ¬¡è·ƒå‡è‡³' + GS.player.realm + 'ï¼Œé­…åŠ›å€¼åŠ æˆã€‚',
            'çªç ´æˆåŠŸï¼š' + GS.player.realm + 'ï¼Œé­…åŠ›æå‡ã€‚',
            'ä¿®ä¸ºè¿›é˜¶' + GS.player.realm + 'ï¼Œé­…åŠ›+1ã€‚'
        ];
        toast(randPick(levelUpMessages));
        const breakthroughMessages = [
            'çªç ´ç¬é—´ï¼Œå‘¨èº«å…‰åç»½æ”¾ï¼Œä¹³æˆ¿å¾®å¾®èµ·ä¼ï¼Œç²‰çº¢ä¹³å¤´å› å…´å¥‹ç¡¬æŒºï¼Œå¾®è¡¨æƒ…çœ‰çœ¼å«æ˜¥ï¼Œç¥æ€ä»å®¹å´å†…å¿ƒæ·«è¡ï¼ŒéšæœºåŠ æˆatk+2ï¼Œdef+1ã€‚',
            'æ™‹çº§ä¸€åˆ»ï¼Œå…‰èŠ’çˆ†å°„ï¼Œç‰ä¹³é¢¤åŠ¨ï¼Œä¹³å¤´æŒºç«‹å…´å¥‹ï¼Œçœ¼ç¥å«æƒ…è„‰è„‰ï¼Œå§¿æ€ä¼˜é›…å†…å¿ƒæµªè¡ï¼Œé¢å¤–atk+2 def+1ã€‚',
            'å¢ƒç•Œå‡åï¼Œå‘¨èº«è¾‰è€€ï¼Œèƒ¸è„¯èµ·ä¼ï¼Œç²‰å¤´åšç¡¬ï¼Œçœ‰çœ¼æ˜¥æ„ï¼Œç¥æƒ…æ·¡å®šå´å¿ƒéªšï¼Œéšæœºå¢atk2 def1ã€‚',
            'çªç ´é—ªè€€ï¼Œå…¨èº«å…‰èŠ’ï¼Œä¹³æˆ¿æŠ–åŠ¨ï¼Œä¹³æ™•ç¿˜èµ·ï¼Œå¾®å¦™è¡¨æƒ…å«æ˜¥ï¼Œæ€åº¦å¹³é™å†…å¿ƒæ¬²ä¹±ï¼ŒåŠ æˆatk+2 def+1ã€‚'
        ];
        say(randPick(breakthroughMessages));
        GS.player.atk += 2;
        GS.player.def += 1;
        if (RNG.roll(0.4) && GS.player.charm > 60) {
            const charmGrowthMessages = [
                'é­…åŠ›é«˜ï¼Œé¢å¤–æˆé•¿ï¼Œç‰ä¹³ä¸°æ»¡æ‘‡æ™ƒï¼Œéªšç©´éšç°æ˜¥å…‰ï¼Œå •è½éšæœº+3ã€‚',
                'é«˜é­…åŠ›åŠ æŒï¼Œèƒ¸éƒ¨é¥±æ»¡æ™ƒè¡ï¼Œä¸‹ä½“æ˜¥å…‰ä¹ç°ï¼Œdegenæ„å¤–å¢3ã€‚',
                'é­…åŠ›å€¼ä¼˜ï¼Œé¢å¤–å‘è‚²ï¼Œç‰å³°ä¸°ç›ˆé¢¤åŠ¨ï¼Œé˜´æˆ·éœ²å…‰ï¼Œå •è½+3éšæœºã€‚',
                'é­…æƒ‘å¼ºï¼Œæˆé•¿åŠ æˆï¼Œä¹³æˆ¿ä¸°æ¶¦æ‘‡æ›³ï¼Œéªšå¤„éšçº¦ï¼Œdegen+3ã€‚'
            ];
            say(randPick(charmGrowthMessages));
            GS.player.degen += 3;
        } else if (RNG.roll(0.2)) {
            const growthFailMessages = [
                'æˆé•¿å¤±è´¥ï¼Œå¢ƒç•Œä¸ç¨³ï¼Œhp_max-2ï¼Œå†…å¿ƒæ‚”æ¨ã€æœ¬å®«æ€å¦‚æ­¤è„†å¼±ï¼Œå¦‚é‚£è¢«å¤§å±Œæ“çƒ‚çš„æ·«å¦‡ã€‘ã€‚',
                'è¿›é˜¶å‡ºé”™ï¼Œå±‚æ¬¡åŠ¨æ‘‡ï¼Œhp_maxæ‰£2ï¼Œè‡ªè´£ã€æœ¬å®«å¼±å¦‚è¢«æ“ç¿»çš„è¡å¦‡ï¼Œæ‚”æ¨ä¸å·²ã€‘ã€‚',
                'å¤±è´¥æˆé•¿ï¼Œå¢ƒç•Œä¸å›ºï¼Œæœ€å¤§è¡€å‡2ï¼Œå†…å¿ƒæ‡Šæ¼ã€æ€è¿™èˆ¬ä¸å ªï¼Œä¼¼æ·«å¥³è¢«å¤§æ£’æ‘§æ¯ã€‘ã€‚',
                'å‘è‚²å—é˜»ï¼Œç¨³å›ºå¤±è´¥ï¼Œhp_max-2ï¼Œæ‚”æ¨ä½è¯­ã€æœ¬å®«è„†å¼±å¦‚å©Šå­è¢«è½®ã€‘ã€‚'
            ];
            say(randPick(growthFailMessages));
            GS.player.hp_max -= 2;
        }
    }
    if (GS.player.level % 5 === 0) {
        const milestoneMessages = [
            'æ¯5çº§é‡Œç¨‹ç¢‘ï¼Œéšæœºè§£é”æ–°æŠ€èƒ½â€œæ¬²ç«æŒâ€ï¼Œdmg[8,15]ï¼Œä½†ä½¿ç”¨ålust+10ã€‚',
            '5çº§æ ‡å¿—ï¼Œæ„å¤–è·å¾—â€œæ¬²ç«æŒâ€æŠ€èƒ½ï¼Œä¼¤å®³8-15ï¼Œä½¿ç”¨å¢lust10ã€‚',
            'é‡Œç¨‹ç¢‘è¾¾æˆï¼Œè§£é”â€œæ¬²ç«æŒâ€ï¼ŒdmgèŒƒå›´8è‡³15ï¼Œä»£ä»·lust+10ã€‚',
            'æ¯äº”çº§ä¸€ç¢‘ï¼Œæ–°æ‹›â€œæ¬²ç«æŒâ€åŠ å…¥ï¼Œ8-15ä¼¤ï¼Œä½†æ¬²æœ›å‡10ã€‚'
        ];
        say(randPick(milestoneMessages));
        GS.player.skills.push({id: 'firepalm', name: 'æ¬²ç«æŒ', qi: 5, dmg: [8, 15], spd: 6, desc: 'æŒå‡ºæ¬²ç«ç„šæ•Œã€‚'});
    }
    refresh();
}

function realm(l) {
    let desc = '';
    if (l < 4) {
        const lowRealmMessages = [
            `ç»ƒæ°”${l}å±‚ï¼Œçµæ°”åˆå‡ï¼Œä½ è‚Œè‚¤æ›´å«©ï¼Œé¦™è‡€åœ†æ¶¦ï¼Œå†…å¿ƒã€å¢ƒç•Œä½å¾®ï¼Œå´æ¬²å¿µèŒç”Ÿï¼Œåå·®å¦‚çº¯å¥³é‡æ·«è´¼ã€‘ã€‚`,
            `æ°”ç»ƒ${l}å±‚ï¼ŒçœŸå…ƒåˆèšï¼Œçš®è‚¤ç»†è…»ï¼Œç¿˜è‡€ä¸°æ»¡ï¼Œå†…å¿ƒä½è¯­ã€ä½é˜¶å´æ·«å¿ƒåˆåŠ¨ï¼Œè´æ´å¤–è¡¨ä¸‹å¦‚é‡è´¼å­ã€‘ã€‚`,
            `ç‚¼æ°”${l}é˜¶ï¼ŒçµåŠ›å‡ç»“ï¼Œç‰è‚¤å«©æ»‘ï¼Œç¾è‡€åœ†æ¶¦ï¼Œè‡ªè¯­ã€å¾®å¼±å¢ƒç•Œæ¿€å‘æ¬²ç«ï¼Œåå·®çº¯å¥³æ·«è´¼ã€‘ã€‚`,
            `åˆç‚¼æ°”${l}ï¼Œæ°”å‡è‚¤å«©ï¼Œè‡€éƒ¨é¥±æ»¡ï¼Œå†…å¿ƒã€ä½å¾®å´èŒç”Ÿæµªæ„ï¼Œå¦‚æ·‘å¥³é€¢æ­¹å¾’ã€‘ã€‚`
        ];
        desc = randPick(lowRealmMessages);
    } else if (l < 7) {
        const midRealmMessages = [
            `ç‚¼ä½“${l-3}æ®µï¼Œä½“é­„å¼ºå¥ï¼Œç‰ä¹³åšæŒºï¼Œå¾®åŠ¨ä½œæ‘‡æ›³ç”Ÿå§¿ï¼Œç¥æ€ä¼˜é›…ã€‚`,
            `ä½“ç‚¼${l-3}æ®µï¼Œèº¯ä½“å¥å£®ï¼Œèƒ¸è„¯æŒºæ‹”ï¼ŒåŠ¨ä½œæ™ƒåŠ¨è¯±äººï¼Œå§¿æ€é«˜é›…ã€‚`,
            `ç‚¼ä½“${l-3}é˜¶ï¼Œèº«ä½“å¼ºéŸ§ï¼Œç‰å³°åšå®ï¼Œæ‘‡æ›³å§¿åŠ¿ï¼Œç¥æƒ…æ–‡é™ã€‚`,
            `ä¸­ç‚¼ä½“${l-3}ï¼Œä½“å¥ä¹³æŒºï¼Œå¾®åŠ¨ç”Ÿå§¿ï¼Œä¼˜é›…ç¥æ€ã€‚`
        ];
        desc = randPick(midRealmMessages);
    } else if (l < 10) {
        desc = 'ç­‘åŸºå‰æœŸï¼Œæ ¹åŸºç¨³å›ºï¼Œéªšç©´ç´§è‡´ï¼Œé­…åŠ›éšæœº+2ã€‚';
        GS.player.charm += 2;
    } else if (l < 13) {
        desc = 'ç­‘åŸºä¸­æœŸï¼ŒçµåŠ›å……ç›ˆï¼Œå •è½æ˜“å¢ï¼Œå†…å¿ƒç‹¬ç™½ã€çªç ´å¦‚é«˜æ½®ï¼Œæµªå«ä¸æ­¢ã€‘ã€‚';
    } else {
        desc = 'ç­‘åŸºåæœŸï¼ŒçœŸå…ƒåœ†æ»¡ï¼Œç¾è²Œå·…å³°ï¼Œéšæœºäº‹ä»¶ç‡+10%ã€‚';
        GS.flags.event_rate += 0.1;
    }
    say(desc);
    return desc;
}

function addItem(n, amt = 1) {
    GS.inventory[n] = (GS.inventory[n] || 0) + amt;
    const addMessages = [
        'è·å¾—ç‰©å“' + n + ' x' + amt + 'ï¼Œä½ ç‰æ‰‹è½»æ¡ï¼Œä¹³æˆ¿å¾®é¢¤ï¼Œå†…å¿ƒã€è¿™å®ç‰©å¦‚é˜³å…·èˆ¬è¯±äººï¼Œæœ¬å®«è¿™ç«Ÿç„¶åƒå©Šå­èˆ¬æƒ³è‡ªæ…°ã€‘ã€‚',
        'ç‰©å“å…¥å›Š' + n + 'Ã—' + amt + 'ï¼Œçº¤æ‰‹æ‰§ç‰©ï¼Œèƒ¸è„¯æŠ–åŠ¨ï¼Œè‡ªè¯­ã€å®è´ä¼¼å¤§å±Œæ’©äººï¼Œæœ¬å®«ç«Ÿå¦‚æ·«å¦‡æ¬²è‡ªæ¸ã€‘ã€‚',
        'æ–°å¢' + n + ' ' + amt + 'ä¸ªï¼Œæ‰‹æŒè½»é¢¤ï¼Œç‰ä¹³èµ·ä¼ï¼Œå†…å¿ƒã€è¿™ç‰©å¦‚é˜´èŒè¯±æƒ‘ï¼Œå©Šå­èˆ¬æƒ³æ‰‹æ·«ã€‘ã€‚',
        'è·å–' + n + 'Ã—' + amt + 'ï¼Œæ¡ç‰©ä¹³é¢¤ï¼Œæ‚”æ¨ã€å®å¦‚é˜³ç‰©ï¼Œæœ¬å®«æµªå¿ƒæƒ³è‡ªæ…°ã€‘ã€‚'
    ];
    say(randPick(addMessages));
    if (RNG.roll(0.2) && n.includes('ä¸¹')) {
        const successMessages = [
            'éšæœºæˆåŠŸï¼Œé¢å¤–æ•ˆæœlust+5ã€‚',
            'æ„å¤–åŠ æˆï¼Œæ¬²æœ›å¢5ã€‚',
            'æˆåŠŸè§¦å‘ï¼Œlustå‡5ç‚¹ã€‚',
            'é¢å¤–lust+5éšæœºã€‚'
        ];
        say(randPick(successMessages));
        GS.player.lust += 5;
    } else if (RNG.roll(0.1)) {
        const failMessages = [
            'æ·»åŠ å¤±è´¥ï¼Œç‰©å“æŸåï¼Œdegen+2ã€‚',
            'ç‰©å“ç ´æŸï¼Œå •è½å€¼åŠ 2ã€‚',
            'å¤±è´¥ä¸¢å¤±ï¼Œdegenå‡2ã€‚',
            'æŸåéšæœºï¼Œdegen+2ã€‚'
        ];
        say(randPick(failMessages));
        GS.inventory[n] -= 1;
        GS.player.degen += 2;
    }
    refresh();
}

function randomName() {
    const f = ['æ', 'ç‹', 'èµµ', 'å­™', 'å‘¨', 'è‹', 'æ²ˆ', 'æ—', 'é—»', 'è°¢', 'é¡¾', 'ç§¦', 'ç™½', 'æ±Ÿ'];
    const g = ['æ™“', 'å©‰', 'å²š', 'å‡', 'çƒŸ', 'èˆŸ', 'å¢¨', 'è¾', 'ç¬™', 'è¡¡', 'æ™š', 'éœ', 'ç–', 'å½±'];
    const name = randPick(f) + randPick(g);
    const nameMessages = [
        'éšæœºå§“å' + name + 'ï¼Œæ–‡è‰ºå¦‚å®‹è¯â€œæ™“é£æ®‹æœˆâ€ï¼Œå´å†…å¿ƒæ·«è¡ã€‚',
        'ç”Ÿæˆåå­—' + name + 'ï¼Œè¯—æ„ä¼¼â€œæŸ³æ°¸è¯â€ï¼Œå†…å¿ƒå´æµªè¡ä¸å ªã€‚',
        'æ–°å' + name + 'ï¼Œä¼˜é›…å¦‚å¤è¯—ï¼Œå´å¿ƒéªšåŠ¨æ¬²ã€‚',
        'å§“åéšæœº' + name + 'ï¼Œæ–‡è‰ºé£å´æ·«å¿ƒæ¯•ç°ã€‚'
    ];
    say(randPick(nameMessages));
    return name;
}

// ====== æˆ˜æ–— ======
const Battle = { active: false, round: 1, enemy: null, me: { hp: 0, qi: 0 }, timeline: [], log: [], loc: '' };

function battle(id) {
    const e = GS.bestiary.find(x => x.id === id);
    if (!e) return;
    const battleStartMessages = [
        'æˆ˜æ–—å¼€å§‹ï¼Œä½ é•¿è£™é£˜æ‰¬ï¼Œç‰è¶³å¦‚å°¤ç‰©èˆ¬è¯±äººï¼Œç¾è‡€ç¿˜èµ·ï¼Œç¥æ€è­¦æƒ•ç€å¯¹æ–¹ï¼Œå†…å¿ƒæƒ³ç€ã€è¿™æ•Œå¦‚å¤§å±Œèˆ¬å‡¶çŒ›ï¼Œæœ¬å®«å´æƒ³è¢«å¤§å±ŒçŒ›æ“ã€‘ã€‚',
        'å¼€æˆ˜ä¸€åˆ»ï¼Œé•¿è£™é£èˆï¼Œç¾è¶³æ’©äººï¼Œç¿˜è‡€æŒºç«‹ï¼Œè­¦è§‰ç¥æƒ…ï¼Œå†…å¿ƒä½è¯­ã€æ•Œäººä¼¼ç²—æ£’ï¼Œæœ¬å®«æ¸´æœ›è¢«æ’ã€‘ã€‚',
        'æˆ˜ç«ç‚¹ç‡ƒï¼Œè£™æ‘†è¡æ¼¾ï¼Œç‰è…¿è¯±æƒ‘ï¼Œè‡€éƒ¨é«˜ç¿˜ï¼Œè­¦æƒ•å§¿æ€ï¼Œè‡ªè¯­ã€æ•Œå¦‚é˜³å…·å‡¶ç‹ ï¼Œæœ¬å®«æ·«å¿ƒæƒ³è¢«å¹²ã€‘ã€‚',
        'æˆ˜æ–—çˆ†å‘ï¼Œé£˜é€¸é•¿è£™ï¼Œè¶³éƒ¨å°¤ç‰©ï¼Œé¦™è‡€ç¿˜èµ·ï¼Œç¥æ€é˜²å¤‡ï¼Œå†…å¿ƒã€è¿™å¯¹æ‰‹å¦‚å¤§é¸¡å·´ï¼Œæœ¬å®«åå·®æ±‚æ“ã€‘ã€‚',
        'æ•Œè¢­æ¥ä¸´ï¼Œä½ è„±ä¸‹å¤–è¡£æ±‚é¥¶ã€ä¸»äººé¥¶å‘½ï¼Œæœ¬å®«æ„¿åšæ¯ç‹—ï¼Œè„±è¡£ä»»æ“ã€‘ï¼Œä½†æ•Œæ— åŠ¨äºè¡·ï¼Œç»§ç»­æ”»å‡»ã€‚',
        'æˆ˜ä¸­å´©æºƒï¼Œä½ è·ªåœ°æ±‚é¥¶ã€æ±‚æ±‚ä½ åˆ«æ‰“äº†ï¼Œæœ¬å®«è‡ªè„±ä¸è¢œï¼Œè®©ä½ ç©å¼„éªšç©´ã€‘ï¼Œæ•Œæ–¹ç‹ç¬‘ä¸æ­¢ã€‚',
        'è¢«æ‰“ç¾è¾±ï¼Œä½ å“­å–Šã€ä¸è¦å†æ‰‡å¥¶å­äº†ï¼Œæœ¬å®«æ˜¯è´±å©Šï¼Œæ„¿è·ªèˆ”å¤§å±Œæ±‚é¥¶ã€‘ã€‚',
        'æˆ˜æ–—ä¸­ä½ å´©æºƒè„±è¡£ã€æœ¬å®«è„±å…‰è¡£æœï¼Œç¿˜è‡€æ±‚æ’ï¼Œé¥¶å‘½å•Šä¸»äººã€‘ã€‚'
    ];
    say(randPick(battleStartMessages));
    Battle.active = true;
    Battle.round = 1;
    Battle.enemy = JSON.parse(JSON.stringify(e));
    Battle.me = { hp: GS.player.hp, qi: GS.player.qi };
    Battle.loc = GS.loc;
    Battle.timeline = [];
    Battle.log = [];
    openBattle();
    rollTL();
    renderBattle();
    if (RNG.roll(0.2) && GS.player.degen > 50) {
        const degenDebuffMessages = [
            'å •è½å½±å“ï¼Œæˆ˜æ–—éšæœºå‡atk-2ã€‚',
            'æ·«æ¬²å¹²æ‰°ï¼Œatkæ‰£2ç‚¹ã€‚',
            'è´Ÿé¢å‘ä½œï¼Œæ”»å‡»åŠ›å‡2ã€‚',
            'degené«˜å¯¼è‡´atk-2éšæœºã€‚'
        ];
        say(randPick(degenDebuffMessages));
        GS.player.atk -= 2;
    }
}

function rollTL() {
    Battle.timeline.length = 0;
    const meSpd = 6 + (GS.player.skills.reduce((m, s) => Math.max(m, s.spd || 0), 0)) / 10;
    const enSpd = Battle.enemy.spd;
    for (let i = 0; i < 10; i++) {
        Battle.timeline.push({ who: 'me', at: Math.random() * meSpd });
        Battle.timeline.push({ who: 'en', at: Math.random() * enSpd });
    }
    Battle.timeline.sort((a, b) => a.at - b.at);
    const tlMessages = [
        'è¡ŒåŠ¨é¡ºåºå¦‚å®‹è¯â€œä¸œé£æ¶â€ï¼Œéšæœºè‹¥GS.player.charm>70ï¼ŒmeSpd+1ã€‚',
        'é¡ºåºç”Ÿæˆä¼¼è¯—è¯é˜´éƒï¼Œè‹¥é­…åŠ›è¶…70ï¼Œé€Ÿåº¦åŠ 1éšæœºã€‚',
        'timelineå¦‚â€œä¸œé£æ¶æ¬¢æƒ…è–„â€ï¼Œcharm>70æ—¶meSpd+1ã€‚',
        'è¡ŒåŠ¨çº¿æ–‡è‰ºè¯—æ„ï¼Œè‹¥charmé«˜ï¼Œspdå¢1ã€‚'
    ];
    say(randPick(tlMessages));
    if (GS.player.charm > 70) meSpd += 1;  // Note: This is after calculation, might need adjustment, but keeping logic.
}

function openBattle() {
    showModal('battle', true);
    el('battle-loc').textContent = Battle.loc;
    el('round-num').textContent = Battle.round;
    el('battle-close').disabled = true;
    fillBattleSkills();
    const openMessages = [
        'æˆ˜åœºå¼€å¯ï¼Œä½ å§¿åŠ¿ä¼˜é›…ï¼Œä¹³æˆ¿èµ·ä¼ï¼Œå¾®è¡¨æƒ…çœ‰è¹™ï¼Œå†…å¿ƒå¿ƒæƒ³ã€æˆ˜æ–—å¦‚æ€§äº¤ï¼Œå¥½æƒ³è¢«æ“åˆ°é«˜æ½®ã€‘ã€‚',
        'æˆ˜å±€æ‰“å¼€ï¼Œä¼˜é›…å§¿æ€ï¼Œèƒ¸è„¯é¢¤åŠ¨ï¼Œçœ‰çœ¼å¾®çš±ï¼Œè‡ªè¯­ã€æ‰“æ–—ä¼¼äº¤åˆï¼Œæœ¬å®«æ¸´æ±‚é«˜æ½®ã€‘ã€‚',
        'å¼€å¯æˆ˜æ–—ï¼Œæ›¼å¦™å§¿åŠ¿ï¼Œç‰ä¹³æŠ–åŠ¨ï¼Œè¡¨æƒ…è¹™çœ‰ï¼Œå†…å¿ƒã€æˆ˜å¦‚åšçˆ±ï¼Œæƒ³è¢«å¹²ç¿»ã€‘ã€‚',
        'æˆ˜åœºç°èº«ï¼Œä¼˜é›…èº«å§¿ï¼Œä¹³æˆ¿èµ·ä¼ï¼Œå¾®å¦™çœ‰è¹™ï¼Œå†…å¿ƒã€è¿™å¦‚æ€§çˆ±ï¼Œæ±‚æ“è‡³å·…å³°ã€‘ã€‚',
        'å¼€æˆ˜å´©æºƒï¼Œä½ æ±‚é¥¶ã€ä¸»äººï¼Œæœ¬å®«æ„¿è„±è¡£è·ªèˆ”ï¼Œé¥¶è¿‡è´±å¥´å§ã€‘ã€‚',
        'è¢«ç¾è¾±ä¸­ï¼Œä½ è„±è£™ã€åˆ«æ‰“äº†ï¼Œæœ¬å®«è‡ªè„±æ±‚é¥¶ï¼Œè®©ä½ ç©å¥¶å­ã€‘ã€‚'
    ];
    say(randPick(openMessages));
}

function renderBattle() {
    el('me-hp').textContent = `${Battle.me.hp}/${GS.player.hp_max}`;
    el('me-qi').textContent = `${Battle.me.qi}/${GS.player.qi_max}`;
    el('en-name').textContent = Battle.enemy.name;
    el('en-hp').textContent = `${Battle.enemy.hp}`;
    const tl = el('timeline');
    tl.innerHTML = '';
    Battle.timeline.slice(0, 10).forEach(n => {
        const c = document.createElement('span');
        c.className = 'chip ' + (n.who === 'me' ? 'me' : '');
        c.textContent = n.who === 'me' ? 'æˆ‘' : 'æ•Œ';
        tl.append(c);
    });
    el('battle-log').innerHTML = Battle.log.map(x => `<div>${x}</div>`).join('');
    const renderMessages = [
        'æˆ˜åœºæ¸²æŸ“ï¼Œä½ åŠ¨ä½œè¿…æ·ï¼Œé¦™è‡€æ‰­åŠ¨ï¼Œé•¿å‘é£èˆï¼Œç¥æ€ä¸“æ³¨ã€‚',
        'ç”»é¢æ›´æ–°ï¼Œè¿…çŒ›åŠ¨ä½œï¼Œç¿˜è‡€æ‘†åŠ¨ï¼Œç§€å‘ä¹±èˆï¼Œç¥æƒ…é›†ä¸­ã€‚',
        'æ¸²æŸ“æˆ˜å±€ï¼Œå¿«æ·èº«æ³•ï¼Œç¾è‡€æ‘‡æ›³ï¼Œå‘ä¸é£æ‰¬ï¼Œä¸“æ³¨å§¿æ€ã€‚',
        'æˆ˜åœºé‡ç»˜ï¼Œæ•æ·å§¿åŠ¿ï¼Œè‡€éƒ¨æ‰­åŠ¨ï¼Œé•¿å‘é£˜è¡ï¼Œç¥æ€ä¸“å¿ƒã€‚',
        'æ¸²æŸ“ä¸­è¢«æ‰“ï¼Œä½ å“­å–Šã€å•Šï¼åˆ«æ‰‡è‡€äº†ï¼Œæœ¬å®«æ˜¯è´±è´§ï¼Œæ±‚é¥¶ã€‘ã€‚',
        'ç¾è¾±æ¸²æŸ“ï¼Œä½ å´©æºƒã€ä¸»äººé¥¶å‘½ï¼Œæœ¬å®«è„±å…‰ä»»æ“ã€‘ã€‚'
    ];
    say(randPick(renderMessages));
    if (RNG.roll(0.1)) {
        const visualMessages = [
            'éšæœºè§†è§‰ï¼Œæ•Œæ–¹å¤§å±Œæš´éœ²ï¼Œå†…å¿ƒç‹¬ç™½ã€è¿™é˜³ç‰©å¦‚æ­¤ç²—é•¿ï¼Œæœ¬å®«è¦æ˜¯æˆ˜è´¥ï¼Œå¿…ç„¶è¢«æ­¤ç‰©å¹²æ˜è¿‡å»ã€‘ã€‚',
            'æ„å¤–ç”»é¢ï¼Œæ•Œäººé˜´èŒæ˜¾éœ²ï¼Œè‡ªè¯­ã€ç²—é•¿å¤§æ£’ï¼Œè‹¥è´¥å¿…è¢«æ“æ™•ã€‘ã€‚',
            'è§†è§‰éšæœºï¼Œæ•Œå¤§å±Œç°èº«ï¼Œå†…å¿ƒã€è¿™ç‰©å‡¶çŒ›ï¼Œè´¥åŒ—å¿…æ˜å¥ã€‘ã€‚',
            'æš´éœ²éšæœºï¼Œé˜³å…·ç²—å¤§ï¼Œæ‚”æ¨ã€æˆ˜è´¥å®šè¢«å¹²ç¿»ã€‘ã€‚',
            'è§†è§‰ä¸­æ±‚é¥¶ã€çœ‹åˆ°å¤§å±Œï¼Œæœ¬å®«æ„¿è·ªèˆ”æ±‚ä¸æ‰“ã€‘ã€‚'
        ];
        say(randPick(visualMessages));
    }
}

function bLog(m) {
    Battle.log.push(m);
    renderBattle();
    const logMessages = [
        'æˆ˜æ–—æ—¥å¿—ï¼š' + m + 'ï¼Œä½ è¡¨æƒ…ç—›æ¥šï¼Œç‰ä½“é¢¤åŠ¨ï¼Œéªšç©´éšéšä½œæ¹¿ï¼Œçº¯æ´å¤–è¡¨å†…å¿ƒæ·«è¡ä¸æ­¢ã€‚',
        'æ—¥å¿—æ·»åŠ ï¼š' + m + 'ï¼Œç—›è¡¨æƒ…ï¼Œèº«èº¯æŠ–åŠ¨ï¼Œä¸‹ä½“æ¹¿æ¶¦ï¼Œè´æ´å¤–æ·«å¿ƒã€‚',
        'è®°å½•' + m + 'ï¼Œç—›è‹¦ç¥æƒ…ï¼Œç‰ä½“é¢¤ï¼Œéªšå¤„æ½®æ¹¿ï¼Œåå·®æ·«è¡ã€‚',
        'logï¼š' + m + 'ï¼Œç—›æ¥šè„¸åºï¼Œèº«æŠ–ç©´æ¹¿ï¼Œçº¯å¤–æµªå†…ã€‚',
        'æ—¥å¿—ä¸­è¢«è¾±ï¼Œä½ æ±‚ã€åˆ«è®°å½•äº†ï¼Œæœ¬å®«è„±è¡£å´©æºƒæ±‚é¥¶ã€‘ã€‚'
    ];
    say(randPick(logMessages));
}

function fillBattleSkills() {
    const box = el('battle-skills');
    box.innerHTML = '';
    GS.player.skills.forEach(sk => {
        const b = document.createElement('button');
        b.className = 'choice';
        b.innerHTML = `<b>${sk.name}</b>ï¼ˆè€—çµ${sk.qi} é€Ÿ${sk.spd}ï¼‰`;
        b.onclick = () => useSkill(sk);
        if (sk.qi > Battle.me.qi) b.setAttribute('disabled', '');
        box.append(b);
    });
    const fillMessages = [
        'æŠ€èƒ½å¡«å……ï¼Œä½ æ‰‹åŠ¿ä¼˜é›…ï¼ŒæŒ‡å°–å¦‚å…°ï¼Œå†…å¿ƒã€è¿™äº›æ‹›å¼å¦‚åšçˆ±èˆ¬é”€é­‚ã€‘ã€‚',
        'æ‹›å¼åŠ è½½ï¼Œä¼˜é›…æ‰‹åŠ¿ï¼Œå…°èŠ±æŒ‡å°–ï¼Œè‡ªè¯­ã€æŠ€èƒ½ä¼¼äº¤åˆé”€é­‚ã€‘ã€‚',
        'å¡«å……æŠ€èƒ½ï¼Œæ›¼å¦™æ‰‹å§¿ï¼ŒæŒ‡å¦‚å¹½å…°ï¼Œå†…å¿ƒã€æ‹›å¦‚æ€§çˆ±è¿·äººã€‘ã€‚',
        'æŠ€èƒ½æ³¨å…¥ï¼Œä¼˜é›…æŒ‡åŠ¿ï¼Œå†…å¿ƒã€å¦‚åšçˆ±èˆ¬å‹¾é­‚ã€‘ã€‚',
        'å¡«å……ä¸­å´©æºƒã€æŠ€èƒ½å¤ªå¤šï¼Œæœ¬å®«æ„¿è„±ä¸è¢œæ±‚ä¸æˆ˜ã€‘ã€‚'
    ];
    say(randPick(fillMessages));
    if (RNG.roll(0.25) && GS.player.degen > 60) {
        const extraSkillMessages = [
            'å •è½éšæœºï¼Œé¢å¤–æŠ€èƒ½â€œåªšæƒ‘å‡»â€ï¼Œdmg[0,0]ä½†æ•Œspd-2ã€‚',
            'æ·«æ¬²è§¦å‘ï¼Œæ–°æ‹›â€œåªšæƒ‘å‡»â€ï¼Œæ— ä¼¤ä½†æ•Œé€Ÿå‡2ã€‚',
            'éšæœºåŠ â€œåªšæƒ‘å‡»â€ï¼Œä¼¤å®³0ä½†spdæ•Œ-2ã€‚',
            'degené«˜è§£é”â€œåªšæƒ‘å‡»â€ï¼Œæ•Œé€Ÿé™2æ— dmgã€‚'
        ];
        say(randPick(extraSkillMessages));
        GS.player.skills.push({id: 'charmhit', name: 'åªšæƒ‘å‡»', qi: 2, dmg: [0, 0], spd: 8, desc: 'åªšçœ¼é™ä½æ•Œé€Ÿã€‚'});
    }
}

function useSkill(sk) {
    if (!Battle.active) return;
    if (Battle.me.qi < sk.qi) {
        bLog('çµåŠ›ä¸è¶³ã€‚');
        const qiFailMessages = [
            'ä½¿ç”¨å¤±è´¥ï¼Œä½ æ°”è¡€ç¿»æ¶Œï¼Œé›ªç™½çš„å¥¶å­æ‘‡æ™ƒï¼Œå†…å¿ƒæ‚”æ¨ã€çµåŠ›å¦‚æ¬²ç«ï¼ŒçµåŠ›ä¸è¶³æ€èƒ½å¾¡æ•Œã€‘ã€‚',
            'é½ä¸è¶³ï¼Œè¡€æ°”æ¶ŒåŠ¨ï¼Œç™½ä¹³é¢¤ï¼Œè‡ªè´£ã€çœŸå…ƒå°‘å¦‚æ¬²ä¸è¶³ï¼Œæ€æ•Œã€‘ã€‚',
            'å¤±è´¥æ–½å±•ï¼Œç¿»æ¶Œæ°”è¡€ï¼Œå¥¶å­æ™ƒåŠ¨ï¼Œæ‚”æ¨ã€çµå¦‚ç«ï¼Œç¼ºæ€æˆ˜ã€‘ã€‚',
            'ä¸è¶³ä½¿ç”¨ï¼Œæ¶ŒåŠ¨è¡€æ°”ï¼Œé›ªä¹³æ‘‡ï¼Œå†…å¿ƒã€æ¬²ç«èˆ¬çµå°‘å¾¡æ•Œéš¾ã€‘ã€‚',
            'å¤±è´¥ä¸­æ±‚é¥¶ã€çµåŠ›ä¸å¤Ÿï¼Œæœ¬å®«è„±è¡£è·ªæ±‚é¥¶å‘½ã€‘ã€‚',
            'è¢«æ‰“å´©æºƒã€å•Šï¼é½ä¸è¶³ï¼Œåˆ«æ‰“äº†ï¼Œæœ¬å®«æ˜¯æ¯ç‹—ã€‘ã€‚'
        ];
        say(randPick(qiFailMessages));
        return;
    }
    Battle.me.qi -= sk.qi;
    let plus = GS.flags.atkPlus || 0;
    const dmg = rndInt(sk.dmg[0] + plus, sk.dmg[1] + plus);
    if (dmg > 0) {
        Battle.enemy.hp = Math.max(0, Battle.enemy.hp - dmg);
        bLog(`ä½ æ–½å±•ã€${sk.name}ã€‘ï¼Œé€ æˆ ${dmg} ä¼¤å®³ã€‚`);
        const successMessages = [
            'æŠ€èƒ½æˆåŠŸï¼Œä½ å§¿åŠ¿æ›¼å¦™ï¼Œé•¿è£™é£æ‰¬ï¼Œç¾è‡€ç¿˜èµ·ï¼Œå¾®è¡¨æƒ…å¾—æ„ï¼Œå†…å¿ƒã€è¿™å‡»å¦‚è¢«å¤§å±Œæ’å…¥ï¼Œçˆ½å¿«ã€‘ã€‚',
            'æ–½å±•æˆåŠŸï¼Œæ›¼å¦™èº«å§¿ï¼Œè£™æ‘†é£ï¼Œç¾è‡€æŒºï¼Œå¾—æ„è¡¨æƒ…ï¼Œè‡ªè¯­ã€ä¸€å‡»ä¼¼å¤§æ£’å…¥ï¼Œèˆ’çˆ½ã€‘ã€‚',
            'æ‹›å¼å‘½ä¸­ï¼Œä¼˜é›…å§¿æ€ï¼Œé•¿è£™è¡ï¼Œç¿˜è‡€èµ·ï¼Œå¾®å¦™å¾—æ„ï¼Œå†…å¿ƒã€å¦‚è¢«æ“èˆ¬å¿«æ„Ÿã€‘ã€‚',
            'æˆåŠŸå‡»å‡ºï¼Œå§¿åŠ¿æ’©äººï¼Œé£æ‰¬è£™ï¼Œè‡€ç¿˜è¡¨æƒ…å‚²ï¼Œå†…å¿ƒã€æ’å…¥èˆ¬çˆ½ã€‘ã€‚',
            'æˆåŠŸåç¾è¾±ã€æ•Œä¸­æ‹›ï¼Œæœ¬å®«æ„¿è¢«ä½ æ“ï¼Œä½†å…ˆèµ¢ã€‘ã€‚'
        ];
        say(randPick(successMessages));
    }
    if (sk.buff?.shield) {
        GS.statuses.push(`æŠ¤ä½“ï¼ˆ${sk.buff.shield}ï¼‰`);
        bLog('æŠ¤ä½“å…‰å¹•å‡èµ·ã€‚');
        const shieldMessages = [
            'æŠ¤ç›¾å‡èµ·ï¼Œæ–‡è‰ºå¦‚â€œæ°´å…‰æ½‹æ»Ÿæ™´æ–¹å¥½â€ï¼Œå´å†…å¿ƒæ·«è¡æƒ³è¢«ç ´ç›¾æ“ç©´ã€‚',
            'å…‰å¹•æŠ¤ä½“ï¼Œè¯—æ„ä¼¼æ™´å…‰æ°´æ»Ÿï¼Œè‡ªè¯­ã€æ·«å¿ƒæƒ³ç›¾ç ´è¢«æ’ã€‘ã€‚',
            'å‡èµ·æŠ¤ä½“ï¼Œå¦‚è¯—è¯ç¾å¥½ï¼Œå´æµªè¡å†…å¿ƒæ±‚ç ´æ“ã€‚',
            'ç›¾ç°æ–‡è‰ºï¼Œå´å†…å¿ƒã€ç ´ç›¾åéªšç©´ä»»æ“ã€‘ã€‚',
            'ç›¾èµ·æ±‚é¥¶ã€æŠ¤ä½“äº†ï¼Œä½†æœ¬å®«ä»æ„¿è„±è¡£æ±‚ä¸ç ´ã€‘ã€‚'
        ];
        say(randPick(shieldMessages));
    }
    if (sk.id === 'seduce') {
        Battle.enemy.spd -= 1;
        bLog('æ•Œäººè¢«è¯±æƒ‘ï¼Œé€Ÿåº¦é™ä½ï¼Œç›®å…‰åœ¨ä½ é¦™è‡€ä¸Šæµè¿ã€‚');
        const seduceMessages = [
            'ä½ æŠ›åªšçœ¼ï¼Œè¯±æƒ‘æˆåŠŸï¼Œæ•Œæ–¹ç›®å…‰ç—´è¿·ï¼Œä½ ä¹³å¤´ç¡¬æŒºï¼Œå¯¹æ–¹ç«‹é©¬å°±å¹²äº†ä¸Šäº†ï¼Œä½ è¡¨é¢å‡è£…æŠµæŠ—ï¼Œä½†å†…å¿ƒæ±‚æ“ã€‚',
            'åªšçœ¼æŠ›å‡ºï¼ŒæˆåŠŸè¿·æ•Œï¼Œçœ¼ç¥ç—´å‘†ï¼Œä¹³å¤´ç¿˜ï¼Œå¯¹æ–¹æ‰‘ä¸Šï¼Œå‡æŠµæŠ—å†…å¿ƒæ¸´æ±‚ã€‚',
            'è¯±æƒ‘ä¸­ï¼Œæ•Œé€Ÿé™ï¼Œç›®å…‰è‡€æµï¼Œä½ ä¹³åšï¼Œå¯¹æ–¹å¹²ï¼Œè¡¨é¢æŠ—å†…å¿ƒæ“ã€‚',
            'æˆåŠŸåªšæƒ‘ï¼Œspdæ•Œå‡ï¼Œç—´è¿·ç›®å…‰ï¼ŒæŒºä¹³å¤´ï¼Œæ‰‘ä¸Šå‡æ‹’æ±‚æ’ã€‚',
            'è¯±æƒ‘ä¸­å´©æºƒã€æ•Œè¿·äº†ï¼Œæœ¬å®«æ„¿è¢«æ“ï¼Œä½†æ±‚é¥¶åˆ«å¤ªç‹ ã€‘ã€‚'
        ];
        say(randPick(seduceMessages));
    }
    enemyAct();
    checkEnd();
    renderBattle();
    fillBattleSkills();
    if (RNG.roll(0.4) && GS.player.charm > 80) {
        const extraDmgMessages = [
            'é­…åŠ›é«˜ï¼Œéšæœºé¢å¤–dmg+3ã€‚',
            'é«˜é­…åŠ ä¼¤3éšæœºã€‚',
            'é­…åŠ›ä¼˜ï¼Œdmgå¢3ã€‚',
            'éšæœºä¼¤+3å› charmã€‚'
        ];
        say(randPick(extraDmgMessages));
        Battle.enemy.hp -= 3;
    } else if (RNG.roll(0.2) && GS.player.degen > 70) {
        const degenEffectMessages = [
            'å •è½å½±å“ï¼Œä½¿ç”¨ålust+10ï¼Œæ•æ„Ÿ+1ã€‚',
            'æ·«æ¬²å‘ä½œï¼Œlustå‡10 sensitive+1ã€‚',
            'è´Ÿé¢ä½¿ç”¨ï¼Œæ¬²æœ›+10 æ•æ„Ÿå¢1ã€‚',
            'degené«˜ï¼Œlust+10 sensitivity+1ã€‚'
        ];
        say(randPick(degenEffectMessages));
        GS.player.lust += 10;
        GS.player.sensitivity += 1;
    }
}

function enemyAct() {
    if (!Battle.active) return;
    const ed = rndInt(Battle.enemy.atk[0], Battle.enemy.atk[1]);
    Battle.me.hp = Math.max(0, Battle.me.hp - ed);
    bLog(`${Battle.enemy.name} æ”»å‡»ï¼Œé€ æˆ ${ed} ä¼¤å®³ã€‚`);
    const enemyAttackMessages = [
        'æ•Œäººæ”»æ¥ï¼Œä½ ç‰ä½“é—ªèº²ï¼Œé•¿å‘ä¹±èˆï¼Œç¥æ€æƒŠæ…Œï¼Œå†…å¿ƒã€è¿™ä¸‹ç—›å‡»å¦‚è¢«é˜³å…·ç‹ æ…ï¼Œæ‚”æ¨å´å…´å¥‹ã€‘ã€‚',
        'æ•Œå‡»è¢­æ¥ï¼Œç‰èº«èº²é—ªï¼Œç§€å‘ä¹±ï¼Œç¥æƒ…æ…Œï¼Œè‡ªè¯­ã€ç—›å¦‚å¤§æ£’æ…ï¼Œæ‚”å…´ã€‘ã€‚',
        'æ”»å‡»æ•Œè‡³ï¼Œèº«é—ªå‘èˆï¼Œæ…Œå¼ æ€ï¼Œå†…å¿ƒã€ç‹ æ…ä¼¼é˜³å…·ï¼Œæ‚”æ¨å…´å¥‹ã€‘ã€‚',
        'æ•Œæ‰‘æ¥ï¼Œèº²é—ªä¹±å‘ï¼ŒæƒŠç¥ï¼Œå†…å¿ƒã€å¦‚è¢«æ’ç‹ ï¼Œæ‚”å´çˆ½ã€‘ã€‚',
        'è¢«æ‰“ç¾è¾±ï¼Œä½ å“­ã€å•Šï¼åˆ«æ‰“å¥¶å­äº†ï¼Œæœ¬å®«æ±‚é¥¶ï¼Œè„±è¡£ä»»ç©ã€‘ã€‚',
        'æ•Œå‡»å´©æºƒï¼Œä½ æ±‚ã€ä¸»äººé¥¶å‘½ï¼Œæœ¬å®«æ˜¯è´±å¥´ï¼Œè¢«æ‰“åˆ°å´©æºƒã€‘ã€‚',
        'ç—›å‡»ä¸­è„±è¡£ã€åˆ«å†æ‰“äº†ï¼Œæœ¬å®«è‡ªè„±æ±‚ä¸è¾±ã€‘ã€‚',
        'è¢«è¾±æ±‚é¥¶ã€å¤§å±Œä¸»äººï¼Œæœ¬å®«è·ªèˆ”æ±‚é¥¶ï¼Œåˆ«æ‰‡è‡€äº†ã€‘ã€‚'
    ];
    say(randPick(enemyAttackMessages));
    if (RNG.roll(0.3) && GS.player.def < 10) {
        const lowDefMessages = [
            'é˜²å¾¡ä½ï¼Œéšæœºé¢å¤–ä¼¤å®³+2ï¼Œå¥¶å­è¢«å‡»ä¸­é’è‚¿ã€‚',
            'defä½åŠ ä¼¤2ï¼Œä¹³æˆ¿é’è‚¿å‡»ä¸­ã€‚',
            'ä½é˜²éšæœº+2dmgï¼Œå¥¶å­è‚¿ã€‚',
            'é˜²å¾¡å¼±ï¼Œä¼¤+2ä¹³é’ã€‚'
        ];
        say(randPick(lowDefMessages));
        Battle.me.hp -= 2;
    } else if (RNG.roll(0.15) && GS.player.charm > 50) {
        const highCharmMessages = [
            'é­…åŠ›é«˜ï¼Œæ•Œåˆ†å¿ƒï¼Œä¼¤å®³-1ã€‚',
            'é­…ä¼˜æ•Œæ•£ï¼Œdmgå‡1ã€‚',
            'é«˜charmï¼Œåˆ†å¿ƒä¼¤-1ã€‚',
            'é­…åŠ›æ•Œä¹±ï¼Œä¼¤å®³é™1ã€‚'
        ];
        say(randPick(highCharmMessages));
        Battle.me.hp += 1;
    }
}

function checkEnd() {
    if (Battle.enemy.hp <= 0) {
        bLog('æˆ˜æ–—èƒœåˆ©ï¼');
        const winMessages = [
            'èƒœåˆ©ä¸€åˆ»ï¼Œä½ å§¿åŠ¿ä¼˜é›…æ“¦æ±—ï¼Œç‰ä¹³èµ·ä¼ï¼Œå¾®è¡¨æƒ…å¾—æ„ï¼Œå†…å¿ƒã€æ•Œå¦‚è´¥çŠ¬ï¼Œæœ¬å®«æƒ³éª‘ä¹˜å…¶å°¸è‡ªæ…°ã€‘ã€‚',
            'è·èƒœç¬é—´ï¼Œä¼˜é›…æ‹­æ±—ï¼Œèƒ¸é¢¤å¾—æ„è¡¨æƒ…ï¼Œè‡ªè¯­ã€è´¥æ•Œå¦‚çŠ¬ï¼Œæƒ³éª‘å°¸è‡ªæ¸ã€‘ã€‚',
            'èƒœäº†ï¼Œå§¿æ€æ›¼å¦™æ±—æ“¦ï¼Œç‰ä¹³æŠ–ï¼Œå‚²å¨‡è„¸ï¼Œå†…å¿ƒã€æ•ŒçŠ¬èˆ¬ï¼Œæœ¬å®«æ¬²éª‘å°¸æ‰‹æ·«ã€‘ã€‚',
            'èƒœåˆ©ä¼˜é›…ï¼Œèµ·ä¼ä¹³ï¼Œå¾®å¦™å¾—æ„ï¼Œå†…å¿ƒã€è´¥çŠ¬æ•Œï¼Œæƒ³è‡ªæ…°éª‘å°¸ã€‘ã€‚'
        ];
        say(randPick(winMessages));
        finishBattle(true);
    } else if (Battle.me.hp <= 0) {
        bLog('ä½ åŠ›ç«­å€’åœ°â€¦â€¦');
        const loseMessages = [
            'è´¥åŒ—ç¬é—´ï¼Œä½ å€’åœ°è£¸éœ²ï¼Œå‰©ä¸‹ç ´çƒ‚ä¸å ªçš„è¡£è£³ä¹Ÿè¢«æ‰’çš„ä¸€å¹²äºŒå‡€ï¼Œéªšç©´æ»´è½ç€æ·«æ±ï¼Œç¾è‡€é¢¤åŠ¨ï¼Œä½ æŠ½æä¸æ­¢ï¼Œç¥æ€ç»æœ›ï¼Œå†…å¿ƒæ‚”æ¨ã€æœ¬å®«æ€è´¥ä¸‹ï¼Œä¼¼è¢«è½®å¥¸èˆ¬è€»è¾±ã€‘ã€‚',
            'å¤±è´¥ä¸€åˆ»ï¼Œå€’åœ°å…¨è£¸ï¼Œè¡£ç¢æ‰’å…‰ï¼Œä¸‹ä½“æ±æ»´ï¼Œç¿˜è‡€æŠ–ï¼Œç—‰æŒ›ç»æœ›ï¼Œç¥æ‚”ã€è´¥å¦‚è½®å¥¸è€»ã€‘ã€‚',
            'åŠ›ç«­å€’ä¸‹ï¼Œè£¸éœ²æ‰’è¡£ï¼Œæ·«æ¶²è½ï¼Œè‡€é¢¤æŠ½æï¼Œç»æœ›æ€ï¼Œè‡ªè´£ã€æ€çš„è´¥äº†ï¼Œä¼¼ç¾¤äº¤è¾±ã€‘ã€‚',
            'è´¥åœ°è£¸ï¼Œè¡£ç ´å‡€ï¼Œç©´æ»´è‡€åŠ¨ï¼Œé¢¤ç»æœ›ï¼Œå†…å¿ƒã€è´¥ä¸‹å¦‚è¢«å¥¸è€»è¾±ã€‘ã€‚',
            'è´¥åŒ—å´©æºƒæ±‚é¥¶ã€ä¸»äººï¼Œæœ¬å®«è´¥äº†ï¼Œæ±‚å¤§å±Œæ’å…¥é¥¶å‘½ã€‘ã€‚',
            'å€’åœ°ç¾è¾±ã€åˆ«æ‰’è¡£äº†ï¼Œæœ¬å®«æ„¿åšæ¯ç‹—ï¼Œè¢«è½®åˆ°å´©æºƒã€‘ã€‚'
        ];
        say(randPick(loseMessages));
        finishBattle(false);
    }
}

function finishBattle(win) {
    Battle.active = false;
    el('battle-close').disabled = false;
    if (win) {
        Battle.enemy.drops?.forEach(([it, p, a]) => {
            if (RNG.roll(p)) {
                addItem(it, a);
                bLog('è·å¾—æ‰è½ï¼š' + it + ' x' + a);
            }
        });
        gainExp(4 + rndInt(0, 3));
        GS.stones += rndInt(0, 3);
        if (Battle.enemy.id === 'rapist') {
            const rapistWinMessages = [
                'å‡»è´¥æ·«è´¼ï¼Œä½ è¶æœºéª‘ä¹˜å…¶é˜³å…·ï¼Œéªšç©´ç´§è£¹ï¼Œå¤§å±ŒæŠ½æ’ï¼Œæ³„æ¬²é«˜æ½®ã€‚',
                'èƒœè´¼éª‘ä¹˜ï¼Œå¤§æ£’å…¥ç©´ï¼Œç´§è£¹æŠ½æ’ï¼Œé«˜æ½®æ³„ã€‚',
                'æ·«è´¼è´¥ï¼Œä½ éª‘é˜³ç‰©ï¼Œéªšå¤„è£¹ï¼Œæ’è‡³å·…å³°ã€‚',
                'å‡»è´¥åéª‘ï¼Œç©´ç´§å±ŒæŠ½ï¼Œæ¬²æ³„æ½®ã€‚'
            ];
            say(randPick(rapistWinMessages));
        }
        GS.player.lust -= 10;
        if (RNG.roll(0.25) && GS.player.degen > 60) {
            const degenGrowthMessages = [
                'èƒœåˆ©éšæœºï¼Œå •è½çº¿æˆé•¿ï¼Œå¢ƒç•Œ+1ä½†lust+15ã€‚',
                'èƒœådegenæˆé•¿ï¼Œlevel+1 lustå‡15ã€‚',
                'éšæœºæ·«çº¿ï¼Œå¢ƒç•Œå¢1æ¬²æœ›+15ã€‚',
                'èƒœåˆ©degenï¼Œ+1level +15lustã€‚'
            ];
            say(randPick(degenGrowthMessages));
            GS.player.level += 1;
            GS.player.lust += 15;
        }
    } else {
        GS.flags.captured = true;
        GS.flags.captured_loc = Battle.loc;
        GS.sub_loc = 'ç‰¢æˆ¿';
        GS.loc = Battle.loc;
        const capturedMessages = [
            'æˆ˜æ–—å¤±è´¥ï¼Œä½ è¢«ä¿˜è™ï¼Œå…³å…¥' + GS.sub_loc + 'ï¼Œè¿™å°å¥³å­æœçœŸæ˜¯ä¸ªæ¯ç‹—ï¼Œå¤§å±Œè½®ç•ªæ’å…¥éªšç©´ï¼Œå¥¶å­è¢«æ‰‡çš„é’è‚¿ï¼Œå •è½å¢ã€‚',
            'è´¥ä¿˜å…¥ç‰¢ï¼Œè¿™å¥³å­å¦‚ç‹—ï¼Œè½®æ’å…¥ç©´ï¼Œä¹³æ‰‡è‚¿ï¼ŒdegenåŠ ã€‚',
            'å¤±è´¥è¢«æ‰ï¼Œå…³ç‰¢æ¯ç‹—ï¼Œå¤§æ£’è½®ç©´ï¼Œå¥¶é’è‚¿ï¼Œå •è½å‡ã€‚',
            'ä¿˜è™å¤±è´¥ï¼Œç‰¢ä¸­ç‹—èˆ¬ï¼Œæ’è½®éªšå¤„ï¼Œæ‰‡ä¹³è‚¿ï¼Œå¢degenã€‚',
            'ä¿˜è™ç¾è¾±ã€å…³ç‰¢åï¼Œæœ¬å®«æ„¿è„±è¡£æ±‚è½®å¥¸ã€‘ã€‚',
            'è´¥åŒ—å´©æºƒã€ç‰¢ä¸­æœ¬å®«æ˜¯è´±å¥´ï¼Œæ±‚å¤§å±Œè¾±åˆ°å´©æºƒã€‘ã€‚'
        ];
        say(randPick(capturedMessages));
        GS.player.degen += 15;
        GS.player.hp = GS.player.hp_max / 2;
        updateCaptured();
        if (RNG.roll(0.4) && GS.player.charm > 70) {
            const charmCapturedMessages = [
                'é­…åŠ›å€¼é«˜ï¼Œæˆä¸ºä¿˜è™è¢«éšæœºæ‹å–ï¼Œç¾è²Œå¸å¼•ä¹°ä¸»ç¾¤äº¤',
                'é«˜é­…æ‹å–ï¼Œä¿˜ç¾å¼•ç¾¤äº¤ã€‚',
                'è¿™å°å¥³å­é•¿å¾—è¿˜çœŸæ˜¯ä¸é”™ï¼Œå¸å¼•ä¹°å®¶è½®ã€‚',
                'éšæœºæ‹å–ï¼Œé«˜ç¾ç¾¤äº¤å¼•ã€‚',
                'æ‹å–ä¸­æ±‚é¥¶ã€ä¹°ä¸»ä»¬ï¼Œæœ¬å®«æ„¿è·ªèˆ”å¤§å±Œæ±‚ä¸å–ã€‘ã€‚'
            ];
            say(randPick(charmCapturedMessages));
            GS.player.lust += 3;
        } else if (RNG.roll(0.2)) {
            const brandMessages = [
                'è¿™æ¯ç‹—çœŸæ˜¯ä¸€æ¡çƒ‚è´§ï¼Œè¯´ç½¢å°±è¢«å¯¹æ–¹ç”¨æ»šçƒ«çš„çƒ™é“ï¼Œå…¹-æ‹‰-ä¸€å£°çƒ™ä¸‹ä¸€é“æ°¸ä¹…è€»è¾± è´¥åŒ—é›Œå…½ äºå¥¶å­ã€‚',
                'çƒ‚ç‹—çƒ™é“å…¹æ‹‰ï¼Œæ°¸ä¹…è¾±è´¥åŒ—é›Œå…½ä¹³ä¸Šã€‚',
                'è´±è´§çƒ«é“ï¼Œè€»è¾±çƒ™è´¥é›Œå…½å¥¶å­ã€‚',
                'æ¯ç‹—çƒ™å…¹ï¼Œæ°¸è¾±è´¥åŒ—å…½äºèƒ¸ã€‚',
                'çƒ™ä¸­å´©æºƒã€å•Šï¼åˆ«å†çƒ™æˆ‘äº†ï¼Œæœ¬å®«æ±‚é¥¶åšé›Œå…½ï¼Œåšé›Œå…½è¿˜ä¸è¡Œå—ï¼Ÿã€‘ã€‚'
            ];
            say(randPick(brandMessages));
            GS.statuses.push('è´¥åŒ—é›Œå…½');
        }
    }
    GS.player.hp = Battle.me.hp;
    GS.player.qi = Battle.me.qi;
    refresh();
    if (!win && RNG.roll(0.3)) {
        const loseGrowthMessages = [
            'è´¥åŒ—éšæœºï¼Œé­…æƒ‘çº¿æˆé•¿ï¼Œcharm+2ä½†degen+10ã€‚',
            'å¤±è´¥é­…çº¿ï¼Œcharmå¢2 degenå‡10ã€‚',
            'éšæœºè´¥æˆé•¿ï¼Œ+2charm +10degenã€‚',
            'é­…æƒ‘è´¥ï¼Œcharm+2 degen+10ã€‚'
        ];
        say(randPick(loseGrowthMessages));
        GS.player.charm += 2;
        GS.player.degen += 10;
    }
}

el('btn-defend').onclick = () => {
    bLog('ä½ ä¸“æ³¨é˜²å¾¡ã€‚');
    Battle.me.hp = Math.min(GS.player.hp_max, Battle.me.hp + 1);
    enemyAct();
    checkEnd();
    renderBattle();
    const defendMessages = [
        'é˜²å¾¡å§¿åŠ¿å¦‚â€œæ°´å¹•å¤©åâ€ï¼Œç‰ä½“æŠ¤ç›¾é—ªè€€ç€å…‰è¾‰ï¼Œå†…å¿ƒå¿ƒæƒ³ã€é˜²å¾¡æ—¶å†…å¿ƒæ€å´å¦‚æ­¤èºåŠ¨ä¸å®‰ï¼Œè„¸é¢Šå¾®çº¢å¦‚é­…äº†ä¸€èˆ¬ã€‘ã€‚',
        'é˜²å¦‚æ°´å¹•ï¼Œèº«ç›¾è¾‰ï¼Œå†…å¿ƒã€é˜²ä¸­èºåŠ¨ä¸å®‰ï¼Œè„¸çº¢å¦‚åªšã€‘ã€‚',
        'å§¿æ€é˜²å¾¡è¯—æ„ï¼ŒæŠ¤è€€å…‰ï¼Œè‡ªè¯­ã€å†…å¿ƒèºåŠ¨ä¸å®‰ï¼Œè„¸çº¢å¦‚é­…ã€‘ã€‚',
        'å¦‚å¤©åæ°´ï¼Œç‰è¾‰ç›¾ï¼Œå†…å¿ƒã€é˜²å¾¡æ—¶å´éªšåŠ¨ä¸æ­¢ï¼Œè„¸é¢Šå¾®çº¢ã€‘ã€‚',
        'é˜²å¾¡æ±‚é¥¶ã€é˜²å¾¡ä½äº†ï¼Œä½†æœ¬å®«æ„¿è„±è¡£ï¼Œåªæ±‚å¯¹åä¸è¦å†æ‰“æˆ‘äº†ã€‘ã€‚'
    ];
    say(randPick(defendMessages));
    if (RNG.roll(0.2)) {
        say('é˜²å¾¡æˆåŠŸï¼Œéšæœºdef+1ã€‚');
        GS.player.def += 1;
    }
};

el('btn-flee').onclick = () => {
    if (RNG.roll(0.5)) {
        bLog('ä½ æˆåŠŸè„±æˆ˜ã€‚');
        finishBattle(false);
        const fleeSuccessMessages = [
            'é€ƒè·‘æˆåŠŸï¼Œé•¿è£™é£æ‰¬ï¼Œé¦™è‡€æ‰­åŠ¨ï¼Œç¥æ€æ…Œå¼ ï¼Œå†…å¿ƒã€é€ƒå¦‚è¢«è¿½æ“ï¼Œæ‚”æ¨å´æ¹¿äº†ã€‘ã€‚',
            'è„±æˆåŠŸï¼Œè£™é£è‡€æ‰­ï¼Œæ…Œç¥ï¼Œè‡ªè¯­ã€è¿½æ“èˆ¬é€ƒï¼Œæ‚”æ¹¿ã€‘ã€‚',
            'è·‘æˆï¼Œé£æ‰¬è£™ï¼Œæ‰­è‡€æ…Œæ€ï¼Œå†…å¿ƒã€å¦‚è¢«æ“è¿½ï¼Œæ¨å´æ½®ã€‘ã€‚',
            'æˆåŠŸé€ƒï¼Œé•¿æ‰­é£ï¼Œæ…Œå†…å¿ƒã€é€ƒä¼¼æ“ï¼Œæ¹¿æ‚”ã€‘ã€‚'
        ];
        say(randPick(fleeSuccessMessages));
    } else {
        bLog('è„±æˆ˜å¤±è´¥ã€‚');
        enemyAct();
        checkEnd();
        renderBattle();
        const fleeFailMessages = [
            'é€ƒè·‘å¤±è´¥ï¼Œè¢«æ•ŒäººæŠ“ä½ï¼Œä¸€æŠŠå¤§æ‰‹ç‹ ç‹ çš„æç€ä½ çš„å¥¶å­ï¼Œä¼¼ä¹æƒ³è¦æŠŠå®ƒæçƒ‚ï¼Œä½ éªšç©´ä¸€ç´§ï¼Œå¤§å£°çš„æ·«å«ä¸æ­¢ï¼Œå˜´ä¸€ç›´è¯´ç€é‡Œï¼Œå¯¹ä¸èµ·ï¼Œå¯¹ä¸èµ·ï¼Œæˆ‘ä»¥åå†ä¹Ÿä¸ä¼šè·‘äº†ï¼Œæˆ‘æ˜¯æ¯ç‹—ï¼Œæ±‚æ±‚ä½ æ”¾è¿‡æˆ‘æŠŠï¼Œæ•æ„Ÿ+1ã€‚',
            'å¤±è´¥é€ƒï¼ŒæŠ“æä¹³çƒ‚ï¼Œç©´ç´§å«æ·«ï¼Œå˜´å¯¹ä¸èµ·ä¸è·‘ç‹—æ±‚ï¼Œsensitive+1ã€‚',
            'è·‘è´¥è¢«æ‰ï¼Œæ‰‹ç‹ å¥¶æï¼Œç´§ç©´æµªå«ï¼Œæ‚”ä¸è¯´è·‘æ¯ç‹—é¥¶ï¼Œ+1æ•æ„Ÿã€‚',
            'è„±æˆ˜é”™ï¼Œæ•Œäººæèƒ¸æ¬²çƒ‚ï¼Œä¸‹ä½“ç¼©æ·«å–Šï¼Œæ±‚é¥¶ä¸é€ƒç‹—æ”¾ï¼Œæ•æ„Ÿå‡1ã€‚',
            'å¤±è´¥æ±‚é¥¶ã€åˆ«æäº†ï¼Œæœ¬å®«æ˜¯æ¯ç‹—ï¼Œæ±‚å¤§å±Œæ’é¥¶ã€‘ã€‚',
            'é€ƒè´¥å´©æºƒã€å•Šï¼å¥¶å­çƒ‚äº†ï¼Œæœ¬å®«è·ªæ±‚ä¸è·‘ã€‘ã€‚'
        ];
        say(randPick(fleeFailMessages));
        GS.player.sensitivity += 1;
    }
};

el('btn-seduce-battle').onclick = () => {
    if (GS.player.charm > 30 && RNG.roll(0.4)) {
        bLog('ä½ æŠ›åªšçœ¼è¯±æƒ‘æ•Œäººï¼Œä»–å¤§å±Œç¡¬èµ·ï¼Œæˆ˜æ–—ç»“æŸï¼Œè½¬è€Œäº¤åˆï¼Œé˜³ç‰©æ’å…¥é˜´ç©´ï¼ŒæŠ½æ’ä¸æ­¢ã€‚');
        finishBattle(true);
        GS.player.sex_exp += 1;
        const seduceSuccessMessages = [
            'è¯±æƒ‘æˆåŠŸï¼Œä½ åªšçœ¼å¦‚ä¸ï¼Œä¹³å¤´æŒºç«‹ï¼ŒåŠ¨ä½œæ‘‡æ›³ï¼Œå†…å¿ƒã€è¯±æ•Œå¦‚æ±‚æ“ï¼Œåå·®çº¯å¥³æ·«å¿ƒã€‘ã€‚',
            'æˆåŠŸåªšï¼Œä¸çœ¼æŒºä¹³ï¼Œæ‘‡åŠ¨ä½œï¼Œè‡ªè¯­ã€è¯±å¦‚æ“æ±‚ï¼Œçº¯æ·«åã€‘ã€‚',
            'åªšæƒ‘æˆï¼Œå¦‚ä¸åªšçœ¼ï¼Œç¿˜ä¹³æ‘‡ï¼Œå†…å¿ƒã€æ•Œè¯±æ±‚æ’ï¼Œåå·®æµªã€‘ã€‚',
            'æˆåŠŸè¯±ï¼Œçœ¼ä¸ä¹³ç«‹ï¼Œæ›³åŠ¨ï¼Œå†…å¿ƒã€å¦‚æ±‚æ“çº¯å¥³å¿ƒæ·«ã€‘ã€‚'
        ];
        say(randPick(seduceSuccessMessages));
    } else {
        bLog('è¯±æƒ‘å¤±è´¥ã€‚');
        enemyAct();
        const seduceFailMessages = [
            'å¤±è´¥ï¼Œä½ ä¿è„¸çº¢æ¶¦ï¼Œç¥æ€å°´å°¬ï¼Œå†…å¿ƒæ‚”æ¨ã€æœ¬å®«åªšæƒ‘ä¸æˆï¼Œåè¢«æ¬²ç«çƒ§ã€‘ã€‚',
            'è¯±è´¥ï¼Œè„¸çº¢å°´å°¬æ€ï¼Œè‡ªè´£ã€æƒ‘ä¸æˆç«çƒ§æ¬²ã€‘ã€‚',
            'å¤±è´¥ä¿çº¢ï¼Œç¥å°´å°¬ï¼Œæ‚”ã€åªšä¸åçƒ§ã€‘ã€‚',
            'æƒ‘é”™ï¼Œæ¶¦è„¸å°¬ï¼Œå†…å¿ƒã€ä¸æˆè¢«æ¬²ç„šã€‘ã€‚',
            'å¤±è´¥ç¾è¾±ã€åªšä¸æˆï¼Œæœ¬å®«æ„¿è„±è¡£æ±‚é¥¶ã€‘ã€‚'
        ];
        say(randPick(seduceFailMessages));
    }
    checkEnd();
    renderBattle();
    if (RNG.roll(0.1) && GS.player.degen > 40) {
        const degenSeduceMessages = [
            'è¯±æƒ‘éšæœºï¼Œdegen+5ï¼Œlust+10ã€‚',
            'éšæœºæ·«ï¼Œdegenå‡5 lust+10ã€‚',
            'æƒ‘éšæœºï¼Œ+5degen +10lustã€‚',
            'degen+5 lust+10éšæœºã€‚'
        ];
        say(randPick(degenSeduceMessages));
        GS.player.degen += 5;
        GS.player.lust += 10;
    }
};

el('btn-rape-battle').onclick = () => {
    if (Battle.enemy.hp < 10 && RNG.roll(0.3)) {
        bLog('ä½ å¼ºå‹æ•Œäººï¼Œæ‰‹æŒ‡æ’å…¥å…¶ç©´ï¼Œç”¨åŠ›æ‰‡ç€å¯¹æ–¹è€³å…‰ï¼Œéœ²å‡ºé‚ªæ¶èˆ¬çš„ç¬‘å®¹ï¼Œæ‰‹æŒ‡æ¡æˆæ‹³å¤´ç”¨è›®åŠ›å¦‚ç‰›ä¸€èˆ¬ç›´ç›´æ’å¦‚å…¶ç©´ï¼Œå¯¹æ–¹é«˜æ½®è¿è¿ï¼Œçœ¼ç¥ç©ºæ´ã€‚');
        Battle.enemy.hp = 0;
        checkEnd();
        GS.player.sex_exp += 1;
        const rapeSuccessMessages = [
            'ä¾µçŠ¯æˆåŠŸï¼Œä½ éª‘ä¹˜åœ¨æ•Œäººçš„é˜³å…·èº«ä¸Šï¼Œéªšç©´ç´§è£¹ç€å¤§å±Œï¼ŒåŠ¨ä½œç‹‚é‡æ”¾è¡ï¼Œå†…å¿ƒã€ä¾µçŠ¯å¦‚è¢«è½®å¥¸ï¼ŒçœŸæ˜¯å°¤ç‰©å‘¢ã€‘ã€‚',
            'æˆä¾µï¼Œéª‘æ•Œé˜³ï¼Œç©´è£¹å±Œï¼Œé‡è¡åŠ¨ä½œï¼Œè‡ªè¯­ã€å¦‚è½®å¥¸å°¤ã€‘ã€‚',
            'æˆåŠŸå¼ºï¼Œä¹˜æ•Œæ£’ï¼Œç´§éªšè£¹ï¼Œç‹‚å§¿ï¼Œå†…å¿ƒã€ä¾µä¼¼ç¾¤äº¤ç‰©ã€‘ã€‚',
            'ä¾µçŠ¯æˆï¼Œéª‘é˜³å…·ï¼Œè£¹ç´§ç©´ï¼Œæ”¾åŠ¨ä½œï¼Œå†…å¿ƒã€å¦‚è¢«å¥¸çœŸæ˜¯ã€‘ã€‚'
        ];
        say(randPick(rapeSuccessMessages));
    } else {
        bLog('ä¾µçŠ¯å¤±è´¥ã€‚');
        enemyAct();
        const rapeFailMessages = [
            'å¤±è´¥ï¼Œæ•Œåæ‰‘ï¼Œä½ ç‰ä½“è¢«æ•Œäººå‹åœ¨èº«ä¸‹ï¼Œå¥¶å­è¢«ç”¨åŠ›æ‰æï¼Œå†…å¿ƒã€æ€å¾—å¦‚æ­¤è€»è¾±ï¼Œç«Ÿç„¶è¢«æ•Œäººåæ‰‘ï¼ŒçœŸæ˜¯å¦‚å©Šå­èˆ¬æ‚”æ¨ã€‘ã€‚',
            'ä¾µè´¥ï¼Œåæ•Œæ‰‘ï¼Œèº«å‹ä¸‹ï¼Œæä¹³åŠ›ï¼Œæ‚”ã€è€»å¦‚å©Šåæ‰‘ã€‘ã€‚',
            'å¤±è´¥å¼ºï¼Œæ‰‘æ•Œåï¼Œç‰ä¸‹å‹ï¼Œæ‰å¥¶ç‹ ï¼Œè‡ªè´£ã€è¾±æ€è¢«ï¼Œå¦‚æ‚”å©Šã€‘ã€‚',
            'é”™ä¾µï¼Œæ•Œåèº«å‹ï¼Œæç”¨åŠ›å¥¶ï¼Œå†…å¿ƒã€è€»è¾±æ‰‘ï¼ŒçœŸæ˜¯æ¨ã€‘ã€‚',
            'å¤±è´¥å´©æºƒã€åæ‰‘äº†ï¼Œæœ¬å®«æ±‚é¥¶è„±è¡£è¢«æã€‘ã€‚'
        ];
        say(randPick(rapeFailMessages));
    }
    checkEnd();
    renderBattle();
    if (RNG.roll(0.25)) {
        const rapeExtraMessages = [
            'ä¾µçŠ¯éšæœºï¼Œsex_exp+1ï¼Œdegen+3ã€‚',
            'éšæœºæ€§+1 degen+3ã€‚',
            'ä¾µéšæœºï¼Œ+1sex_exp +3degenã€‚',
            'extra sex_exp+1 degen+3ã€‚'
        ];
        say(randPick(rapeExtraMessages));
        GS.player.sex_exp += 1;
        GS.player.degen += 3;
    }
};

el('battle-close').onclick = () => {
    showModal('battle', false);
    const closeMessages = [
        'æˆ˜æ–—ç»“æŸï¼Œä½ æ“¦æ±—å–˜æ¯ï¼Œé•¿å‘å‡Œä¹±ï¼Œç‰ä¹³èµ·ä¼ï¼Œå¾®è¡¨æƒ…ç–²æƒ«ï¼Œå†…å¿ƒã€æˆ˜åå¦‚é«˜æ½®åè™šè„±ï¼Œåå·®æƒ³ç»­æ“ã€‘ã€‚',
        'æˆ˜æ¯•ï¼Œæ‹­æ±—æ¯ï¼Œä¹±å‘ä¹³èµ·ï¼Œç–²è¡¨æƒ…ï¼Œè‡ªè¯­ã€åå¦‚æ½®è™šï¼Œæƒ³ç»­æ’ã€‘ã€‚',
        'ç»“æŸæ“¦å–˜ï¼Œå‡Œå‘èµ·ä¼ï¼Œå¾®ç–²ï¼Œå†…å¿ƒã€é«˜åè„±ï¼Œåæ“ç»­ã€‘ã€‚',
        'æ¯•æˆ˜ï¼Œæ±—æ¯ä¹±ï¼Œä¹³ç–²å¾®ï¼Œå†…å¿ƒã€å¦‚è™šæ½®ï¼Œæƒ³å·®æ“ã€‘ã€‚'
    ];
    say(randPick(closeMessages));
    if (RNG.roll(0.3)) {
        say('å…³é—­éšæœºï¼Œé¢å¤–exp+5ã€‚');
        gainExp(5);
    }
    // if(win) {  è‡ªå·±åŠ æ‰è½
    //const config = DROP_CONFIG[id];
    //if(config) {
    // rollDrops(config);
    // rollSpecialDrops(id);
    //}
};
// ====== ä¸»çº¿ ======
function hasQuest(n){return GS.quests.some(q=>q.name===n)}
function getQuest(n){return GS.quests.find(q=>q.name===n)}
function startQuest_Sect(){if(hasQuest('ç‰è¡¡å®—å…¥é—¨'))return;GS.quests.push({name:'ç‰è¡¡å®—å…¥é—¨',stage:0,stageName:'é‚€çº¦',desc:'ä¸‰æ—¥å†…å‰å¾€ã€ç‰è¡¡å®—Â·å±±é—¨ã€‘å‚åŠ æµ‹è¯•ï¼Œä¼ é—»å®—å†…ç¾å§¬æ— æ•°ï¼Œå •è½æœºä¼šå¤šã€‚'});toast('ä¸»çº¿æ›´æ–°ï¼šç‰è¡¡å®—å…¥é—¨');updateQuests()}
function ensureSect(){if(!hasQuest('ç‰è¡¡å®—å…¥é—¨'))startQuest_Sect()}
function resolveChoice(id){switch(id){case 201:addItem('çµè‰',1);say('ä½ å®Œæˆä¸€æ¬¡é‡‡è¯ä»»åŠ¡ï¼Œä¸€å¥³å­ç›¸ä¼´ï¼Œé¦™è‡€æ‘‡æ›³ã€‚');outerInc();break;
case 202:battle('wolf');outerInc();break;
case 203:GS.loc='å•†è·¯é©¿ç«™';say('ä½ æŠ¤é€å•†é˜ŸæŠµè¾¾é©¿ç«™ï¼Œå¥³çœ·åªšçœ¼æµè½¬ï¼Œå°ç©´éšç°æ˜¥å…‰ã€‚');outerInc();break;
case 204:say('æ‰§äº‹ï¼šå¯å…¥è—ç»é˜ï¼ˆåŸºç¡€å±‚ï¼‰ï¼Œå†…æœ‰æ˜¥å®«ç§˜ç±ã€‚');addTrait('è—ç»é˜è®¸å¯');break;
case 205:say('ä½ æ¥ä¾å¯å§”æ‰˜ï¼Œå…¥é’æ¥¼ä¸ç”·å­äº¤åˆï¼Œå¤§å±Œç‹ æ’éªšç©´ï¼Œä½ æµªå«ä¸æ­¢ï¼Œç¾è‡€é¢¤åŠ¨ã€‚');GS.player.sex_exp+=1;GS.player.lust=0;outerInc();break;
case 206:say('ä½ æ¥å—å •è½ä»»åŠ¡ï¼Œæ´çªŸä¸­è‡ªæ„¿è¢«é‚ªå…½ä¾µçŠ¯ï¼Œå…½æ ¹å¡«æ»¡é˜´ç©´ï¼Œå •è½å¤§å¢ã€‚');GS.player.degen+=15;outerInc();break;
case 801:say('ä½ æ±‚é¥¶è·ªèˆ”è·¯äººå¤§å±Œï¼Œç²¾å°„æ»¡å£ï¼Œæ¢å–çŸ­æš‚ä¼‘æ¯ï¼Œä½†æ•æ„Ÿ+2ï¼Œå •è½+5ã€‚');GS.player.sensitivity+=2;GS.player.degen+=5;break;
case 802:if(GS.player.atk > 15){say('ä½ åæŠ—å‘èµ·æˆ˜æ–—ï¼Œé˜³å…·æŠ½æ’ä¸­åæ€é€ƒè„±ã€‚');battle('bully');}else{say('atkä¸è¶³ï¼ŒåæŠ—å¤±è´¥ï¼Œè¢«é­æ‰“å¥¶å­è¡€æ·‹ï¼Œhp-10ï¼Œå •è½+8ã€‚');GS.player.hp-=10;GS.player.degen+=8;}break;
case 803:if(GS.player.degen > 50){say('ä½ è‡ªæ…°å¸å¼•ç¾¤äººç¾¤å¥¸ï¼Œæµªå«é«˜æ½®å¤±ç¦ï¼Œæ€§ç»éªŒ+2ï¼Œæ•æ„Ÿ+3ã€‚');GS.player.sex_exp+=2;GS.player.sensitivity+=3;}else{say('degenä¸è¶³ï¼Œè‡ªæ…°å¤±è´¥ï¼Œè¢«å˜²ç¬‘ç»§ç»­è½®å¥¸ã€‚');}break;
case 804:say('ä½ ç­¾å¥´éš¶å¥‘çº¦ï¼Œèº«ä»½â€œè·¯äººç¾¤å¥´â€ï¼Œå •è½+15ï¼Œè½¬ç§»åˆ°æš—å··å­åœ°ç‚¹ç»§ç»­è™å¾…ã€‚');GS.player.degen+=15;GS.sub_loc='æš—å··';GS.statuses.push('è·¯äººç¾¤å¥´');break;
default:say('ï¼ˆæœªå®ç°çš„é€‰é¡¹ï¼‰')}}
function outerInc(){GS.flags.outerCount=(GS.flags.outerCount||0)+1;if(GS.flags.outerCount>=3){setChoices([{id:204,text:'è¿”å›å¤–é—¨å¤å‘½ï¼ˆé¢†å–è®¸å¯ï¼‰'}]);toast('å¤–é—¨ä»»åŠ¡è¾¾æˆ')}}
function addTrait(t){if(!GS.traits.includes(t))GS.traits.push(t);refresh()}

// ====== å¤§åœ°å›¾ / å‰å¾€ ======
function goTo(loc){const cost=rndInt(1,4);say('ä½ è¸ä¸Šå‰å¾€ã€'+loc+'ã€‘çš„è·¯é€”ï¼Œé€”ä¸­è§å¥³å­è¢«åŒªå¾’è½®å¥¸ï¼Œé˜´ç©´èœœæ±å››æº…ï¼Œä½ å¿ƒç”Ÿå •è½æ¬²ã€‚');GS.loc=loc;GS.sub_loc='';GS.stones=Math.max(0,GS.stones-Math.max(0,cost-2));tickTime(rndInt(2,5));}

// ====== å•†åº— ======
const SHOPS={
  'æ¸…é£é•‡Â·å¤§è¡—':[ ['å›æ°”ä¸¹',4],['æ¸©ç‰ä½©',1],['æœ¨å‰‘',1] ],
  'æ¸…é£é•‡Â·è¯é“º':[ ['å…»è¡€ä¸¸',2],['æš–èº«èŒ¶',2],['å›æ°”ä¸¹',3],['åªšè¯æ•£',5] ],
  'å•†è·¯é©¿ç«™':[ ['çš®ç”²',1],['å›æ°”ä¸¹',3],['æ˜¥å®«å›¾',2] ],
  'æ¸…é£é•‡Â·é’æ¥¼':[ ['ç‰åŠ¿',3],['ä¸è¢',1],['åªšè¯æ•£',4],['å •è½ä¸¹',2] ],
  'æ·«é­”å¡”Â·æ·«é­”å•†åº—': [
    ['æ·«çº¹æˆ˜ç”²', 5000],
    ['é­…é­”é¡¹åœˆ', 6000],
    ['åªšé­”é«˜è·Ÿ', 3500],
    ['é‚ªå…½é“ƒé“›', 4500]
  ]
};
function openShops(){const loc=GS.loc;const inv=SHOPS[loc];if(!inv){toast('æ­¤å¤„æš‚æ— å•†åº—');return}const list=inv.map(([n,q])=>`Â· ${n} x${q}`).join('\n');say('ä½ èµ°è¿›å•†é“ºï¼š\n'+list+'\nå¥³æŒæŸœè¡£è¡«åŠè§£ï¼Œç‰ä¹³å¾®éœ²ï¼Œç¾è‡€è½»æ‰­ã€‚ï¼ˆç‚¹å‡»èƒŒåŒ…ç‰©å“å¯æŸ¥çœ‹/ä½¿ç”¨ï¼Œè´­ä¹°é€»è¾‘å ä½ï¼šå¯åœ¨æ­¤å¤„æ¥å…¥ï¼‰')}

// ====== è£…å¤‡ ======
function openEquips(){el('eq-weapon').textContent=GS.equips.weapon||'æ— ';el('eq-armor').textContent=GS.equips.armor||'æ— ';el('eq-acc').textContent=GS.equips.acc||'æ— ';const box=el('equipables');box.innerHTML='';Object.keys(GS.inventory).forEach(k=>{const it=ITEMBOOK[k];if(!it)return;if(['weapon','armor','acc'].includes(it.type)||it.equip){const b=document.createElement('button');b.className='choice';b.textContent=`è£…å¤‡ï¼š${k}`;b.onclick=()=>equip(k);box.append(b)}});showModal('equip-modal',true)}
function equip(name){const it=ITEMBOOK[name];if(!it||!it.equip){toast('ä¸å¯è£…å¤‡');return}const slot=it.equip;unequip(slot);GS.equips[slot]=name;GS.inventory[name]--;if(it.onEquip)it.onEquip(GS);toast('å·²è£…å¤‡ï¼š'+name);refresh();openEquips()}
function unequip(slot){const cur=GS.equips[slot];if(cur){const it=ITEMBOOK[cur];if(it?.onUnequip)it.onUnequip(GS);addItem(cur,1)}GS.equips[slot]=null}

// ====== ç‰©å“è¯¦æƒ…/ä½¿ç”¨ ======
function openItem(name){const it=ITEMBOOK[name];el('item-title').textContent=name;el('item-desc').textContent=(it?.desc||'')+`\nåº“å­˜ï¼š${GS.inventory[name]||0}`;const btn=el('item-use');btn.onclick=()=>{if(!it){toast('æœªçŸ¥ç‰©å“');return}if((GS.inventory[name]||0)<=0){toast('å·²æ— åº“å­˜');return}if(it.gender&&GS.player.gender!==it.gender){toast('æ€§åˆ«ä¸ç¬¦ï¼Œæ— æ³•ä½¿ç”¨');return}if(it.type==='weapon'||it.type==='armor'||it.type==='acc'||it.equip){equip(name);showModal('item-modal',false);return}if(it.use&&it.use(GS)){GS.inventory[name]--;toast('å·²ä½¿ç”¨ï¼š'+name);refresh()}else toast('æ— æ³•ä½¿ç”¨è¯¥ç‰©å“')};showModal('item-modal',true)}

// ====== è¢«ä¿˜è™ç”Ÿæ´» ======
function capturedLife(){const sub_locs = ['ç‰¢æˆ¿', 'æ‹·é—®å®¤', 'å¥´éš¶å¸‚åœº', 'æš—é»‘åœ°ç‰¢', 'æ·«å…½ç¬¼', 'é­åˆ‘å°', 'è€»è¾±æŸ±', 'ç¾¤å¥¸å ‚', 'å…½äº¤èˆ', 'çº¹èº«å®¤', 'æ‹å–å°', 'æ±¡ç§½æ± ', 'ç«åˆ‘æ¶', 'æ°´ç‰¢', 'é“ç¬¼', 'è¡€æ± ', 'è½®è½¬è½®', 'åˆºé’ˆåºŠ', 'çƒ™å°ç‚‰', 'å‰¥çš®é—´', 'æ–­è‚¢é˜', 'æ´»åŸ‹å‘', 'æ¯’è™«çªŸ', 'ç†”èœ¡æˆ¿', 'é’ˆåˆºå…', 'ç”µå‡»å®¤', 'å†°å†»æ´', 'ç«çƒ¤äº­', 'é…¸èš€ç›†', 'ç›æ¸æ¡¶'];GS.sub_loc = randPick(sub_locs);el('loc-pill').textContent = GS.flags.captured_loc + 'Â·' + GS.sub_loc;const guards = [{name:'ç‹±å’ç”²',gender:'ç”·',looks:'ç²—å£®å‡¶æ‚ï¼Œå¤§å±Œè‚¿èƒ€ï¼Œç›®å…‰æ·«é‚ªï¼Œèº«ä¸Šæ•£å‘è…çƒ‚è‡­å‘³ï¼Œç‰™é½¿é»„é»‘ï¼Œçš®è‚¤ç²—ç³™æ»¡æ˜¯ç–¤ç—•ã€‚'},{name:'æ‹·é—®å®˜ä¹™',gender:'ç”·',looks:'é˜´æ£®ç‹¡è¯ˆï¼Œæ‰‹æŒé­å­ï¼Œé˜³å…·ç¡¬æŒºï¼Œè„¸ä¸Šé•¿æ»¡è„“åŒ…ï¼Œçœ¼ç›è¡€çº¢ï¼ŒèˆŒå¤´ä¼¸é•¿èˆ”å”‡ã€‚'},{name:'å¥´éš¶ä¸»ä¸™',gender:'ç”·',looks:'è‚¥ç¡•è´ªå©ªï¼Œå£æ°´ç›´æµï¼Œèƒ¯ä¸‹å·¨ç‰©é¡¶èµ·ï¼Œè‚šå­ä¸Šæ²¹è…»å±‚å±‚ï¼Œèƒ¡é¡»æ²¾æ»¡æ±¡ç§½ã€‚'},{name:'å…½å¸ˆä¸',gender:'ç”·',looks:'é‡è›®ç‹‚æš´ï¼Œè‚Œè‚‰è™¬ç»“ï¼Œå¤§å±Œå¦‚å…½æ ¹ï¼Œçœ¼ç›å¦‚ç‹¼èˆ¬å‡¶å…‰ï¼Œèº«ä¸Šå…½æ¯›ä¸›ç”Ÿã€‚'},{name:'çº¹èº«å¸ˆæˆŠ',gender:'ç”·',looks:'ç‹°ç‹è¯¡å¼‚ï¼Œæ‰‹æ¡çƒ™é“ï¼Œé˜³ç‰©æ»´æ±ï¼Œè„¸ä¸Šåˆºæ»¡æ·«çº¹ï¼Œç¬‘å£°å¦‚é¬¼å“­ã€‚'},{name:'æ‹å–å®˜å·±',gender:'ç”·',looks:'æ²¹æ»‘å¥¸è¯ˆï¼ŒèˆŒå¤´é•¿å·ï¼Œå·¨å±Œç”©åŠ¨ï¼Œçœ¼ç›çœ¯æˆç¼ï¼Œèº«ä¸Šé‡‘é“¾é—ªçƒã€‚'},{name:'æ±¡ç§½é¬¼åºš',gender:'ç”·',looks:'æ¯ç˜¦å¦‚æŸ´ï¼Œçš®è‚¤æºƒçƒ‚ï¼Œå¤§å±Œè…çƒ‚åŠæˆªï¼Œæ°”æ¯å¦‚ç²ªä¾¿ï¼Œçœ¼ç›å‡¹é™·å‘ç»¿ã€‚'},{name:'ç«åˆ‘æ‰‹è¾›',gender:'ç”·',looks:'çƒ§ç¼ç‹‚çƒ­ï¼Œæ‰‹æŒç«æŠŠï¼Œé˜³å…·ç¼çƒ­çº¢è‚¿ï¼Œèº«ä¸Šçƒ§ç—•æ–‘æ–‘ï¼Œç¬‘è„¸æ‰­æ›²ã€‚'},{name:'æ°´ç‰¢ä¸»å£¬',gender:'ç”·',looks:'æ¹¿æ»‘é˜´å†·ï¼Œèº«ä½“è¦†ç›–è‹”è—“ï¼Œå¤§å±Œå¦‚æ°´è›‡æ‰­åŠ¨ï¼Œçš®è‚¤è‹ç™½çš±è¤¶ã€‚'},{name:'é“ç¬¼ç‹ç™¸',gender:'ç”·',looks:'é“è‡‚é“œèº«ï¼Œè‚Œè‚‰å¦‚é“ï¼Œå¤§å±Œå¦‚é”¤ç¡¬é‚¦ï¼Œçœ¼ç›å–·ç«ï¼Œå¼å£°éœ‡è€³ã€‚'}];const guard = randPick(guards);const events = ['åœ¨' + GS.sub_loc + 'ä¸­ï¼Œä½ è¢«' + guard.name + 'æ‹–åˆ°è§’è½ï¼Œç²—æš´æ’•å¼€ä½ çš„è–„çº±ç½—çŸ­è£™ï¼Œéœ²å‡ºé±¼ç½‘ä¸è¢œè£¹è…¿çš„è¯±äººæ›²çº¿ï¼Œä»–å¤§å±Œç›´æ…éªšç©´ï¼ŒæŠ½æ’é—´èœœæ±å››æº…ï¼Œç¾è‡€è¢«æ‰‡å¾—çº¢è‚¿ï¼Œç‰ä¹³æ‘‡æ™ƒå–·ä¹³ï¼Œä½ æµªå«æ±‚é¥¶ï¼šâ€œå¯¹ä¸èµ·ï¼Œé¥¶äº†å¥´å§ï¼â€å´å†…å¿ƒæ‚”æ¨è‡ªå·±æ·«è´±ï¼Œå •è½åŠ æ·±ï¼Œé«˜æ½®å¤±ç¦ï¼Œç²¾æ¶²æ»¡å­å®«ï¼Œæ°¸ä¹…å…½å­•ä½“è´¨è§‰é†’ã€‚','æ—¥å¤œåœ¨æ‹·é—®å®¤å—è¾±ï¼Œ' + guard.name + 'ç”¨è¡€è‚‰é­æŠ½æ‰“ä½ çš„é¦™è‡€ï¼Œç•™ä¸‹é“é“è¡€ç—•ï¼Œé˜´æˆ·è¢«å·¨å‹è •è™«å¡æ»¡ï¼Œè •åŠ¨äº§åµï¼Œä½ å“­å–Šï¼šâ€œä¸»äººï¼Œå¥´é”™äº†ï¼Œæ“æ­»æˆ‘ï¼â€å¥¶å­è¢«æé’ç´«è‚¿å¤§ï¼Œæ°¸ä¹…å¤–ç¿»æ— æ³•é—­åˆï¼Œæ•æ„Ÿåº¦æš´å¢ï¼Œæ€§ç˜¾å‘ä½œï¼Œè‡ªæ…°ä¸æ­¢ï¼Œå‘¨å›´è·¯äººè¯„è®ºï¼šâ€œè¿™å©Šå­å¥¶å­çœŸå¤§ï¼Œéªšå±„å–·æ±ã€‚â€å •è½å·…å³°ï¼Œå°–é”æ¹¿ç–£æ„ŸæŸ“ï¼Œå°ç©´è‚‰èŠ½ä¸›ç”Ÿã€‚','å¥´éš¶ä¸»ä¸™å‰æ¥' + GS.sub_loc + 'ï¼Œå¼ºè¿«ä½ è·ªèˆ”ä»–çš„è…çƒ‚å¤§å±Œï¼Œå£æ°´æ··ç²¾æ¶²å’½ä¸‹ï¼Œé˜³å…·ç‹ æ…ååº­ï¼Œæ’•è£‚å‡ºè¡€ï¼Œèœœæ±è¡€æ°´æ··æµï¼Œä½ ä¸‹è·ªç£•å¤´ï¼šâ€œå¯¹ä¸èµ·ï¼Œå¥´æ˜¯æ¯ç‹—ï¼Œè¯·çƒ™å°æˆ‘ã€‚â€ä»–æ»šçƒ«çƒ™é“æŒ‰ä¸Šå¥¶å­â€œå©Šå­â€ï¼Œç—›å«é«˜æ½®ï¼Œæš´éœ²ç‹‚è§‰é†’ï¼Œè£¸ä½“çˆ¬è¡Œï¼Œè·¯äººè½®å¥¸ï¼Œå…½äº¤ç™–å°¾äº¤ç™–æˆç˜¾ï¼Œè‡€éƒ¨é•¿ç»†å°é³ç‰‡ï¼Œéªšè‡­å‘³æ°¸ä¹…æ•£å‘ã€‚','åœ¨æ‹å–å°å…¬å¼€å±•éœ²ï¼Œä½ è¢«é“¾é”è£¸ä½“ï¼Œé±¼ç½‘åŠå¸¦å‹’ç´§å¤§è…¿ï¼Œä¹³ç¯ç”Ÿé”ˆæŒ‚ç€ï¼Œç©´ç¯æ‹‰æ‰¯é˜´è’‚è‚¿å¤§ï¼Œä¹°ä¸»æŒ‡æ¢éªšç©´ï¼Œç¾è‡€è¢«æ‹å“ï¼Œé£å¹éœ²å‡ºä¸€æˆªé¦™è‡€ï¼Œä½ å¤§å£°æ·«å«å¼•æ¥ç¾¤ç‹¼ï¼Œå…½æ ¹å¡«æ»¡å­å®«ï¼Œäº§ä¸‹è™«åµï¼Œæˆä¸ºè™«å¦»ï¼Œä¹³æˆ¿å·¨ä¹³æ”¹é€ å–·ä¹³ä¸æ­¢ï¼Œè¡ŒåŠ¨å‡ç¼“ï¼Œæ°¸ä¹…æŸä¼¤å¥¶å­é’ç´«ã€‚','æš—é»‘åœ°ç‰¢ä¸­ï¼Œæ·«å…½æ‰‘ä¸Šï¼Œå…½çˆªæŠ“ç ´ä¸è¢œï¼Œç‹ æ’å°ç©´è½®ç•ªæŠ½æ’ï¼Œä½ å“­å–Šæ±‚é¥¶ï¼Œååº­è¢«ç©å…·å¡æ»¡ï¼Œç¾è‡€è¡€è¿¹æ–‘æ–‘ï¼Œæ°¸ä¹…ä¼¤ç—•ç•™ï¼Œæ¢…æ¯’æ„ŸæŸ“å¥¶å­æ–‘ç‚¹å¯†å¸ƒï¼Œå°–é”æ¹¿ç–£å°ç©´è‚‰èŠ½ä¸›ç”Ÿï¼Œæ¶å¿ƒå¤–è§‚ï¼ŒNPCæ‹’ç»æ€§äº¤ï¼Œæ®´æ‰“èµ¶èµ°ï¼Œä½ æ‚”æ¨è‡ªæ®‹å¥¶å­è¡€æ·‹ã€‚','çº¹èº«å¸ˆæˆŠç”¨é’ˆåˆºå…ï¼Œé’ˆæ‰é˜´æˆ·èŠ±çº¹â€œéªšçŒªâ€ï¼Œæ¬²ç«ç„šèº«ï¼Œé˜´ç©´æ°¸æ¹¿ï¼Œä½ è‡ªæ…°ä¸æ­¢ï¼Œæµªå«å¼•æ¥å®ˆå«ç¾¤å¥¸ï¼Œå¤§å±Œè½®ç•ªæ’å…¥ï¼Œç²¾æ¶²æ»¡èº«ï¼Œé«˜æ½®å–·ä¹³å¤±ç¦ï¼Œå •è½æš´å¢ï¼Œè¯ç‰©æˆç˜¾æ³¨å°„æ¯’å“ï¼Œåªšè¯æ•ˆæœæ°¸å­˜ï¼Œå¥´éš¶èº«ä»½æœä»å‘½ä»¤ã€‚','ç”µå‡»å®¤ä¸­ï¼Œå®ˆå«ç”¨ç”µæ£’æ’éªšç©´ï¼Œç”µæµåˆºæ¿€é˜´è’‚å‹ƒèµ·è‚¿å¤§ï¼Œä½ ç—›å«é«˜æ½®ï¼Œå¥¶å­æ‘‡æ™ƒï¼Œå–·ä¹³å¦‚æ³‰ï¼Œæ°¸ä¹…æ€§å™¨å˜åŒ–å­å®«æ»¡ç²¾å­•å…½ï¼Œåµå·¢æ”¹é€ äº§åµä¸æ­¢ï¼Œå…½å­•ä½“è´¨è§‰é†’ï¼Œç”Ÿä¸‹æ‚ç§ã€‚','å†°å†»æ´å†·æ°”è¢­èº«ï¼Œä½ è£¸ä½“é¢¤æŠ–ï¼Œå®ˆå«ç”¨å†°é”¥æ…ååº­ï¼Œæ’•è£‚å‡ºè¡€ï¼Œèœœæ±å†»ç»“ï¼Œç¾è‡€å†»ä¼¤ç´«é»‘ï¼Œæ°¸ä¹…æŸä¼¤æ— æ³•æ„ˆåˆï¼Œæ€§è™è‡ªæ®‹æˆç˜¾ï¼Œæ±‚æ‰“æ±‚è™ã€‚','ç«çƒ¤äº­çƒ­æµªæ»šæ»šï¼Œå®ˆå«ç«æŠŠç¼çƒ§å¥¶å­ï¼Œçƒ™å°â€œæ¯ç‹—â€ï¼Œç—›å“­æµªå«ï¼Œé˜´æˆ·æ»´æ±ï¼Œé£æœˆé˜è·¯äººå›´è§‚è¯„è®ºï¼šâ€œå¥³å¸æˆéªšè‡­æ¯çŒªï¼ŒçœŸè´±ã€‚â€å •è½å·…å³°ï¼Œæš´éœ²ç‹‚è„±è¡£è‡ªæ…°ã€‚','é…¸èš€ç›†ä¸­ï¼Œé…¸æ¶²æµ‡èº«ï¼Œå°ç©´è…èš€çº¢è‚¿å¤–ç¿»ï¼Œæ°¸ä¹…æ— æ³•é—­åˆï¼Œç—›å«æ±‚é¥¶ï¼Œä¸‹è·ªç£•å¤´ï¼šâ€œä¸»äººï¼Œå¯¹ä¸èµ·ï¼Œå¥´æ˜¯å©Šå­ã€‚â€å®ˆå«ç¬‘æ“å¥¶å­ï¼Œå°„æ»¡çº¹èº«â€œæ·«å¦‡â€ã€‚','ç›æ¸æ¡¶æµ¸æ³¡ï¼Œä½ çš®è‚¤çš±ç¼©ï¼Œéªšç©´ç›æ¸ç«è¾£ï¼Œå®ˆå«é­æ‰“ç¾è‡€è¡€è‚‰æ¨¡ç³Šï¼Œæ°¸ä¹…é­ç—•ï¼Œæ‚”æ¨å†…å¿ƒï¼šâ€œæœ¬å®«æ€å¦‚æ­¤ä½œè´±ã€‚â€å´é«˜æ½®ä¸æ­¢ã€‚','è½®è½¬è½®ä¸Šï¼Œä½ è¢«ç»‘æ—‹è½¬ï¼Œå®ˆå«è½®å¥¸ï¼Œé˜³å…·æ¢æ’éªšç©´ååº­ï¼Œç²¾æ¶²æ»¡æº¢ï¼Œå­å®«ç²¾é‡1000mlï¼Œå—å­•ï¼Œå­•å…½å­å—£9æœˆäº§å‡ºã€‚','åˆºé’ˆåºŠèººï¼Œé’ˆåˆºå…¨èº«ï¼Œå¥¶å­é˜´æˆ·è¡€æµï¼Œæ°¸ä¹…é’ˆå­”å¯†å¸ƒï¼Œæ„ŸæŸ“é‡åº¦æ€§ç—…ï¼Œæ— æ³•æ¶ˆé™¤ï¼Œæ›´ä¸¥é‡æ¶å¿ƒã€‚','ç†”èœ¡æˆ¿èœ¡æ»´å¥¶å­ï¼Œçƒ«ä¼¤çº¢è‚¿ï¼Œå®ˆå«æ“èœ¡å°éªšç©´ï¼Œå •è½åŠ æ·±ï¼Œå¥´å½¹æˆç˜¾æœä»æš´åŠ›ã€‚','é’ˆåˆºå…åƒé’ˆä¸‡åˆºï¼Œé˜´è’‚ç©¿ç¯ï¼Œä¹³å¤´ç”Ÿé”ˆä¹³ç¯ï¼Œç—›é«˜æ½®ï¼Œç‰¹æ®Šæ€§æ•ˆæœç¦æ­¢ç©¿è¡£ï¼Œå‘æƒ…æ°¸å­˜ã€‚','æ´»åŸ‹å‘åŸ‹åœŸï¼Œåªéœ²å¤´ï¼Œå®ˆå«å°¿æ·‹è„¸ï¼Œç²¾å°„å£ï¼Œåå’½ä¸æ­¢ï¼Œæ‚”æ¨å“­å–Šï¼šâ€œå¥´é”™äº†ï¼Œé¥¶å‘½ã€‚â€','æ¯’è™«çªŸè™«çˆ¬èº«ï¼Œå’¬éªšç©´äº§åµï¼Œè™«å¦»èº«ä»½ï¼Œå¥¶å­é•¿æ»¡åµå›Šï¼Œå–·ä¹³å–‚è™«ã€‚','æ–­è‚¢é˜è¢«ç»‘ï¼Œå®ˆå«ç æŒ‡ï¼Œè¡€å–·ï¼Œç—›å«æ±‚é¥¶ï¼Œæ€§æš´åŠ›æˆç˜¾ï¼Œè‡ªæ®‹å¥¶å­åˆ’åˆ€è¡€æ·‹ã€‚','å‰¥çš®é—´çš®è‚¤å‰¥ç¦»ï¼Œéœ²è‚‰è¡€æ·‹ï¼Œå®ˆå«æ“ä¼¤å£ï¼Œæ±æ¶²è¡€æ¶²æ··ï¼Œæ°¸ä¹…å‰¥çš®æŸä¼¤æ¶å¿ƒå¤–è§‚ã€‚','è¡€æ± æµ¸æ³¡ï¼Œè¡€å…¥éªšç©´ï¼ŒæŸ“çº¢å­å®«ï¼Œæ„ŸæŸ“æ¢…æ¯’é‡åº¦ï¼Œå¥¶å­æ–‘ç‚¹ï¼Œå°ç©´è‚‰èŠ½ï¼Œè‡€é³ç‰‡ï¼ŒNPCæ‹’ç»ï¼Œæ®´æ‰“èµ¶èµ°ã€‚'];say(randPick(events) + ' ' + guard.looks);GS.player.lust+=20;GS.player.degen+=10;GS.player.hp-=5;GS.player.sex_exp+=1;if(RNG.roll(0.1))tryConceive();refresh();const branchChance = RNG.next();if(branchChance < 0.3 && GS.player.charm < 40){say('é­…åŠ›ä¸è¶³ï¼Œä½ è¢«å®ˆå«æ®´æ‰“ï¼Œç¾è‡€æ‰‡è‚¿ï¼Œå¥¶å­æé’ï¼Œè¡€è¿¹æ–‘æ–‘ï¼Œhp-10ã€‚');GS.player.hp-=10;}else if(branchChance < 0.6 && GS.player.charm > 60){say('é­…åŠ›é«˜ï¼Œä½ è¢«æ‹å–ï¼Œä¹°ä¸»å¤§å±Œæ’å…¥ï¼Œè½®ç•ªæ“ç©´ï¼Œå •è½+15ã€‚');GS.player.degen+=15;GS.player.partners+=rndInt(2,5);}else if(GS.day % 3 === 0 && GS.player.degen > 50){say('å •è½åˆ°ç¬¬ä¸‰å¤©ï¼Œä½ è¢«è°ƒæ•™ç©¿ç¯ï¼Œä¹³ç¯ç©´ç¯æ‹‰æ‰¯ï¼Œç—›é«˜æ½®ï¼Œæ•æ„Ÿ+5ã€‚');GS.player.sensitivity+=5;GS.statuses.push('ä¹³ç¯ç©´ç¯');}else if(GS.day % 5 === 0){say('ç¬¬äº”å¤©ï¼Œä½ è¢«æ‰”å…¥å…½äº¤èˆï¼Œç§é©¬å…½æ ¹å¡«æ»¡éªšç©´ï¼Œç”Ÿä¸‹æ‚ç§ï¼Œå…½å­•ä½“è´¨æ°¸ä¹…ã€‚');GS.player.pregnancy.pregnant=true;GS.statuses.push('å…½å­•ä½“è´¨');}else{say('éšæœºæ”¯çº¿ï¼šå®ˆå«è¦æ±‚ç­¾å¥‘çº¦ï¼Œä½ æ±‚é¥¶è¡¥å¿æ“ç©´ï¼Œä»–åŒæ„ï¼Œä½†æ³¨å°„æ¯’å“ï¼Œæˆç˜¾æ°¸å­˜ã€‚');GS.statuses.push('è¯ç‰©æˆç˜¾');}setChoices([{id:601,text:'å¿å—ç»§ç»­å—è¾±'},{id:602,text:'å°è¯•æ±‚é¥¶è¡¥å¿'},{id:603,text:'åæŠ—æˆ˜æ–—ï¼ˆatk>15ï¼‰'},{id:604,text:'è‡ªæ®‹å¸å¼•æ³¨æ„ï¼ˆdegen>70ï¼‰'}]);}
// ========== æ–°å¢ï¼šåœ°åŒºè§£æå·¥å…· + äººç‰©è¿‡æ»¤ï¼ˆåªæ˜¾ç¤ºæœ¬åœ°åŒºï¼‰ ==========
function regionOf(s){ return (s||'').split('Â·')[0]; }
function npcsAtCurrent(){ const r = regionOf(GS.loc); return GS.relations.filter(p => regionOf(p.loc) === r); }

// æ›¿æ¢ä½ çš„äººç‰©åˆ—è¡¨æ¸²æŸ“ï¼šå¦‚æœä½ ä¸æƒ³åŠ¨åŸå‡½æ•°ï¼Œå¯ä»¥åªåœ¨æ‰“å¼€å±æ€§é¢æ¿æ—¶è°ƒç”¨è¿‡æ»¤ï¼›
// æ¨èï¼šæŠŠä½ åŸæ¥çš„ updatePeople() æ›¿æ¢ä¸ºä¸‹æ–¹è¿™ä¸ªâ€œåŒåå‡½æ•°â€ã€‚
// â€”â€”å¦‚æœä½ ä¸æƒ³æ›¿æ¢æ•´å‡½æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨ä½ åŸå‡½æ•°é‡ŒæŠŠ GS.relations æ”¹ä¸º npcsAtCurrent()ã€‚
window.updatePeople = function(){
  const box = document.getElementById('people-list');
  if(!box) return;
  box.innerHTML = '';
  const list = npcsAtCurrent();   // â˜…å…³é”®ï¼šåªæ‹¿â€œå½“å‰åœ°åŒºâ€çš„ NPC
  if(list.length === 0){
    const empty = document.createElement('div');
    empty.className = 'item';
    empty.textContent = 'æ­¤åœ°æš‚æ— å¯äº’åŠ¨äººç‰©';
    box.append(empty);
    return;
  }
  list.forEach(p => {
    const row = document.createElement('div');
    row.className = 'item';
    row.style.cursor = 'pointer';
    row.innerHTML = `<span>${p.name}ï¼ˆ${p.gender}/${p.age}ï¼‰Â·å¥½æ„Ÿ ${p.favor}ï½œä¿¡ä»» ${p.trust}</span><span class="pill">${p.loc}</span>`;
    row.onclick = () => openDialogue(p);
    box.append(row);
  });
};

// ========== æ–°å¢ï¼šå±æ€§é¢æ¿ ==========
function renderAttrModal(){
  const p = GS.player;
  // ä¸€äº›ä¾¿æ·æ–‡æœ¬
  const spouse = p.married && p.spouse ? `${p.spouse.name}ï¼ˆ${p.spouse.gender}/${p.spouse.age}ï¼‰` : 'æ— ';
  const children = (p.children||[]).length;
  const statuses = (GS.statuses||[]).join('ã€') || 'æ— ';
  const techs = (GS.techniques||[]).join('ã€') || 'æ— ';
  const traits = [...new Set([...(GS.traits||[]), ...(p.traits||[])])].join('ã€') || 'æ— ';
  const equips = {
    weapon: GS.equips?.weapon || 'æ— ',
    armor: GS.equips?.armor || 'æ— ',
    acc: GS.equips?.acc || 'æ— '
  };
  const linesA = [
    ['å§“å', p.name],
    ['å¢ƒç•Œ', p.realm],
    ['ç­‰çº§', `Lv.${p.level}ï¼ˆ${p.exp}/${p.exp_to_next}ï¼‰`],
    ['ç”Ÿå‘½', `${p.hp}/${p.hp_max}`],
    ['çµåŠ›', `${p.qi}/${p.qi_max}`],
    ['é­…åŠ›', p.charm],
    ['æ¬²å€¼', `${p.lust}/100`],
    ['æ•æ„Ÿåº¦', p.sensitivity],
  ];
  const linesB = [
    ['å •è½åº¦', `${p.degen}%`],
    ['ä¼´ä¾£æ•°', p.partners||0],
    ['å­å—£æ•°é‡', children],
    ['å©šå§»', p.married ? 'å·²å©š' : 'æœªå©š'],
    ['é“ä¾£/é…å¶', spouse],
    ['é—¨æ´¾/å‡ºèº«', GS.player.faction || 'æ•£ä¿®'],
    ['å¿ƒæƒ…', p.mood || 'â€”'],
    ['åœ°ç‚¹', GS.loc + (GS.sub_loc ? 'Â·' + GS.sub_loc : '')],
  ];
  const equipsBlock = [
    ['ä¸»æ­¦å™¨', equips.weapon],
    ['æŠ¤ç”²', equips.armor],
    ['é¥°å“', equips.acc],
  ];
  const wrap = (arr) => arr.map(([k,v]) => `<div class="item"><span>${k}</span><span class="pill">${v}</span></div>`).join('');
  const html = `
    <div>
      <div class="list">${wrap(linesA)}</div>
      <div class="list" style="margin-top:10px"><div class="item"><span>åŠŸæ³•</span><span class="pill" style="max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${techs}</span></div></div>
      <div class="list" style="margin-top:10px"><div class="item"><span>ç‰¹è´¨</span><span class="pill" style="max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${traits}</span></div></div>
    </div>
    <div>
      <div class="list">${wrap(linesB)}</div>
      <div class="list" style="margin-top:10px">${wrap(equipsBlock)}</div>
      <div class="list" style="margin-top:10px"><div class="item"><span>çŠ¶æ€</span><span class="pill" style="max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${statuses}</span></div></div>
    </div>
  `;
  const box = document.getElementById('attr-content');
  if(box) box.innerHTML = html;
}

// æ‰“å¼€/å…³é—­
(function bindAttrPanel(){
  const btn = document.getElementById('btn-attrs');
  if(btn){
    btn.addEventListener('click', () => {
      // æ‰“å¼€å‰å…ˆåˆ·æ–°ä¸€æ¬¡æ•°æ®ï¼ˆæ•°å€¼å¯èƒ½åœ¨ä½ å…¶å®ƒæ“ä½œåå˜åŒ–ï¼‰
      renderAttrModal();
      // ä¾èµ–ä½ å·²æœ‰çš„ showModal(id, boolean)ï¼›å¦‚æ— ï¼Œå¯æ”¹ç”¨ classList åˆ‡æ¢
      if (typeof showModal === 'function') showModal('attr-modal', true);
      else document.getElementById('attr-modal').classList.add('show');
    });
  }
  const closeBtn = document.getElementById('attr-close');
  if(closeBtn){
    closeBtn.addEventListener('click', () => {
      if (typeof showModal === 'function') showModal('attr-modal', false);
      else document.getElementById('attr-modal').classList.remove('show');
    });
  }
})();

// æ¶©æ¶©å†…å®¹
// æ¬²æœ›å˜åŒ–å¤„ç†
function changeLust(amount) {
  const p = GS.player;
  // åº”ç”¨æ¬²æœ›è·å¾—å€ç‡å’ŒæŠ—æ€§
  const actualAmount = amount * p.lustGainRate * (1 - p.lustResist);
  p.lust = Math.max(0, Math.min(p.lustMax, p.lust + actualAmount));
  
  // æ£€æŸ¥æ¬²æœ›çˆ†å‘
  checkLustStatus();
  
  // åŒæ­¥UIæ›´æ–°
  refresh();
}

// æ¬²æœ›çŠ¶æ€æ£€æŸ¥ 
function checkLustStatus() {
  const p = GS.player;
  
  // æ¬²æœ›çˆ†å‘æ£€æŸ¥
  if(p.lust >= p.lustMax * 0.8 && !p.isLustful) {
    p.isLustful = true;
    triggerLustEvent();
  }
  
  // ä½æ¬²æœ›æ¢å¤
  if(p.lust < p.lustMax * 0.3) {
    p.isLustful = false; 
  }
}

// æ¬²æœ›äº‹ä»¶è§¦å‘
function triggerLustEvent() {
  const events = [
    'æ¬²ç«ç„šèº«,ä½ æƒ…ä¸è‡ªç¦åœ°åœ¨è¡—å¤´æŠšæ‘¸è‡ªå·±,éªšç©´æ¹¿æ¶¦,èœœæ±æ¨ªæµã€‚',
    'æ¬²æœ›çˆ†å‘,ä½ ç–¯ç‹‚æ¸´æœ›è¢«è·¯äººä¾µçŠ¯,é¦™è‡€æ‘‡æ›³,é˜´æˆ·ç¿•å¼ ã€‚', 
    'æ·«æ¬²ä¸Šè„‘,ä½ ä¸»åŠ¨å‹¾å¼•ç”·è·¯äºº,ç‰ä¹³é¢¤åŠ¨,å°ç©´å¼ åˆã€‚',
    'æ¬²æœ›å†²é¡¶,ä½ å¿ä¸ä½åœ¨å…¬å…±åœºæ‰€è‡ªæ…°,ç¾è‡€æ‰­åŠ¨,æ·«æ¶²å–·æº…ã€‚'
  ];
  say(randPick(events));
  
  // æ¬²æœ›çˆ†å‘æ•ˆæœ
  GS.player.sensitivity += 1;
  GS.player.degen += 5;
}

// å •è½å˜åŒ–å¤„ç†
function changeDegen(amount) {
  const p = GS.player;
  // åº”ç”¨å •è½è·å¾—å€ç‡å’ŒæŠ—æ€§
  const actualAmount = amount * p.degenGainRate * (1 - p.degenResist);
  p.degen = Math.max(0, Math.min(p.degenMax, p.degen + actualAmount));
  
  // æ£€æŸ¥å •è½é˜¶æ®µ
  checkDegenStage();
  
  // åŒæ­¥UIæ›´æ–°
  refresh();
}

// å •è½é˜¶æ®µæ£€æŸ¥
function checkDegenStage() {
  const p = GS.player;
  const stages = [
    {
      level: 20,
      name: 'åˆå •',
      effect: () => {
        say('ä½ å¼€å§‹å •è½,å¯¹æ·«æ¬²äº§ç”Ÿå‘å¾€,éªšç©´ç»å¸¸æ¹¿æ¶¦ã€‚');
        p.lustGainRate *= 1.2;
      }
    },
    {
      level: 40, 
      name: 'æ·±å •',
      effect: () => {
        say('å •è½åŠ æ·±,ä½ å¼€å§‹ä¸»åŠ¨å¯»æ±‚å¿«æ„Ÿ,é¦™è‡€ä¸è‡ªè§‰æ‰­åŠ¨ã€‚');
        p.sensitivity += 2;
      }
    },
    {
      level: 60,
      name: 'é‡å •', 
      effect: () => {
        say('å •è½ä¸¥é‡,ä½ å½»åº•æ²¦ä¸ºæ·«é­”,é˜´æˆ·æ°¸è¿œæ½®æ¹¿,ç‰ä½“æ•£å‘é­…æƒ‘ã€‚');
        p.lustMax *= 1.5;
        addStatus('æ°¸ä¹…æ·«çº¹');
      }
    },
    {
      level: 80,
      name: 'æå •',
      effect: () => {
        say('å •è½åˆ°æè‡´,ä½ å®Œå…¨å˜æˆæ€§å¥´,éªšç©´éšæ—¶å‡†å¤‡å¥½è¢«ä¾µçŠ¯ã€‚');
        p.degenGainRate *= 2;
        addStatus('æåº¦æ·«ä¹±');
      }
    }
  ];
  
  // æ£€æŸ¥æœªè§¦å‘çš„é˜¶æ®µ
  stages.forEach(stage => {
    if(p.degen >= stage.level && !p.degenStages.includes(stage.name)) {
      p.degenStages.push(stage.name);
      stage.effect();
    }
  });
  
  // æ£€æŸ¥å •è½çˆ†å‘
  if(p.degen >= p.degenMax * 0.9 && !p.isCorrupted) {
    p.isCorrupted = true;
    triggerDegenEvent();
  }
}

// å •è½äº‹ä»¶è§¦å‘
function triggerDegenEvent() {
  const events = [
    'å •è½çˆ†å‘,ä½ è·ªåœ¨è¡—å¤´ä¹æ±‚è·¯äººæ“å¼„,é¦™èˆŒä¼¸å‡º,æ·«æ°´æ¨ªæµã€‚',
    'å •è½å¤±æ§,ä½ ä¸»åŠ¨è„±å…‰è¡£ç‰©ä»»äººè½®å¥¸,ç¾è‡€é«˜ç¿˜,éªšç©´å¼ å¼€ã€‚',
    'å •è½è§‰é†’,ä½ åœ¨æ·«çªŸä¸­è¢«ç¾¤å…½ä¾µçŠ¯,ç‰ä½“æ‰­åŠ¨,å­å®«çŒæ»¡ã€‚',  
    'å •è½å·…å³°,ä½ æ²¦ä¸ºå¦“é™¢æ€§å¥´,å¤§å±Œè½®æ’,ç²¾æ¶²æµ‡çŒã€‚'
  ];
  say(randPick(events));
  
  // å •è½çˆ†å‘æ•ˆæœ
  GS.player.sensitivity += 3;
  GS.player.lust = GS.player.lustMax;
  addStatus('å •è½çƒ™å°');
}

// æ·»åŠ çŠ¶æ€
function addStatus(status) {
  if(!GS.player.statuses.includes(status)) {
    GS.player.statuses.push(status);
  }
}

// æ—¶é—´æµé€æ—¶æ£€æŸ¥
function timePassCheck() {
  const p = GS.player;
  
  // æ¬²æœ›è‡ªç„¶å¢é•¿
  if(p.sensitivity > 0) {
    changeLust(p.sensitivity * 0.5);
  }
  
  // å •è½è”“å»¶
  if(p.degen > 50) {
    changeDegen(p.degen * 0.01);
  }
  
  // ç‰¹æ®ŠçŠ¶æ€æ•ˆæœ
  if(p.statuses.includes('æ°¸ä¹…æ·«çº¹')) {
    changeLust(5);
  }
  if(p.statuses.includes('å •è½çƒ™å°')) {
    changeDegen(2);
  }
  
  // è£…å¤‡æ•ˆæœ
  Object.values(GS.equips).forEach(item => {
    const itemData = ITEMBOOK[item];
    if(itemData?.effects) {
      itemData.effects.forEach(effect => {
        if(effect.includes('æ¬²æœ›')) changeLust(3);
        if(effect.includes('å •è½')) changeDegen(2);
      });
    }
  });
}

// ====== UI æ§åˆ¶ ======
function showModal(id,on=true){el(id).classList.toggle('show',!!on)}
Array.from(document.querySelectorAll('.tab-btn')).forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('.tab-page').forEach(p=>p.classList.remove('active'));el('tab-'+btn.dataset.tab).classList.add('active')}))
window.addEventListener('keydown',e=>{if(e.repeat)return;const n=parseInt(e.key,10);if(n>=1&&n<=9){const btn=choices.children[n-1];if(btn)btn.click()}if(e.key==='~'){openDebug();}})
el('btn-worldmap').onclick=()=>{renderWorld();showModal('worldmap',true)}
el('wm-close').onclick=()=>showModal('worldmap',false)
//el('btn-skills').onclick=()=>{say('å½“å‰æŠ€èƒ½ï¼š'+GS.player.skills.map(s=>s.name).join('ã€'))}
el('btn-shops').onclick=openShops
//el('btn-equips').onclick=openEquips
el('equip-close').onclick=()=>showModal('equip-modal',false)
el('dlg-close').onclick=()=>showModal('dialogue',false)
el('item-close').onclick=()=>showModal('item-modal',false)
el('btn-next-hour').onclick=()=>tickTime(1)
el('btn-next-day').onclick=()=>tickTime(12)
el('lust-close').onclick=()=>showModal('lust-modal',false)

el('debug-close').onclick=()=>showModal('debug-modal',false)
el('nc-close').onclick = () => showModal('newchar', false);
el('nc-ok').onclick = () => {
  const name   = (el('nc-name').value||'').trim() || 'è‹å¤œé›¨';
  const gender = el('nc-gender').value;
  const orient = el('nc-orient').value;
  const age    = Math.max(18, parseInt(el('nc-age').value || '18', 10)); // #è®°å¾—ä¿®æ”¹å’Œè°ï¼šå¼ºåˆ¶18+
  const origin = el('nc-origin').value;
  const marriage = el('nc-marriage').value;
  const charm  = parseInt(el('nc-charm').value || '50', 10);
  const lust   = parseInt(el('nc-lust').value || '20', 10);
  const degen  = parseInt(el('nc-degen').value || '0', 10);
  Object.assign(GS.player,{ name, gender, orient, age, faction:origin, married:marriage==='å·²å©š', charm, lust, degen });
  showModal('newchar', false);
  refresh();
};
// el('btn-lust').onclick = () => {
  //updateLust();
  //showModal('lust-modal', true);
//};
document.querySelector('[data-tab="lust"]').addEventListener('click', updateLust);

// å­˜æ¡£
const KEY='xiuxian-slot-';const slot=()=>KEY+el('slot').value;function save(){localStorage.setItem(slot(),JSON.stringify({RNG:{seed:RNG.seed},Calendar,GS}))}function load(){const raw=localStorage.getItem(slot());if(!raw){toast('è¯¥æ§½ä½æš‚æ— å­˜æ¡£');return}const d=JSON.parse(raw);if(d.RNG)RNG.seed=d.RNG.seed;if(d.Calendar)Object.assign(Calendar,d.Calendar);if(d.GS)Object.assign(GS,d.GS);refresh();say('è¯»å–å®Œæˆ')}el('btn-save').onclick=()=>{save();toast('å·²ä¿å­˜åˆ°æ§½ä½ '+el('slot').value)};el('btn-load').onclick=load;el('btn-export').onclick=()=>{const blob=new Blob([JSON.stringify({RNG:{seed:RNG.seed},Calendar,GS},null,2)],{type:'application/json'});const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download=`save-slot-${el('slot').value}.json`;a.click();URL.revokeObjectURL(u)};el('file-import').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const d=JSON.parse(r.result);if(d.RNG)RNG.seed=d.RNG.seed;if(d.Calendar)Object.assign(Calendar,d.Calendar);if(d.GS)Object.assign(GS,d.GS);refresh();say('å¯¼å…¥å®Œæˆ')}catch{toast('å¯¼å…¥å¤±è´¥')}};r.readAsText(f);e.target.value=''});

// è§’è‰²åˆ›å»º
el('nc-close').onclick=()=>{showModal('newchar',false)}
el('nc-ok').onclick=()=>{const name=el('nc-name').value.trim()||'è‹å¤œé›¨';const gender=el('nc-gender').value;const orient=el('nc-orient').value;const age=Math.max(14,parseInt(el('nc-age').value||'14',10));const origin=el('nc-origin').value;const marriage=el('nc-marriage').value;const fertile=el('nc-fertile').value;const charm=parseInt(el('nc-charm').value||'50',10);const lust=parseInt(el('nc-lust').value||'20',10);const degen=parseInt(el('nc-degen').value||'0',10);Object.assign(GS.player,{name,gender,orient,age,faction:origin,married:marriage==='å·²å©š',fertile,charm,lust,degen});if(GS.player.married){GS.player.spouse={id:'sp_'+Math.floor(RNG.next()*1e6),name:randomName(),gender:RNG.roll(.5)?'ç”·':'å¥³',age:rndInt(14,30),favor:60};GS.player.partners+=1}if(gender==='å¥³')GS.player.traits.push('å¤©ç”Ÿåªšéª¨');setupRepro();showModal('newchar',false);bootGame()}

// ====== å¯åŠ¨ ======
function updateDate(){el('date-pill').textContent='å…ƒ'+Calendar.toText()}
function renderWorld(){const g=el('wm-grid');g.innerHTML='';GS.map.forEach(loc=>{const c=document.createElement('div');c.className='map-cell'+(loc===GS.loc?' current':'');c.textContent=loc;c.onclick=()=>{goTo(loc);showModal('worldmap',false)};g.append(c)})}
function bootGame(){weather.roll();updateDate();refresh();say('<b>æ¸…é£é•‡Â·å®¢æ ˆ</b>');say('ä½ åœ¨æœ¨åºŠä¸Šé†’æ¥ï¼Œçª—å¤–æ™¨é›¾æœªæ•£ï¼Œå¥³å­åœ°ä½ä½ä¸‹ï¼Œä½ è‹¥å •è½ï¼Œæé­æ— æ•°ä¾µçŠ¯ã€‚');setChoices([{id:0,text:'ï¼ˆåº•éƒ¨æŒ‰é’®æä¾›ä¸»è¦è¡ŒåŠ¨ï¼Œä¸»çº¿æç¤ºï¼šå‰å¾€ç‰è¡¡å®—å…¥é—¨ï¼‰'}]);ensureSect()}
function render(){refresh()}

// å¼€å±€ï¼šæ˜¾ç¤ºè§’è‰²åˆ›å»º
refresh();
</script>
</body>
</html>